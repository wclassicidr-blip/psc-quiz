<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quiz</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#eef7ef; --card:#ffffff; --ink:#13341f; --muted:#597963;
    --accent:#2e7d32; --accent-2:#1b5e20; --border:rgba(25,84,45,.12);
    --shadow:0 6px 20px rgba(25,84,45,.12); --radius:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:14px 20px;background:linear-gradient(#e8f6e9,#ecf7ee);position:sticky;top:0;z-index:5;border-bottom:1px solid var(--border)}
  .brand{display:flex;gap:.6rem;align-items:center;font-weight:800}
  .badge{background:#1b5e20;border-radius:12px;color:#fff;padding:6px 9px;font-size:12px}
  .crumbs a{appearance:none;border:1px solid var(--border);background:#fff;padding:.45rem .9rem;border-radius:999px;color:var(--ink);text-decoration:none}
  main{max-width:980px;margin:28px auto;padding:0 18px 110px}
  h1{margin:0 0 6px;font-size:28px;letter-spacing:.2px}
  .muted{color:var(--muted)}
  .note{background:#fff4e5;border:1px solid #ffd39c;color:#7a4b00;padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);margin:14px 0 20px}
  .list{display:grid;gap:14px}
  .qa{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .q{padding:16px 18px;font-weight:600;border-bottom:1px solid var(--border);background:#f6fbf7}
  .a{padding:16px 18px;display:none}
  .qa.open .a{display:block}
  .tools{display:flex;gap:8px;padding:12px}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;color:var(--ink);padding:.55rem .9rem;border-radius:10px;cursor:pointer}
  .btn.accent{background:var(--accent);color:#fff;border-color:transparent}
  .btn.ghost{background:#fff;border-color:var(--border)}
  .btn.small{padding:.4rem .7rem;font-size:.9rem}
  .sticky{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);backdrop-filter:blur(5px);border-top:1px solid var(--border);padding:12px 16px;display:flex;justify-content:space-between;align-items:center;z-index:9}
  .timer{font-weight:800;color:var(--accent-2)}
  .opt{display:block;margin:10px 0;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
  .opt input{margin-right:8px}
  .opt.correct{border-color:#2e7d32;background:#e9f6ea}
  .opt.wrong{border-color:#c62828;background:#fdeaea}
  .grid{display:grid;gap:14px}
  .summary-card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
  .center{display:flex;justify-content:center;margin-top:18px}
</style>
</head>
<body>
<header>
  <div class="brand">
    <span class="badge">PSC</span>
    <div>
      <div style="font-weight:800">PSC Guru</div>
      <div class="muted" style="font-size:12px;margin-top:-4px">Kerala PSC Exam Prep</div>
    </div>
  </div>
  <div class="crumbs">
    <a href="index.html">Home</a>
    <a href="quiz.html">Quiz</a>
  </div>
</header>

<main>
  <h1 id="title">Quiz</h1>
  <div id="kicker" class="muted" style="margin-bottom:10px">Answers only</div>
  <div id="warn" class="note" style="display:none"></div>

  <!-- List mode -->
  <div id="listWrap" class="list" style="display:none"></div>

  <!-- MCQ mode -->
  <div id="mcqWrap" style="display:none">
    <div id="mcqCard" class="qa">
      <div id="mcqQ" class="q">Question</div>
      <div class="a" style="display:block">
        <div id="mcqOpts" class="grid"></div>
      </div>
    </div>
    <div class="center muted" id="mcqProgress" style="margin-bottom:70px">1/1</div>
  </div>

  <!-- Summary -->
  <div id="summary" style="display:none">
    <div class="summary-card">
      <h2 style="margin:0 0 6px">Summary</h2>
      <div id="sumLine" class="muted"></div>
    </div>
    <div id="sumList" class="list" style="margin-top:14px"></div>
  </div>
</main>

<div id="bar" class="sticky" style="display:none">
  <div class="muted"><span id="timer" class="timer"></span></div>
  <div style="display:flex;gap:8px">
    <button class="btn ghost small" id="prevBtn">← Prev</button>
    <button class="btn small" id="revealBtn">Show Answer</button>
    <button class="btn accent small" id="nextBtn">Next →</button>
  </div>
</div>

<script>
/* ======== CONFIG ======== */
const GS_SHEET_ID = "16iIOLKAkFzXD1ja7v6b7_ZUKVjbcsswX8LfJ_D0S57o";

/* ======== helpers ======== */
const qs = (s, el=document) => el.querySelector(s);
const qsa = (s, el=document) => [...el.querySelectorAll(s)];
const shuffle = (a)=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a;};
const norm = s => (s??'').toString().normalize('NFKC').replace(/\u00A0/g,' ').trim().toLowerCase();
const slug = s => norm(s).replace(/[^\p{L}\p{N}]+/gu,'');

async function fetchText(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.text(); }

async function getGidByName(sheetId, name){
  if(!name) return null;
  const want = slug(name);
  const html = await fetchText(`https://docs.google.com/spreadsheets/d/${sheetId}/pubhtml`);
  const re   = /<a[^>]+href="[^"]*#gid=(\d+)"[^>]*>([\s\S]*?)<\/a>/gi;
  let m; let fallback=null;
  while((m=re.exec(html))){
    const gid = m[1];
    const label = m[2].replace(/<[^>]*>/g,'').replace(/&nbsp;/g,' ').replace(/&amp;/g,'&').trim();
    if(slug(label)===want) return gid;
    if(!fallback && norm(label)===norm(name)) fallback=gid;
  }
  return fallback;
}

// CSV parser (robust)
function parseCSV(text){
  const rows=[]; let i=0, field='', row=[], inQ=false;
  const pushField=()=>{row.push(field);field='';};
  const pushRow=()=>{rows.push(row);row=[];};
  while(i<text.length){
    const c=text[i];
    if(inQ){
      if(c=='"'&&text[i+1]=='"'){field+='"';i+=2;continue;}
      if(c=='"'){inQ=false;i++;continue;}
      field+=c;i++;continue;
    }else{
      if(c=='"'){inQ=true;i++;continue;}
      if(c==','){pushField();i++;continue;}
      if(c=='\r'){i++;continue;}
      if(c=='\n'){pushField();pushRow();i++;continue;}
      field+=c;i++;continue;
    }
  }
  pushField(); pushRow();
  // trim trailing empty rows
  while(rows.length && rows[rows.length-1].every(c=>norm(c)==='')) rows.pop();
  return rows;
}

async function fetchCSVByGid(sheetId, gid){
  const txt = await fetchText(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${gid}`);
  return parseCSV(txt);
}

// fuzzy column finder
function findCol(header, patterns){
  const idx = header.findIndex(h => patterns.some(p => norm(h).includes(norm(p))));
  return idx >= 0 ? idx : -1;
}

// convert rows to items using tolerant header detection
function rowsToItems(rows){
  if(!rows || rows.length<2) return {items:[], header:[]};
  const header = rows[0].map(h=>h??'');
  const hNorm  = header.map(h=>norm(h));

  // likely columns (English + Malayalam)
  let idIdx = findCol(hNorm, ['id']);
  let qIdx  = findCol(hNorm, ['question','ques','q','ചോദ്യം','ചോദ്യ']);
  let aIdx  = findCol(hNorm, ['answer','ans','a','ഉത്തരം','ഉത്തര']);
  let oa    = findCol(hNorm, ['opta','option a','choice a','a)']);
  let ob    = findCol(hNorm, ['optb','option b','choice b','b)']);
  let oc    = findCol(hNorm, ['optc','option c','choice c','c)']);
  let od    = findCol(hNorm, ['optd','option d','choice d','d)']);
  let corr  = findCol(hNorm, ['correct','key','answer key','answerkey']);

  const items=[];
  for(let r=1;r<rows.length;r++){
    const row = rows[r];

    // Fallback: if no q/a headers, try best-guess two columns (skip a numeric id in first col)
    let q = qIdx>=0 ? row[qIdx] : '';
    let a = aIdx>=0 ? row[aIdx] : '';

    if(qIdx<0 || aIdx<0){
      // find first 2 non-empty cells (skipping a numeric ID in col 0)
      const cleaned = row.map(x=> (x??'').toString());
      let start=0;
      if(idIdx<0 && cleaned[0] && /^\s*\d+\s*$/.test(cleaned[0])) start=1;
      const nonEmpty = cleaned.map((v,i)=>({i,v})).filter(x=>norm(x.v)!='' && x.i>=start);
      if(nonEmpty.length>=2){
        if(qIdx<0) q=nonEmpty[0].v;
        if(aIdx<0) a=nonEmpty[1].v;
      }
    }

    const optA = oa>=0 ? row[oa] : '';
    const optB = ob>=0 ? row[ob] : '';
    const optC = oc>=0 ? row[oc] : '';
    const optD = od>=0 ? row[od] : '';
    const correct = corr>=0 ? (row[corr]??'').toString().trim() : '';

    const opts = [optA,optB,optC,optD].filter(v => norm(v)!='');

    // derive correct if missing but answer matches one of options
    let correctKey = correct;
    if(!correctKey && opts.length){
      const ix = opts.findIndex(o => norm(o)===norm(a));
      if(ix>=0) correctKey = ['A','B','C','D'][ix];
    }

    if(norm(q)!=''){
      items.push({
        id: (idIdx>=0? (rows[r][idIdx]??'') : r).toString(),
        q: q??'',
        a: a??'',
        opts: opts.length? opts : null,
        correct: correctKey || ''
      });
    }
  }
  return {items, header};
}

/* ========= List Mode ========= */
function buildList(items){
  const wrap = qs('#listWrap'); wrap.innerHTML='';
  items.forEach((it,i)=>{
    const card = document.createElement('div');
    card.className='qa';
    card.innerHTML = `
      <div class="q">${i+1}. ${it.q}</div>
      <div class="a"><div>${it.a || '<em class="muted">No answer</em>'}</div></div>
      <div class="tools"><button class="btn small">Show Answer</button></div>
    `;
    qs('.btn',card).onclick = ()=> card.classList.toggle('open');
    wrap.appendChild(card);
  });
}

/* ========= MCQ Mode ========= */
let mcq = {items:[], i:0, answered:[], timer:null, remain:0};
function setTimer(sec){ const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); qs('#timer').textContent=`${m}:${s}`; }
function startTimer(total, end){ if(!total){qs('#timer').textContent='';return;} mcq.remain=total; setTimer(total); mcq.timer=setInterval(()=>{ mcq.remain--; setTimer(mcq.remain); if(mcq.remain<=0){ clearInterval(mcq.timer); end?.(); }},1000); }
function showQ(){
  const it = mcq.items[mcq.i];
  qs('#mcqQ').innerHTML = `${mcq.i+1}. ${it.q}`;
  const host = qs('#mcqOpts'); host.innerHTML='';
  const labeled = (it.opts||[]).map((t,i)=>({text:t,key:['A','B','C','D'][i],isCorrect: (['A','B','C','D'][i]===it.correct)|| (norm(t)===norm(it.a))}));
  shuffle(labeled);
  labeled.forEach((op,ix)=>{
    const id=`o_${mcq.i}_${ix}`;
    const el=document.createElement('label'); el.className='opt'; el.dataset.correct=op.isCorrect?'1':'0';
    el.innerHTML=`<input type="radio" name="q${mcq.i}" id="${id}" value="${ix}"> ${op.text}`;
    host.appendChild(el);
  });
  qs('#mcqProgress').textContent = `${mcq.i+1}/${mcq.items.length}`;
  qs('#revealBtn').textContent = 'Show Answer';
}
function lockQ(){
  qsa('.opt',qs('#mcqCard')).forEach(el=>{
    el.querySelector('input').disabled=true;
    if(el.dataset.correct==='1') el.classList.add('correct');
    if(el.querySelector('input').checked && el.dataset.correct!=='1') el.classList.add('wrong');
  });
}
function record(){
  const it=mcq.items[mcq.i];
  const chk=qs('input[type=radio]:checked',qs('#mcqCard'));
  const chosen = chk ? chk.closest('.opt').textContent.trim() : null;
  const correct = chk ? (chk.closest('.opt').dataset.correct==='1') : false;
  mcq.answered[mcq.i] = { q:it.q, a:it.a || it.opts?.find((t,i)=>['A','B','C','D'][i]===it.correct) || '', chosen, correct };
}
function summary(){
  qs('#mcqWrap').style.display='none'; qs('#bar').style.display='none'; qs('#summary').style.display='block';
  const total=mcq.items.length, score=mcq.answered.filter(x=>x?.correct).length;
  qs('#sumLine').textContent=`You answered ${score} of ${total} correctly.`;
  const host=qs('#sumList'); host.innerHTML='';
  mcq.answered.forEach((r,i)=>{
    const card=document.createElement('div'); card.className='qa';
    card.innerHTML=`<div class="q">${i+1}. ${r?.q||''} <span class="muted" style="float:right">${r?.correct?'✅ Correct':'❌ Wrong'}</span></div>
      <div class="a" style="display:block">
        <div><strong>Your answer:</strong> ${r?.chosen ?? '<em class="muted">Not answered</em>'}</div>
        <div style="margin-top:6px"><strong>Correct:</strong> ${r?.a||''}</div>
      </div>`;
    host.appendChild(card);
  });
}

/* ========= INIT ========= */
async function init(){
  const p=new URLSearchParams(location.search);
  const tabName=(p.get('sheet')||'').trim();
  const forcedGid=(p.get('gid')||'').trim();
  const mode=(p.get('mode')||'list').toLowerCase();
  const limit=parseInt(p.get('limit')||'0',10);
  const timerSec=parseInt(p.get('timer')||'0',10);

  qs('#title').textContent = tabName || 'Quiz';
  qs('#kicker').textContent = mode==='mcq' ? 'Multiple choice (options shuffled)' : 'Answers only';

  let gid = forcedGid || await getGidByName(GS_SHEET_ID, tabName);
  if(!gid){
    qs('#warn').style.display='block';
    qs('#warn').innerHTML = `Could not find a published tab with that name. Publish the <b>entire document</b> (File → Share → Publish to the web) or pass <code>&gid=...</code>.`;
    return;
  }

  try{
    const rows = await fetchCSVByGid(GS_SHEET_ID, gid);
    const {items, header} = rowsToItems(rows);
    if(limit>0) items.splice(limit);

    if(items.length===0){
      qs('#warn').style.display='block';
      qs('#warn').innerHTML = `Loaded the tab but didn’t recognize any questions.<br><br>
        <b>First-row headers I see:</b><br>
        <code>${header.map(h=>h||'').join(' | ')}</code><br><br>
        Expected columns like <code>question / answer</code> (or Malayalam equivalents: <code>ചോദ്യം / ഉത്തരം</code>).
        I also try a 2-column fallback (Q/A). Please ensure the first data row is the header row.`;
      return;
    }

    // choose mode
    const hasOptions = items.some(it => it.opts && it.opts.length);
    if(mode==='mcq' || hasOptions){
      const mcqItems = hasOptions ? items.filter(it=>it.opts && it.opts.length) : items;
      if(mcqItems.length===0){
        // fallback to list if no valid options anywhere
        qs('#listWrap').style.display='grid';
        buildList(items);
        return;
      }
      qs('#mcqWrap').style.display='block';
      qs('#bar').style.display='flex';
      shuffle(mcqItems);
      mcq.items=mcqItems; mcq.i=0; mcq.answered=Array(mcqItems.length);
      showQ();
      if(timerSec>0) startTimer(timerSec, summary);

      qs('#prevBtn').onclick=()=>{ if(mcq.i>0){ mcq.i--; showQ(); } };
      qs('#revealBtn').onclick=()=>{ lockQ(); record(); qs('#revealBtn').textContent='Answer Shown'; };
      qs('#nextBtn').onclick=()=>{ record(); if(mcq.i<mcq.items.length-1){ mcq.i++; showQ(); } else { if(mcq.timer) clearInterval(mcq.timer); summary(); } };
    }else{
      qs('#listWrap').style.display='grid';
      buildList(items);
    }
  }catch(err){
    qs('#warn').style.display='block';
    qs('#warn').innerHTML = `Failed to load this tab. Make sure the sheet is <b>Published to the web</b> (entire document).<br><br><code>${String(err)}</code>`;
  }
}

init();
</script>
</body>
</html>
