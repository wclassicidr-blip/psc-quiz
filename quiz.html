<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PSC Guru • Quiz</title>
<style>
  :root{--bg:#f2f8f4;--card:#fff;--ink:#113b2f;--muted:#58736c;--accent:#0fa66d;--line:#e6eee9}
  *{box-sizing:border-box} html,body{margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  .row{display:flex;gap:10px;align-items:center}
  .right{margin-left:auto}
  .pill{background:#fff;border:1px solid var(--line);border-radius:999px;padding:6px 12px;text-decoration:none;color:var(--ink)}
  h1{margin:10px 0 16px}
  .alert{background:#fff9e8;border:1px solid #f6e2b0;color:#5f4a00;padding:10px 12px;border-radius:10px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
  .btn{background:#fff;border:1px solid var(--line);border-radius:10px;height:36px;padding:0 12px;display:inline-flex;align-items:center;gap:8px;cursor:pointer}
  .btn-primary{background:#0fa66d;border-color:#0fa66d;color:#fff}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  .opt{border:1px solid var(--line);border-radius:12px;padding:12px;cursor:pointer}
  .opt.correct{border-color:#1f7c59;background:#eaf8f2}
  .opt.wrong{border-color:#c73b3b;background:#fdeeee}
  .stickybar{position:sticky;bottom:0;background:rgba(242,248,244,.92);backdrop-filter:saturate(160%) blur(3px);border-top:1px solid var(--line);padding:10px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <a class="pill" href="index.html">Home</a>
    <a class="pill" href="quiz.html">Quiz</a>
    <div class="right pill" id="timerBox">00:00</div>
  </div>

  <h1 id="title">Quiz</h1>
  <div id="warn"></div>
  <div id="qwrap" class="card" style="display:none">
    <div id="qtext" style="font-weight:700"></div>
    <div style="height:8px"></div>
    <div id="opts" class="grid"></div>
    <div style="height:8px"></div>
    <button id="showAnswer" class="btn">Show Answer</button>
  </div>

  <div class="stickybar">
    <div class="row" style="justify-content:space-between">
      <button id="prev" class="btn">← Prev</button>
      <span id="page" class="pill">1 / 1</span>
      <button id="next" class="btn btn-primary">Next →</button>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const GS_SHEET_ID = "16iIOLKAkFzXD1ja7v6b7_ZUKVjbcsswX8LfJ_D0S57o";

/* ===== utils ===== */
const norm = s => (s ?? '').toString().normalize('NFKC').replace(/\u00A0/g,' ').trim();
const low  = s => norm(s).toLowerCase();
async function fetchText(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(r.statusText); return r.text();}
function parseCSV(t){const R=[];let i=0,f='',r=[],q=false;const pf=()=>{r.push(f);f='';};const pr=()=>{R.push(r);r=[];};while(i<t.length){const c=t[i];if(q){if(c=='"'&&t[i+1]=='"'){f+='"';i+=2;continue}if(c=='"'){q=false;i++;continue}f+=c;i++;continue}if(c=='"'){q=true;i++;continue}if(c==','){pf();i++;continue}if(c=='\r'){i++;continue}if(c=='\n'){pf();pr();i++;continue}f+=c;i++}pf();pr();while(R.length&&R[R.length-1].every(c=>low(c)===''))R.pop();return R;}
async function csvBySheet(sheet){ const u=`https://docs.google.com/spreadsheets/d/${GS_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}`; const t=await fetchText(u); return parseCSV(t); }

/* ===== map rows to Qs ===== */
function rowsToQuestions(rows){
  if(!rows || rows.length<2) return [];
  const H = rows[0].map(h=>low(h));
  const ixQ   = H.findIndex(h=>['question','q','prompt'].some(k=>h.includes(k)));
  const ixAns = H.findIndex(h=>['answer','ans','correct'].some(k=>h.includes(k)));
  const ixA   = H.findIndex(h=>['opta','a','opt a'].includes(h));
  const ixB   = H.findIndex(h=>['optb','b','opt b'].includes(h));
  const ixC   = H.findIndex(h=>['optc','c','opt c'].includes(h));
  const ixD   = H.findIndex(h=>['optd','d','opt d'].includes(h));
  const out=[];
  for(let i=1;i<rows.length;i++){
    const r = rows[i].map(v=>v??'');
    const q = ixQ>=0 ? r[ixQ] : r[0];
    const ans = ixAns>=0 ? r[ixAns] : '';
    const opts = [ixA,ixB,ixC,ixD].filter(x=>x>=0).map(x=>r[x]).filter(Boolean);
    out.push({q,ans,opts});
  }
  return out.filter(x=>low(x.q)!=='');
}

/* ===== state ===== */
const qs = new URLSearchParams(location.search);
const SHEET  = qs.get('sheet');           // we use sheet name
const LIMIT  = parseInt(qs.get('limit')||'0',10);
const TIMER  = parseInt(qs.get('timer')||'0',10);

const titleEl = document.getElementById('title');
const warnEl  = document.getElementById('warn');
const qwrap   = document.getElementById('qwrap');
const qtext   = document.getElementById('qtext');
const optsEl  = document.getElementById('opts');
const pageEl  = document.getElementById('page');
const timerEl = document.getElementById('timerBox');
const showBtn = document.getElementById('showAnswer');

let Q=[], idx=0;

/* ===== timer ===== */
if(TIMER>0){
  let left=TIMER;
  (function tick(){
    const m=String(Math.floor(left/60)).padStart(2,'0');
    const s=String(left%60).padStart(2,'0');
    timerEl.textContent=`${m}:${s}`;
    left--; if(left>=0) setTimeout(tick,1000);
  })();
}

/* shuffle helper */
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a }

/* render */
function render(){
  if(!Q.length){ qwrap.style.display='none'; return }
  const item = Q[idx];
  titleEl.textContent = SHEET || 'Quiz';
  qwrap.style.display='block';
  qtext.textContent = `${idx+1}. ${item.q}`;
  pageEl.textContent = `${idx+1} / ${Q.length}`;

  const withAns = [...item.opts];
  if(item.ans && !withAns.some(o=>low(o)===low(item.ans))) withAns.push(item.ans);
  const shuffled = shuffle(withAns.slice());
  const correctIndex = shuffled.findIndex(x => low(x)===low(item.ans));

  optsEl.innerHTML='';
  shuffled.forEach((opt,i)=>{
    const d=document.createElement('div');
    d.className='opt';
    d.textContent=opt||'(blank)';
    d.onclick=()=>{
      [...optsEl.children].forEach(c=>c.classList.remove('correct','wrong'));
      d.classList.add(i===correctIndex ? 'correct' : 'wrong');
    };
    optsEl.appendChild(d);
  });

  showBtn.onclick=()=>[...optsEl.children].forEach((div,i)=>div.classList.toggle('correct',i===correctIndex));
}

/* navigation */
document.getElementById('prev').onclick = ()=>{ if(idx>0){idx--; render()} };
document.getElementById('next').onclick = ()=>{ if(idx<Q.length-1){idx++; render()} };

/* load */
(async ()=>{
  try{
    if(!SHEET) throw new Error('No ?sheet= specified in URL.');
    const rows = await csvBySheet(SHEET);
    const all  = rowsToQuestions(rows);
    Q = LIMIT>0 ? all.sort(()=>Math.random()-0.5).slice(0,LIMIT) : all;
    if(!Q.length) throw new Error('No questions found in this tab.');
    render();
  }catch(e){
    warnEl.innerHTML = `<div class="alert">Failed to load this tab. Make sure the sheet is public and the tab exists. Error: ${e.message}</div>`;
  }
})();
</script>
</body>
</html>
