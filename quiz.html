<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz • PSC Guru</title>
  <style>
    :root{
      --bg:#eef7ef;
      --card:#fff;
      --ink:#0b2b19;
      --muted:#5a6f63;
      --brand:#2aa86f;
      --brand-ghost:#e8f7f0;
      --danger:#e85a5a;
      --ok:#2dbb74;
      --ring:rgba(42,168,111,.25)
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{position:sticky;top:0;background:linear-gradient(#e3f2e7,#eef7ef);border-bottom:1px solid #dfeee5;backdrop-filter:saturate(180%) blur(8px);z-index:10}
    header .bar{display:flex;align-items:center;gap:12px;padding:10px 14px}
    .logo{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo-badge{width:34px;height:34px;border-radius:8px;background:#1e7f55;color:#fff;display:grid;place-items:center;font-weight:800}
    .spacer{flex:1}
    .pill{display:inline-block;background:#fff;border:1px solid #dfeee5;padding:6px 14px;border-radius:22px}
    .pill:hover{box-shadow:0 0 0 2px var(--ring)}
    main h1{margin:10px 0 14px 0;font-size:28px}
    .warn{background:#fff7e5;border:1px solid #ffe0a6;color:#5f4200;padding:12px 14px;border-radius:12px}
    .controls{display:flex;gap:10px;margin:10px 0 16px}
    .btn{display:inline-flex;align-items:center;gap:8px;background:#fff;border:1px solid #dfeee5;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{box-shadow:0 0 0 2px var(--ring)}
    .qa{background:var(--card);border:1px solid #dfeee5;border-radius:16px;padding:16px;margin:12px 0}
    .q-top{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .q-no{width:28px;height:28px;border-radius:8px;background:var(--brand-ghost);color:#0d6b43;display:grid;place-items:center;font-weight:700}
    .q-text{font-size:17px;font-weight:600}
    .opts{display:grid;gap:8px;margin-top:12px}
    .opt{all:unset;display:flex;align-items:center;gap:10px;border:1px solid #e7efe9;background:#fff;padding:10px 12px;border-radius:12px;cursor:pointer}
    .opt:hover{box-shadow:0 0 0 2px var(--ring)}
    .opt-letter{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:8px;background:#f3f7f5;color:#4b5e53;font-weight:700}
    .opt.correct{border-color:#bfead3;background:#f2fbf7}
    .opt.wrong{border-color:#f2c4c4;background:#fff6f6}
    .answer{margin-top:10px;padding:10px 12px;border-radius:12px;background:#f4faf6;border:1px dashed #cdebdc}
    .hide{display:none}
    .footnote{margin-top:18px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <header>
    <div class="bar container">
      <div class="logo">
        <div class="logo-badge">PSC</div>
        <div>PSC Guru</div>
      </div>
      <div class="spacer"></div>
      <a class="pill" href="index.html">Home</a>
      <!-- IMPORTANT: keep this pointing to category list to avoid entering quiz with no sheet -->
      <a class="pill" href="index.html#categories">Quiz</a>
    </div>
  </header>

  <main class="container">
    <h1>Quiz</h1>
    <div id="notice" class="warn hide"></div>

    <div class="controls">
      <button id="showAll" class="btn">Show all answers</button>
      <button id="hideAll" class="btn">Hide all</button>
    </div>

    <div id="list"></div>

    <div class="footnote" id="meta"></div>
  </main>

  <script>
    /* ================= CONFIG ================ */
    // Your Google Sheet *document* ID (not the publish ID)
    // Example shown in your screenshots; keep it here or replace with yours.
    const GS_SHEET_ID = "16iIOLKAKfzXD1ja7v6b7_ZUKVjbcsswX8LfJ_D0S57o";

    /* ============ URL helpers ============ */
    const qs = new URLSearchParams(location.search);
    const MODE  = (qs.get("mode") || "category").toLowerCase();
    const SHEET = qs.get("sheet") || "";
    const PAGE_SIZE = 9999; // show all on one page for this file

    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];
    const show = (el) => el.classList.remove('hide');
    const hide = (el) => el.classList.add('hide');
    const setWarn = (msg) => { const n=$("#notice"); n.textContent=msg; show(n); };

    /* ======== Google Sheets gviz fetch + table-to-rows ======== */
    async function fetchSheet(sheetName){
      // gviz endpoint (works with public share or publish-to-web)
      const url = `https://docs.google.com/spreadsheets/d/${GS_SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json`;
      const txt = await fetch(url).then(r=>r.text());
      const json = JSON.parse(txt.substring(txt.indexOf('{'), txt.lastIndexOf('}')+1));
      const cols = json.table.cols.map(c => (c.label || '').trim());
      const rows = json.table.rows.map(r => (r.c || []).map(c => (c ? c.v : '')));
      // If the first real row looks like headers, use it; otherwise use the column labels.
      let headers = cols;
      const firstRow = rows[0] || [];
      const likelyHeader = firstRow.map(x => (x||'').toString().toLowerCase());
      if (likelyHeader.includes('question') || likelyHeader.includes('answer')) {
        headers = firstRow.map(x => (x||'').toString().trim());
        rows.shift();
      }
      // map to objects
      const out = rows.map(r => {
        const obj = {};
        headers.forEach((h,i) => obj[String(h||'').trim()] = (r[i] ?? ''));
        return obj;
      });
      return out;
    }

    /* ============== Choice building and shuffling ============== */
    const LETTERS = ['A','B','C','D'];
    const norm = (s) => (s || '').toString().trim().replace(/\s+/g,' ').toLowerCase();

    function shuffleArray(arr){
      for (let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    /**
     * Build option objects from a question row `q`.
     * Returns [{ text, isCorrect }, ...] SHUFFLED.
     * Supports:
     *   - q.correct as "A|B|C|D" OR the exact answer text
     *   - fallbacks to q.answer if 'correct' is not set
     */
    function buildChoices(q){
      // Gather options from optA..optD (case-insensitive)
      let opts = [];
      LETTERS.forEach(L=>{
        const v = q['opt'+L] ?? q['opt'+L.toLowerCase()];
        if (v !== undefined && v !== '') {
          opts.push({ text: String(v), isCorrect:false });
        }
      });

      // Determine correct text
      let correctText = '';
      if (q.correct && String(q.correct).trim() !== '') {
        const c = String(q.correct).trim();
        if (LETTERS.includes(c.toUpperCase())){
          correctText = q['opt'+c.toUpperCase()] ?? q['opt'+c.toLowerCase()] ?? '';
        } else {
          correctText = c;
        }
      } else {
        correctText = q.answer ? String(q.answer) : '';
      }

      // Mark correct by text
      let anyMarked = false;
      opts.forEach(o=>{
        if (norm(o.text) === norm(correctText)) { o.isCorrect=true; anyMarked=true; }
      });

      // If the correct text wasn't in options, add it as an extra option
      if (!anyMarked && correctText) {
        opts.push({ text: correctText, isCorrect:true });
      }

      // De-duplicate by text while keeping a correct one if duplicates
      const seen = new Map();
      for (const o of opts){
        const k = norm(o.text);
        if (!seen.has(k) || o.isCorrect) seen.set(k,o);
      }
      opts = [...seen.values()];

      // SHUFFLE so correct isn't always first
      return shuffleArray(opts);
    }

    /* ============== Rendering ============== */
    function onOptionClick(e){
      const btn = e.currentTarget;
      const wrap = btn.closest('.opts');
      // disable others
      $$('.opt', wrap).forEach(b=>b.disabled = true);
      const isCorrect = btn.dataset.correct === '1';
      btn.classList.add(isCorrect ? 'correct' : 'wrong');
      if (!isCorrect){
        // highlight the correct one
        const good = $('.opt[data-correct="1"]', wrap);
        if (good) good.classList.add('correct');
      }
    }

    function renderQA(items){
      const list = $("#list");
      list.innerHTML = '';

      items.forEach((q, idx)=>{
        // Skip empty lines
        const qText = (q.question ?? q.Question ?? '').toString().trim();
        const aText = (q.answer   ?? q.Answer   ?? '').toString().trim();
        if (!qText) return;

        const card = document.createElement('div');
        card.className = 'qa';

        const top = document.createElement('div');
        top.className = 'q-top';
        top.innerHTML = `<div class="q-no">${idx+1}</div><div class="q-text">${qText}</div>`;
        card.appendChild(top);

        // Does this row look like MCQ (has any options)?
        const hasAnyOption =
          !!(q.optA ?? q.opta) ||
          !!(q.optB ?? q.optb) ||
          !!(q.optC ?? q.optc) ||
          !!(q.optD ?? q.optd);

        if (hasAnyOption){
          const choices = buildChoices(q);
          const optsWrap = document.createElement('div');
          optsWrap.className = 'opts';
          choices.forEach((choice, i)=>{
            const btn = document.createElement('button');
            btn.type='button';
            btn.className='opt';
            btn.dataset.correct = choice.isCorrect ? '1' : '0';
            btn.innerHTML = `<span class="opt-letter">${String.fromCharCode(65+i)}.</span> ${choice.text}`;
            btn.addEventListener('click', onOptionClick);
            optsWrap.appendChild(btn);
          });
          card.appendChild(optsWrap);
        } else {
          // Simple Q/A row – show a reveal button
          const reveal = document.createElement('div');
          reveal.className = 'answer hide';
          reveal.textContent = aText || '—';
          const btn = document.createElement('button');
          btn.className='btn';
          btn.type='button';
          btn.textContent = 'Show Answer';
          btn.addEventListener('click', ()=>{
            if (reveal.classList.contains('hide')) {
              reveal.classList.remove('hide');
              btn.textContent = 'Hide Answer';
            } else {
              reveal.classList.add('hide');
              btn.textContent = 'Show Answer';
            }
          });
          card.appendChild(btn);
          card.appendChild(reveal);
        }

        list.appendChild(card);
      });
    }

    /* ============== Init ============== */
    async function init(){
      if (MODE !== 'category'){
        setWarn('Open quizzes from the category cards. Redirecting…');
        setTimeout(()=>location.href='index.html#categories', 800);
        return;
      }
      if (!SHEET){
        setWarn('No category selected. Redirecting to categories…');
        setTimeout(()=>location.href='index.html#categories', 800);
        return;
      }

      try{
        const rows = await fetchSheet(SHEET);
        const clean = rows.filter(r => (r.question ?? r.Question ?? '').toString().trim() !== '');
        if (clean.length === 0){
          setWarn('No questions found in this tab. Check headers: question / answer / optA…optD / correct.');
          return;
        }
        renderQA(clean);
        $('#meta').textContent = `${clean.length} question(s) • Sheet: ${SHEET}`;
      }catch(err){
        console.error(err);
        setWarn('Failed to load this tab. Make sure the sheet is public (or Published to the web) and the tab name matches the card.');
      }
    }

    // Show/Hide all Q/A answers (non-MCQ)
    $('#showAll').addEventListener('click', ()=> $$('.answer').forEach(el=>show(el)));
    $('#hideAll').addEventListener('click',  ()=> $$('.answer').forEach(el=>hide(el)));

    init();
  </script>
</body>
</html>
