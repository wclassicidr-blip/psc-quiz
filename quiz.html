<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quiz</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#eef7ef;
    --card:#ffffff;
    --ink:#13341f;
    --muted:#597963;
    --accent:#2e7d32;
    --accent-2:#1b5e20;
    --warn:#a15c00;
    --pill:#f3faf4;
    --border:rgba(25, 84, 45, .12);
    --shadow:0 6px 20px rgba(25,84,45,.12);
    --radius:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font:16px/1.45 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  header{
    display:flex;gap:.5rem;align-items:center;justify-content:space-between;
    padding:14px 20px;background:linear-gradient(#e8f6e9,#ecf7ee);
    position:sticky;top:0;z-index:5;border-bottom:1px solid var(--border);
  }
  .brand{display:flex;gap:.6rem;align-items:center;font-weight:800}
  .badge{background:#1b5e20;border-radius:12px;color:#fff;padding:6px 9px;font-size:12px}
  .crumbs a{appearance:none;border:1px solid var(--border);background:#fff;padding:.45rem .9rem;border-radius:999px;color:var(--ink);text-decoration:none}
  main{max-width:980px;margin:28px auto;padding:0 18px 110px}
  h1{margin:0 0 16px;font-size:28px;letter-spacing:.2px}
  .timer{font-weight:800;color:var(--accent-2)}
  .note{
    background:#fff4e5;border:1px solid #ffd39c;color:#7a4b00;padding:12px 14px;border-radius:12px;
    box-shadow:var(--shadow);margin:14px 0 20px
  }
  .list{display:grid;gap:14px}
  .qa{
    background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
    box-shadow:var(--shadow);overflow:hidden
  }
  .q{
    padding:16px 18px;font-weight:600;border-bottom:1px solid var(--border);background:var(--pill)
  }
  .a{padding:16px 18px;display:none}
  .qa.open .a{display:block}
  .tools{display:flex;gap:8px;padding:12px}
  .btn{
    appearance:none;border:1px solid var(--border);background:#fff;color:var(--ink);
    padding:.55rem .9rem;border-radius:10px;cursor:pointer
  }
  .btn.accent{background:var(--accent);color:#fff;border-color:transparent}
  .btn.ghost{background:#fff;border-color:var(--border)}
  .btn.small{padding:.4rem .7rem;font-size:.9rem}
  .sticky{
    position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);backdrop-filter:blur(5px);
    border-top:1px solid var(--border);padding:12px 16px;display:flex;justify-content:space-between;align-items:center;z-index:9
  }
  .opt{display:block;margin:10px 0;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
  .opt input{margin-right:8px}
  .opt.correct{border-color:#2e7d32;background:#e9f6ea}
  .opt.wrong{border-color:#c62828;background:#fdeaea}
  .center{display:flex;justify-content:center;margin-top:18px}
  .muted{color:var(--muted)}
  .grid{display:grid;gap:14px}
  .summary-card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
</style>
</head>
<body>
<header>
  <div class="brand">
    <span class="badge">PSC</span>
    <div>
      <div style="font-weight:800">PSC Guru</div>
      <div class="muted" style="font-size:12px;margin-top:-4px">Kerala PSC Exam Prep</div>
    </div>
  </div>
  <div class="crumbs">
    <a href="index.html">Home</a>
    <a href="quiz.html">Quiz</a>
  </div>
</header>

<main>
  <h1 id="title">Quiz</h1>
  <div id="kicker" class="muted" style="margin-bottom:10px"></div>
  <div id="warn" class="note" style="display:none"></div>

  <!-- List mode -->
  <div id="listWrap" class="list" style="display:none"></div>

  <!-- MCQ mode -->
  <div id="mcqWrap" style="display:none">
    <div id="mcqCard" class="qa">
      <div id="mcqQ" class="q">Question</div>
      <div class="a" style="display:block">
        <div id="mcqOpts" class="grid"></div>
      </div>
    </div>
    <div class="center muted" id="mcqProgress" style="margin-bottom:70px">1/1</div>
  </div>

  <!-- Summary -->
  <div id="summary" style="display:none">
    <div class="summary-card">
      <h2 style="margin:0 0 6px">Summary</h2>
      <div id="sumLine" class="muted"></div>
    </div>
    <div id="sumList" class="list" style="margin-top:14px"></div>
  </div>
</main>

<!-- Sticky nav -->
<div id="bar" class="sticky" style="display:none">
  <div class="muted"><span id="timer" class="timer">00:00</span></div>
  <div style="display:flex;gap:8px">
    <button class="btn ghost small" id="prevBtn">← Prev</button>
    <button class="btn small" id="revealBtn">Show Answer</button>
    <button class="btn accent small" id="nextBtn">Next →</button>
  </div>
</div>

<script>
/* ================== CONFIG ================== */
// Your master sheet ID:
const GS_SHEET_ID = "16iIOLKAkFzXD1ja7v6b7_ZUKVjbcsswX8LfJ_D0S57o";

/* =============== helpers =============== */
const qs = (s, el=document) => el.querySelector(s);
const qsa = (s, el=document) => [...el.querySelectorAll(s)];
const sleep = (ms) => new Promise(r => setTimeout(r, ms));
const shuffle = (a) => { for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; };

function slugName(s){
  return (s||'').toString()
    .normalize('NFKC')           // normalize unicode
    .replace(/\u00A0/g,' ')      // nbsp -> space
    .replace(/\s+/g,' ')         // collapse spaces
    .trim()
    .toLowerCase()
    .replace(/[^\p{L}\p{N}]+/gu,''); // letters & digits
}

async function getGidByName(sheetId, name){
  const want = slugName(name);
  const url  = `https://docs.google.com/spreadsheets/d/${sheetId}/pubhtml`;
  const html = await fetch(url, {cache:'no-store'}).then(r=>r.text());
  const re   = /<a[^>]+href="[^"]*#gid=(\d+)"[^>]*>([\s\S]*?)<\/a>/gi;
  let m, fallback=null;
  while((m=re.exec(html))){
    const gid   = m[1];
    const label = m[2]
      .replace(/<[^>]*>/g,'')
      .replace(/&nbsp;/g,' ')
      .replace(/&amp;/g,'&')
      .trim();
    const have  = slugName(label);
    if(have===want) return gid;
    if(!fallback && label.toLowerCase()===name.toLowerCase()) fallback = gid;
  }
  return fallback; // may be null
}

// robust CSV parser (handles quotes/commas/newlines)
function parseCSV(text){
  const rows = [];
  let i=0, field='', row=[], inQ=false;
  const pushField = ()=>{ row.push(field); field=''; };
  const pushRow   = ()=>{ rows.push(row); row=[]; };
  while(i<text.length){
    const c = text[i];
    if(inQ){
      if(c=='"' && text[i+1]=='"'){ field+='"'; i+=2; continue; }
      if(c=='"'){ inQ=false; i++; continue; }
      field+=c; i++; continue;
    }else{
      if(c=='"'){ inQ=true; i++; continue; }
      if(c==','){ pushField(); i++; continue; }
      if(c=='\r'){ i++; continue; }
      if(c=='\n'){ pushField(); pushRow(); i++; continue; }
      field+=c; i++; continue;
    }
  }
  pushField(); pushRow();
  return rows;
}

async function fetchCSVByGid(sheetId, gid){
  const u = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${gid}`;
  const txt = await fetch(u, {cache:'no-store'}).then(r=>r.text());
  return parseCSV(txt);
}

function rowsToItems(rows){
  if(!rows || rows.length<2) return [];
  const header = rows[0].map(h=>h.trim().toLowerCase());
  const idx = (k)=> header.indexOf(k);
  const items = [];
  for(let r=1;r<rows.length;r++){
    const row = rows[r];
    const get = (k)=> row[idx(k)]?.trim?.() ?? '';
    const item = {
      id: get('id') || String(r),
      q: get('question') || get('ques') || '',
      a: get('answer')   || get('ans')  || '',
      optA: get('opta'), optB: get('optb'), optC: get('optc'), optD: get('optd'),
      correct: get('correct')
    };
    const opts = [item.optA,item.optB,item.optC,item.optD].filter(Boolean);
    item.opts = opts.length ? opts : null;
    // derive correct if missing and answer matches one of opts
    if(item.opts && !item.correct){
      const hit = item.opts.findIndex(o => o && o.trim().toLowerCase()===item.a.trim().toLowerCase());
      if(hit>=0) item.correct = ['A','B','C','D'][hit];
    }
    items.push(item);
  }
  return items.filter(x => x.q);
}

/* =============== list mode =============== */
function buildList(items){
  const wrap = qs('#listWrap');
  wrap.innerHTML = '';
  items.forEach((it,i)=>{
    const card = document.createElement('div');
    card.className = 'qa';
    card.innerHTML = `
      <div class="q">${i+1}. ${it.q}</div>
      <div class="a"><div>${it.a || '<em class="muted">No answer</em>'}</div></div>
      <div class="tools"><button class="btn small">Show Answer</button></div>
    `;
    qs('.btn',card).onclick = () => card.classList.toggle('open');
    wrap.appendChild(card);
  });
}

/* =============== MCQ mode =============== */
let mcq = {items:[], i:0, answered:[], timer:null, remaining:0};

function setTimerDisplay(sec){
  const m = String(Math.floor(sec/60)).padStart(2,'0');
  const s = String(sec%60).padStart(2,'0');
  qs('#timer').textContent = `${m}:${s}`;
}

function startCountdown(totalSec, onEnd){
  if(!totalSec || isNaN(totalSec)) { qs('#timer').textContent=''; return; }
  mcq.remaining = totalSec;
  setTimerDisplay(mcq.remaining);
  mcq.timer = setInterval(()=>{
    mcq.remaining--;
    setTimerDisplay(mcq.remaining);
    if(mcq.remaining<=0){
      clearInterval(mcq.timer);
      onEnd?.();
    }
  },1000);
}

function showQuestion(){
  const it = mcq.items[mcq.i];
  qs('#mcqQ').innerHTML = `${mcq.i+1}. ${it.q}`;
  const optsWrap = qs('#mcqOpts'); optsWrap.innerHTML = '';
  // build/shuffle options; mark the canonical correct value
  const labeled = it.opts.map((text,idx)=>({
    text, key:['A','B','C','D'][idx],
    isCorrect: (['A','B','C','D'][idx]===it.correct) ||
               (it.a && text && text.trim().toLowerCase()===it.a.trim().toLowerCase())
  }));
  shuffle(labeled);
  labeled.forEach((op,ix)=>{
    const id=`o_${mcq.i}_${ix}`;
    const div=document.createElement('label');
    div.className='opt';
    div.innerHTML=`<input type="radio" name="q${mcq.i}" id="${id}" value="${ix}"> ${op.text}`;
    div.dataset.correct = op.isCorrect ? '1':'0';
    optsWrap.appendChild(div);
  });
  qs('#mcqProgress').textContent = `${mcq.i+1}/${mcq.items.length}`;
  qs('#revealBtn').textContent = 'Show Answer';
}

function lockQuestion(){
  const opts = qsa('.opt', qs('#mcqCard'));
  opts.forEach(el=>{
    el.querySelector('input').disabled = true;
    if(el.dataset.correct==='1') el.classList.add('correct');
    if(el.querySelector('input').checked && el.dataset.correct!=='1') el.classList.add('wrong');
  });
}

function recordAnswer(){
  const checked = qs('input[type=radio]:checked', qs('#mcqCard'));
  let chosen = null, correct = false;
  if(checked){
    const label = checked.closest('.opt');
    chosen = label.textContent.trim();
    correct = label.dataset.correct==='1';
  }
  const it = mcq.items[mcq.i];
  mcq.answered[mcq.i] = {
    q: it.q,
    a: it.a || it.opts?.find((t,idx)=>['A','B','C','D'][idx]===it.correct) || '',
    chosen,
    correct
  };
}

function showSummary(){
  qs('#mcqWrap').style.display = 'none';
  qs('#bar').style.display = 'none';
  qs('#summary').style.display = 'block';

  const total = mcq.items.length;
  const score = mcq.answered.filter(x=>x?.correct).length;
  qs('#sumLine').textContent = `You answered ${score} of ${total} correctly.`;

  const host = qs('#sumList'); host.innerHTML='';
  mcq.answered.forEach((r,idx)=>{
    const card = document.createElement('div');
    card.className='qa';
    const correctness = r?.correct ? '✅ Correct' : '❌ Wrong';
    card.innerHTML = `
      <div class="q">${idx+1}. ${r?.q||''} <span class="muted" style="float:right">${correctness}</span></div>
      <div class="a" style="display:block">
        <div><strong>Your answer:</strong> ${r?.chosen ?? '<em class="muted">Not answered</em>'}</div>
        <div style="margin-top:6px"><strong>Correct:</strong> ${r?.a || ''}</div>
      </div>
    `;
    host.appendChild(card);
  });
}

/* =============== INIT =============== */
async function init(){
  const p = new URLSearchParams(location.search);
  const tabName = (p.get('sheet')||'').trim();
  const tabGid  = (p.get('gid')||'').trim();       // allow direct gid
  const mode    = (p.get('mode')||'list').toLowerCase(); // list | mcq
  const limit   = parseInt(p.get('limit')||'0',10);       // optional cap
  const timerSec= parseInt(p.get('timer')||'0',10);       // for mcq

  qs('#title').textContent = tabName || 'Quiz';
  qs('#kicker').textContent = mode==='mcq' ? 'Multiple choice (options shuffled)' : 'Answers only';

  // resolve gid
  let gid = tabGid || await getGidByName(GS_SHEET_ID, tabName);
  if(!gid){
    qs('#warn').style.display='block';
    qs('#warn').innerHTML = `Could not find a published tab with that name. Open <b>File → Share → Publish to the web</b> (Entire document), then ensure the tab exists with exactly the same name. You can also pass <code>&gid=...</code> in the URL.`;
    return;
  }

  try{
    const rows = await fetchCSVByGid(GS_SHEET_ID, gid);
    let items = rowsToItems(rows);
    if(limit && limit>0) items = items.slice(0, limit);

    // Which mode are we in?
    const hasOptions = items.some(it => it.opts && it.opts.length);
    if(mode==='mcq' || hasOptions){
      // prepare MCQ
      qs('#mcqWrap').style.display='block';
      qs('#bar').style.display='flex';

      // If there are items without options in a mixed sheet, keep only option items for mcq
      if(!hasOptions) { /* fallback to list */ }
      else items = items.filter(it => it.opts && it.opts.length);

      // shuffle questions for variety
      shuffle(items);
      mcq.items = items;
      mcq.i = 0;
      mcq.answered = Array(items.length);

      showQuestion();
      if(timerSec>0){
        startCountdown(timerSec, showSummary);
      }else{
        qs('#timer').textContent = '';
      }

      // wire buttons
      qs('#prevBtn').onclick = ()=>{
        if(mcq.i>0){ mcq.i--; showQuestion(); }
      };
      qs('#revealBtn').onclick = ()=>{
        lockQuestion();
        recordAnswer();
        qs('#revealBtn').textContent = 'Answer Shown';
      };
      qs('#nextBtn').onclick = ()=>{
        recordAnswer();
        if(mcq.i < mcq.items.length-1){ mcq.i++; showQuestion(); }
        else { if(mcq.timer) clearInterval(mcq.timer); showSummary(); }
      };
    }else{
      // List
      qs('#listWrap').style.display='grid';
      buildList(items);
      qs('#bar').style.display='none';
    }

  }catch(err){
    qs('#warn').style.display='block';
    qs('#warn').innerHTML = `Failed to load this tab. Bad GViz response. Make sure the sheet is <b>Published to the web</b> and the tab name (or <code>gid</code>) is correct.<div style="margin-top:6px" class="muted">${String(err)}</div>`;
  }
}

init();
</script>
</body>
</html>
