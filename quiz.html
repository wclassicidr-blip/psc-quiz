<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiz — PSC Guru</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="header.css">

  <style>
    :root{
      --text:#0f2d1f; --muted:#5f726a; --brand:#0f8346; --error:#d24747;
      --card:#fff; --shadow:0 20px 40px rgba(30,70,50,.15);
      --border: rgba(0,0,0,.06); --bg:#f5fbf7;
    }
    *{box-sizing:border-box} body{margin:0;font:400 16px/1.55 Inter,system-ui;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:22px 16px 60px}

    .title{font-weight:800;font-size:28px;margin:6px 0 14px}

    .progress-wrap{display:flex;align-items:center;gap:12px;margin:6px 0 12px}
    .progress{height:8px;background:#e7f3ec;border-radius:999px;flex:1;overflow:hidden}
    .bar{height:100%;width:0;background:#b8e5cc;border-radius:999px;transition:width .3s ease}
    .paging{color:var(--muted);font-weight:800}

    .qcard{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .qhead{color:var(--muted);font-size:14px;margin-bottom:8px}
    .qtext{font-size:18px;font-weight:700;margin:6px 0 12px}

    .opts{display:grid;gap:10px}
    .opt{
      border:1px solid var(--border);border-radius:12px;padding:12px 14px;background:#fff;
      cursor:pointer; user-select:none;
    }
    .opt:hover{box-shadow:0 6px 16px rgba(30,70,50,.10)}
    .opt.correct{border-color:#8bd2a8;background:#ecfff4}
    .opt.wrong{border-color:#f1b6b6;background:#fff4f4}

    .controls{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:800}
    .btn.primary{background:linear-gradient(180deg,#0f8346,#0b5f34);color:#fff;border:none}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .splash{position:fixed;inset:0;display:none;place-items:center;background:rgba(255,255,255,.6);backdrop-filter:blur(6px);z-index:2000}
    .splash.on{display:grid}
    .spinner{width:64px;height:64px;border-radius:50%;border:6px solid #d9f2e6;border-top-color:#0f8346;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .notice{padding:12px;border-radius:10px;border:1px solid #f7d6b5;background:#fff7ed;color:#7a4c22}
  </style>
</head>
<body>
  <!-- shared header -->
  <script defer src="site-header.js"></script>

  <div class="wrap">
    <h1 class="title">Quiz</h1>

    <div class="progress-wrap" id="progressWrap" hidden>
      <div class="progress"><div class="bar" id="bar"></div></div>
      <span class="paging" id="paging">Page 1 / 1</span>
    </div>

    <div id="panel"></div>

    <div class="controls" id="controls" hidden>
      <button class="btn" id="prevBtn">← Previous</button>
      <button class="btn" id="revealBtn">Show Answer</button>
      <button class="btn primary" id="nextBtn">Next →</button>
    </div>
  </div>

  <div class="splash" id="splash"><div class="spinner" aria-label="Loading"></div></div>

  <script>
    /* ================== CONFIG ================== */
    const GS_SHEET_ID = "16iIOLKAkFzXD1ja7v6b7_ZUKVjbcsswX8LfJ_D0S57o";
    const CATEGORIES_TAB = "Categories";

    // Helpers
    const $ = sel => document.querySelector(sel);
    const panel = $('#panel');
    const splash = $('#splash');
    const bar = $('#bar');
    const paging = $('#paging');
    const progressWrap = $('#progressWrap');
    const prevBtn = $('#prevBtn');
    const nextBtn = $('#nextBtn');
    const revealBtn = $('#revealBtn');
    const controls = $('#controls');

    const params = new URLSearchParams(location.search);
    const sheet = params.get('sheet');
    const mode = params.get('mode'); // "random" or undefined
    const N = params.get('n');       // requested number of Qs

    let questions = [];
    let results = [];
    let i = 0, score = 0, revealed = false;

    // Splash helpers
    function showSplash(on){ splash.classList.toggle('on', !!on); }

    function stripGVizJSON(txt){ const s=txt.indexOf('{'), e=txt.lastIndexOf('}'); return JSON.parse(txt.slice(s,e+1)); }
    async function gviz(tab){
      const url = `https://docs.google.com/spreadsheets/d/${GS_SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(tab)}&tq=${encodeURIComponent("select *")}`;
      const res = await fetch(url,{cache:"no-store"}); if(!res.ok) throw new Error("GViz failed");
      const raw = await res.text(); const json = stripGVizJSON(raw);
      const cols = json.table.cols.map(c => (c.label||"").trim().toLowerCase());
      const rows = json.table.rows.map(r => (r.c||[]).map(c => (c&&c.v)!=null ? String(c.v) : ""));
      return {cols, rows};
    }

    async function chooseRandomSheet(){
      const {cols, rows} = await gviz(CATEGORIES_TAB);
      const idxTab = cols.findIndex(t => /(get|sheet|tab)/.test(t));
      const sheets = rows.map(r => (r[idxTab]||"").trim()).filter(Boolean);
      if(!sheets.length) throw new Error("No categories found");
      return sheets[Math.floor(Math.random()*sheets.length)];
    }

    function shuffle(arr){
      const a = [...arr];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    function mapToQuestions(cols, rows){
      const h = name => cols.findIndex(c => c === name);
      const idxQ = h('question');
      const idxA = h('answer');
      const idxA1 = h('opta'), idxB1 = h('optb'), idxC1 = h('optc'), idxD1 = h('optd');

      return rows.map(r=>{
        const q = (r[idxQ]||"").trim();
        const ans = (r[idxA]||"").trim();
        const opts = [r[idxA1], r[idxB1], r[idxC1], r[idxD1]].map(x=> (x||"").trim()).filter(Boolean);

        if(!q || !opts.length || !ans) return null;

        // find correct option index with robust matching
        let correct = -1;
        const ansU = ans.toUpperCase();
        if(['A','B','C','D'].includes(ansU)) correct = "ABCD".indexOf(ansU);
        else correct = opts.findIndex(o => o.trim().toLowerCase() === ans.trim().toLowerCase());
        if(correct < 0) correct = 0; // fallback

        // shuffle options while keeping correctness
        const pairs = opts.map((t,idx)=>({t,idx}));
        const shuffled = shuffle(pairs);
        const newOpts = shuffled.map(p=>p.t);
        const newCorrect = shuffled.findIndex(p=>p.idx===correct);

        return { q, opts:newOpts, correct:newCorrect };
      }).filter(Boolean);
    }

    function sample(arr, n){
      if(!n || String(n).toUpperCase()==='N') return arr;
      const a=[...arr]; const out=[];
      for(let k=0;k<n && a.length;k++){
        out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]);
      }
      return out;
    }

    function render(){
      if(!questions.length){
        panel.innerHTML = `<div class="notice">No questions available.</div>`;
        controls.hidden = true;
        progressWrap.hidden = true;
        return;
      }
      const q = questions[i];
      progressWrap.hidden = false;
      bar.style.width = `${((i+1)/questions.length)*100}%`;
      paging.textContent = `Page ${i+1} / ${questions.length}`;

      panel.innerHTML = `
        <div class="qcard">
          <div class="qhead">Question ${i+1} / ${questions.length}</div>
          <div class="qtext">${q.q}</div>
          <div class="opts">
            ${q.opts.map((o,idx)=>`<div class="opt" data-idx="${idx}">${o}</div>`).join('')}
          </div>
        </div>
      `;

      controls.hidden = false;
      prevBtn.disabled = i===0;
      nextBtn.textContent = (i===questions.length-1) ? 'Finish →' : 'Next →';
      revealed = false;

      // Interaction
      panel.querySelectorAll('.opt').forEach(el=>{
        el.addEventListener('click', ()=>{
          if(revealed) return;
          const sel = Number(el.dataset.idx);
          results[i] = {sel, correct: sel === q.correct};
          if(sel === q.correct){ el.classList.add('correct'); score++; }
          else{
            el.classList.add('wrong');
            panel.querySelector(`.opt[data-idx="${q.correct}"]`)?.classList.add('correct');
          }
          revealed = true;
        });
      });
    }

    prevBtn.addEventListener('click', ()=>{
      if(i>0){ i--; render(); }
    });
    nextBtn.addEventListener('click', ()=>{
      if(i<questions.length-1){ i++; render(); }
      else summary();
    });
    
    // Quit early: show summary
    const quitBtn = $('#quitBtn');
    quitBtn.addEventListener('click', ()=> summary(true));

    revealBtn.addEventListener('click', ()=>{
      if(revealed) return;
      const q = questions[i];
      panel.querySelector(`.opt[data-idx="${q.correct}"]`)?.classList.add('correct');
      revealed = true;
    });

    
    function summary(quit=false){
      progressWrap.hidden = true;
      controls.hidden = true;
      const attempted = results.filter(x=>x).length;
      const total = questions.length;
      const percent = total ? Math.round((score/total)*100) : 0;
      const rows = questions.map((q, idx)=>{
        const r = results[idx];
        const status = r ? (r.correct ? '✅' : '❌') : '—';
        const sel = (r && q.opts[r.sel]) ? q.opts[r.sel] : '—';
        return `<tr>
          <td style="padding:8px 10px;border-bottom:1px solid #eee">${idx+1}</td>
          <td style="padding:8px 10px;border-bottom:1px solid #eee">${q.q}</td>
          <td style="padding:8px 10px;border-bottom:1px solid #eee">${sel}</td>
          <td style="padding:8px 10px;border-bottom:1px solid #eee"><b>${q.opts[q.correct]}</b></td>
          <td style="padding:8px 10px;border-bottom:1px solid #eee">${status}</td>
        </tr>`;
      }).join("");

      panel.innerHTML = `
        <div class="qcard">
          <div class="qtext">Summary ${quit ? "(Quit)" : ""}</div>
          <p class="qhead">Score: <b>${score}</b> / ${total} (${percent}%) &nbsp; • &nbsp; Attempted: ${attempted}</p>
          <div style="max-height:320px;overflow:auto;border:1px solid #eee;border-radius:10px">
            <table style="width:100%;border-collapse:collapse;font-size:14px">
              <thead>
                <tr style="background:#f8fff9">
                  <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #eee">#</th>
                  <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #eee">Question</th>
                  <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #eee">Your answer</th>
                  <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #eee">Correct</th>
                  <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #eee">Result</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
          <div class="controls" style="justify-content:flex-start;margin-top:16px">
            <button class="btn" onclick="location.href='index.html'">← Home</button>
            <button class="btn primary" onclick="location.reload()">Play again</button>
          </div>
        </div>
      `;
    }


    async function boot(){
      try{
        showSplash(true);
        let targetSheet = sheet;

        if(!targetSheet && mode === 'random'){
          targetSheet = await chooseRandomSheet();
        }
        if(!targetSheet){
          showSplash(false);
          panel.innerHTML = `<div class="notice">No category selected.</div>`;
          return;
        }

        // Fetch questions
        const {cols, rows} = await gviz(targetSheet);
        let qs = mapToQuestions(cols, rows);
        qs = shuffle(qs);                 // random order of questions
        qs = sample(qs, N);               // sample N if provided

        questions = qs;
        i = 0; score = 0;
        render();
      } catch (err){
        console.error(err);
        panel.innerHTML = `<div class="notice">Failed to load questions. Check sheet access / names.</div>`;
      } finally{
        showSplash(false);
      }
    }

    boot();
  </script>
</body>
</html>
