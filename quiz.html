<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PSC Guru — Quiz</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: #f2f8f4; --bg-2: #eaf4ef;
    --glass: rgba(255,255,255,.85);
    --card:#ffffff;
    --text:#0f2d1f; --muted:#5f726a;
    --brand:#0f8346; --brand-600:#0b5f34;
    --ring: rgba(15,131,70,.22);
    --good:#14a44d; --bad:#e53935;
    --r: 18px;
    --shadow: 0 20px 40px rgba(30,70,50,.12);
    --barTrack:#e9f7e8; --barFill:#79c07d;
  }
  *{box-sizing:border-box}
  body{margin:0;font:400 16px/1.55 Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
       color:var(--text);background:linear-gradient(180deg,var(--bg),var(--bg-2));}
  .wrap{max-width:1200px;margin:0 auto;padding:22px 18px 72px}

  /* ===== Top Bar (same as home) ===== */
  .bar{display:flex;gap:14px;align-items:center;margin-bottom:22px}
  .brand{display:flex;align-items:center;gap:12px;padding:8px 10px;border-radius:14px;
         background:var(--glass);box-shadow:var(--shadow)}
  .logo{height:38px;width:38px;border-radius:12px;display:grid;place-items:center;
        font-weight:900;color:#fff;background:linear-gradient(160deg,#0dcf8b,#0b8f6b);}
  .brand h1{font-size:18px;margin:0;font-weight:800;letter-spacing:.2px}
  .brand small{display:block;margin-top:-2px;font-size:12px;color:var(--muted);font-weight:600}
  .links{margin-left:auto;display:flex;gap:10px}
  .pill{padding:8px 14px;border-radius:999px;background:#fff;font-weight:700;
        border:1px solid #e9eee9;box-shadow:var(--shadow);text-decoration:none;color:var(--text)}
  .pill.active{background:linear-gradient(180deg,var(--brand),var(--brand-600));color:#062016;border:none}

  /* ===== Quiz ===== */
  h2.title{font-size:26px;margin:6px 0 14px;font-weight:800}
  .card{background:#fff;border:1px solid #e9eee9;border-radius:18px;box-shadow:var(--shadow);
        padding:18px 18px;margin-bottom:14px}
  .qhead{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:10px}
  .qnum{font-weight:800;color:var(--muted)}
  .timer{font-weight:800;color:var(--brand-600)}
  .qtxt{font-size:18px;font-weight:700;margin:8px 0 14px}

  .opt{border:1px solid #e9eee9;border-radius:12px;padding:12px 14px;margin:10px 0;cursor:pointer;
       transition:.15s ease;background:#fff}
  .opt:hover{transform:translateY(-1px)}
  .opt.correct{background:#e8f7ee;border-color:#9fe3c2;box-shadow:0 0 0 4px rgba(20,164,77,.12) inset}
  .opt.wrong{background:#fde8e7;border-color:#f5a3a0;box-shadow:0 0 0 4px rgba(229,57,53,.10) inset}
  .opt.disabled{pointer-events:none;opacity:.85}

  /* progress row like screenshot */
  .progressRow{
    display:flex;align-items:center;gap:14px;margin:8px 0 18px;
  }
  .progressRow .left{white-space:nowrap;font-weight:700;color:var(--muted)}
  .progBar{
    flex:1;height:8px;border-radius:999px;background:var(--barTrack);
    position:relative;overflow:hidden;
  }
  .progFill{
    position:absolute;left:0;top:0;height:100%;width:0%;
    background:var(--barFill);border-radius:999px;transition:width .25s ease;
  }
  .pager{display:flex;align-items:center;gap:10px}
  .pageTag{background:#e6f4e5;border:1px solid #d5ebd3;color:#0b5f34;border-radius:12px;
          padding:6px 12px;font-weight:800}

  /* bottom controls near card (sticky) */
  .controls{display:flex;gap:10px;align-items:center;justify-content:center;position:sticky;bottom:10px;margin-top:10px}
  .btn{display:inline-flex;align-items:center;gap:8px;font-weight:900;padding:10px 16px;border-radius:12px;
       border:none;background:linear-gradient(180deg,var(--brand),var(--brand-600));color:#062016;
       cursor:pointer;box-shadow:0 10px 25px var(--ring)}
  .btn:hover{filter:brightness(1.05)}
  .btn-ghost{background:#fff;border:1px solid #e9eee9;color:var(--text)}
  .btn-icon{border-radius:999px;padding:10px 14px}
  .muted{color:var(--muted);font-weight:700}
  .alert{background:#fff5e9;border:1px solid #ffdcb5;border-radius:12px;padding:12px 14px;color:#6e4500}
  .hidden{display:none}
</style>

<!-- ========== RANDOM MODE RESOLVER (fix for ?mode=random) ========== -->
<script>
const GS_SHEET_ID = "16iIOLKAkFzXD1ja7v6b7_ZUKVjbcsswX8LfJ_D0S57o";
const GS_PUB_EKEY = "2PACX-1vR4PuWTfq2838_kUaKcwmeWlKb5OtEmL6YqUX4DjPcrb6EaJfW-monSIqbZTiI3ZFrE6GBFHaP7k95A";
const CATEGORIES_TAB = "Categories";

function _stripGVizJSON(txt){ const s = txt.indexOf('{'); const e = txt.lastIndexOf('}'); return JSON.parse(txt.slice(s,e+1)); }
function _csvSplit(line){ return line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(v=>v.replace(/^"|"$/g,"")); }

async function _catsFromCSV(){
  if(!GS_PUB_EKEY) return [];
  try{
    const url = `https://docs.google.com/spreadsheets/d/e/${GS_PUB_EKEY}/pub?output=csv&sheet=${encodeURIComponent(CATEGORIES_TAB)}`;
    const res = await fetch(url,{cache:"no-store"}); if(!res.ok) throw 0;
    const text = await res.text();
    const lines = text.trim().split(/\r?\n/);
    const head  = _csvSplit(lines.shift()).map(h=>h.toLowerCase());
    const iName = head.findIndex(h=>/name/.test(h));
    const iTab  = head.findIndex(h=>/(get|sheet|tab)/.test(h));
    return lines.map(l=>{
      const r = _csvSplit(l);
      return {name:(r[iName]||r[iTab]||"").trim(), sheet:(r[iTab]||r[iName]||"").trim()};
    }).filter(x=>x.sheet);
  }catch{return []}
}
async function _catsFromGViz(){
  try{
    const url = `https://docs.google.com/spreadsheets/d/${GS_SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(CATEGORIES_TAB)}&tq=${encodeURIComponent("select *")}`;
    const res = await fetch(url,{cache:"no-store"}); if(!res.ok) throw 0;
    const json = _stripGVizJSON(await res.text());
    const cols = json.table.cols.map(c => (c.label||"").toLowerCase());
    const rows = json.table.rows.map(r => (r.c||[]).map(c => (c&&c.v)!=null ? String(c.v) : ""));
    const iName = cols.findIndex(h=>/name/.test(h));
    const iTab  = cols.findIndex(h=>/(get|sheet|tab)/.test(h));
    return rows.map(r=>({name:(r[iName]||r[iTab]||"").trim(), sheet:(r[iTab]||r[iName]||"").trim()}))
               .filter(x=>x.sheet);
  }catch{return []}
}

(async function resolveRandom(){
  const qs = new URLSearchParams(location.search);
  const mode = (qs.get("mode")||"").toLowerCase();
  if(mode!=="random" || qs.get("sheet")) return;

  let cats = await _catsFromCSV();
  if(!cats.length) cats = await _catsFromGViz();
  if(!cats.length) return; // page will show "No category selected"

  const pick = cats[Math.floor(Math.random()*cats.length)].sheet;
  qs.set("sheet", pick);
  location.replace(`${location.pathname}?${qs.toString()}`);
})();
</script>
</head>
<body>
  <div class="wrap">

    <!-- Top Bar (same across pages) -->
    <div class="bar">
      <div class="brand">
        <div class="logo">PSC</div>
        <div>
          <h1>PSC Guru</h1>
          <small>Kerala PSC Exam Prep</small>
        </div>
      </div>
      <nav class="links">
        <a class="pill" href="index.html">Home</a>
        <a class="pill active" href="quiz.html">Quiz</a>
        <a class="pill" href="resources.html">Study</a>
        <a class="pill" href="notices.html">Notices</a>
      </nav>
    </div>

    <h2 class="title">Quiz</h2>

    <div id="quizBox" class="card">
      <div id="alert" class="alert hidden"></div>
      <div class="qhead">
        <div class="qnum" id="qnum">Question —</div>
        <div class="timer" id="timer"></div>
      </div>
      <div class="qtxt" id="qtxt">Loading…</div>
      <div id="opts"></div>
    </div>

    <!-- Progress row (like your screenshot) -->
    <div class="progressRow">
      <div class="left" id="progressLabel">Showing – / –</div>
      <div class="progBar"><div id="progFill" class="progFill"></div></div>
      <div class="pager">
        <button id="prevBtnTop" class="btn btn-ghost">← Previous</button>
        <span id="pageInfo" class="pageTag">Page 1 / 1</span>
        <button id="nextBtnTop" class="btn">Next →</button>
      </div>
    </div>

    <!-- Sticky control row (keep Show Answer near the card) -->
    <div class="controls">
      <button id="revealBtn" class="btn btn-ghost">Show Answer</button>
    </div>

  </div>

<script>
/* ================== CONFIG ================== */
const SHEET_ID = "16iIOLKAkFzXD1ja7v6b7_ZUKVjbcsswX8LfJ_D0S57o";

/* ================== Utilities ================== */
const $ = sel => document.querySelector(sel);
function stripGVizJSON(txt){ const s = txt.indexOf('{'); const e = txt.lastIndexOf('}'); return JSON.parse(txt.slice(s,e+1)); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
function sample(arr, n){ if(!n || isNaN(n)) return arr.slice(); return shuffle(arr.slice()).slice(0,Math.max(1,Math.min(+n,arr.length))); }

/* ================== State ================== */
const qs = new URLSearchParams(location.search);
const mode = (qs.get("mode")||"").toLowerCase();
const sheet = qs.get("sheet");          // resolved for random
const N     = qs.get("n");              // how many
let idx = 0, data = [], revealed = false;

/* ================== Load Questions ================== */
async function fetchSheetTab(tab){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(tab)}&tq=${encodeURIComponent("select *")}`;
  const res = await fetch(url,{cache:"no-store"});
  if(!res.ok) throw new Error("Failed to load sheet");
  const json = stripGVizJSON(await res.text());
  const cols = json.table.cols.map(c => (c.label||"").toLowerCase());
  const rows = json.table.rows.map(r => (r.c||[]).map(c => (c&&c.v)!=null ? String(c.v) : ""));

  const iQ = cols.findIndex(x=>/question/.test(x));
  const iAns = cols.findIndex(x=>/answer/.test(x));
  const iCorrect = cols.findIndex(x=>/^correct$/.test(x));
  const oi = {
    A: cols.findIndex(x=>/^opta$/i.test(x)),
    B: cols.findIndex(x=>/^optb$/i.test(x)),
    C: cols.findIndex(x=>/^optc$/i.test(x)),
    D: cols.findIndex(x=>/^optd$/i.test(x))
  };
  if(iQ<0) throw new Error("No question column");

  const out = rows.map(r=>{
    const q = (r[iQ]||"").trim();
    const answerText = (iAns>=0 ? r[iAns] : "").trim();
    const correctLetter = (iCorrect>=0 ? (r[iCorrect]||"").trim().toUpperCase() : "");
    const opts = [];
    ["A","B","C","D"].forEach(L => { const ii = oi[L]; if(ii>=0 && r[ii]) opts.push({key:L, txt:r[ii]}); });
    let correctTxt = answerText;
    if(correctLetter && oi[correctLetter]>=0){ correctTxt = r[oi[correctLetter]]; }
    return { q, opts, answer: (correctTxt||"").trim() };
  }).filter(x=>x.q && (x.opts.length || x.answer));

  return out;
}

/* ================== Render & Progress ================== */
function updateProgress(){
  if(!data.length) return;
  const current = idx+1;
  const total = data.length;
  $("#progressLabel").textContent = `Showing ${current} / ${total}`;
  $("#pageInfo").textContent = `Page ${current} / ${total}`;
  const p = (current/total)*100;
  $("#progFill").style.width = `${p}%`;
}

function render(){
  const q = data[idx];
  $("#qnum").textContent = `Question ${idx+1} / ${data.length}`;
  $("#qtxt").textContent = q.q;

  const optsBox = $("#opts");
  optsBox.innerHTML = "";
  const choices = q.opts.length ? q.opts.map(o=>o.txt) : [q.answer]; // fallback if only answer exists
  const shuffled = shuffle(choices.slice());

  shuffled.forEach(txt=>{
    const div = document.createElement("div");
    div.className = "opt";
    div.textContent = txt;
    div.addEventListener("click", ()=>check(div, q.answer));
    optsBox.appendChild(div);
  });

  revealed = false;
  $("#revealBtn").textContent = "Show Answer";
  updateProgress();
}

function check(el, answer){
  if(revealed) return;
  const chosen = el.textContent.trim();
  const isCorrect = chosen === answer;
  el.classList.add(isCorrect ? "correct" : "wrong");
  // also show the correct answer
  [...document.querySelectorAll(".opt")].forEach(opt=>{
    if(opt.textContent.trim() === answer){
      opt.classList.add("correct");
    }
    opt.classList.add("disabled");
  });
  revealed = true;
}

/* ================== Navigation ================== */
function goPrev(){ if(idx>0){ idx--; render(); } }
function goNext(){ if(idx < data.length-1){ idx++; render(); } }

$("#revealBtn").addEventListener("click", ()=>{
  if(revealed) return;
  const ans = data[idx].answer;
  [...document.querySelectorAll(".opt")].forEach(opt=>{
    if(opt.textContent.trim() === ans) opt.classList.add("correct");
    opt.classList.add("disabled");
  });
  revealed = true;
  $("#revealBtn").textContent = "Answer Shown";
});
$("#prevBtnTop").addEventListener("click", goPrev);
$("#nextBtnTop").addEventListener("click", goNext);

/* ================== Timer (optional) ================== */
(function setupTimer(){
  const secs = parseInt(qs.get("timer")||"",10);
  if(!secs || secs<=0){ $("#timer").textContent=""; return; }
  let t = secs;
  const fmt = s => {
    const m = Math.floor(s/60), r = s%60;
    return `${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
  };
  $("#timer").textContent = fmt(t);
  setInterval(()=>{
    if(t>0){ t--; $("#timer").textContent = fmt(t); }
  }, 1000);
})();

/* ================== Boot ================== */
(async function main(){
  if(!sheet){
    $("#alert").classList.remove("hidden");
    $("#alert").textContent = "No category selected.";
    $("#qtxt").textContent = "";
    $("#opts").innerHTML = "";
    return;
  }
  try{
    let items = await fetchSheetTab(sheet);
    if(!items.length) throw 0;
    if(mode === "random") items = sample(items, parseInt(N||"",10));
    data = items;
    render();
  }catch(e){
    $("#alert").classList.remove("hidden");
    $("#alert").textContent = "Failed to load this tab. Make sure the sheet is public and the tab name matches exactly.";
    $("#qtxt").textContent = "";
    $("#opts").innerHTML = "";
  }
})();
</script>
</body>
</html>
