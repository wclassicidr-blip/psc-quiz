<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Quiz — PSC Guru</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="header.css"/>

  <style>
    :root{ --text:#0f2d1f; --muted:#5f726a; --brand:#0f8346; --error:#d24747; --border:rgba(0,0,0,.08); --card:#fff; --shadow:0 30px 60px rgba(30,70,50,.12) }
    @media (prefers-color-scheme: dark){
      :root{ --text:#ecfdf5; --muted:#b8d8cc; --border:rgba(255,255,255,.12); --card:#0c1b13; --shadow:0 30px 60px rgba(0,0,0,.5) }
    }
    body{margin:0;font:400 16px/1.55 Inter,system-ui;background:#f5fbf7;color:var(--text)}
    .wrap{max-width:840px;margin:0 auto;padding:18px 14px 70px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}

    .progress{display:flex;align-items:center;gap:8px;margin:0 0 12px}
    .bar{height:8px;border-radius:8px;background:rgba(15,131,70,.12);overflow:hidden;flex:1}
    .bar>i{display:block;height:100%;width:0%;background:linear-gradient(180deg,#0f8346,#0b5f34);transition:width .25s}

    .qhead{color:var(--muted);font-size:14px;margin:0 0 8px}
    .qtext{font:800 18px/1.3 Inter;margin:0 0 12px}
    .opts{display:grid;gap:10px}
    .opt{border:1px solid var(--border);border-radius:12px;padding:12px 14px;background:#fff;cursor:pointer;user-select:none}
    .opt:hover{box-shadow:0 6px 16px rgba(30,70,50,.10)}
    .opt.correct{border-color:#8bd2a8;background:#ecfff4}
    .opt.wrong{border-color:#f1b6b6;background:#fff4f4}

    .controls{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:800}
    .btn.primary{background:linear-gradient(180deg,#0f8346,#0b5f34);color:#fff;border:none}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .splash{position:fixed;inset:0;display:none;place-items:center;background:rgba(255,255,255,.6);backdrop-filter:blur(6px);z-index:2000}
    @media (prefers-color-scheme:dark){ .splash{ background:rgba(5,10,8,.6) } }
    .splash.on{display:grid}
    .spinner{width:64px;height:64px;border-radius:50%;border:6px solid #e2f2e6;border-top-color:#0f8346;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .notice{padding:12px;border-radius:10px;border:1px solid #f7d6b5;background:#fff7ed;color:#7a4c22}
    table.sum{width:100%;border-collapse:collapse;margin-top:10px}
    table.sum th,table.sum td{border:1px solid var(--border);padding:8px;vertical-align:top}
  </style>
</head>
<body>
  <script defer src="site-header.js"></script>

  <div class="wrap">
    <h2 style="margin:6px 0 10px">Quiz</h2>
    <div id="picked" style="color:var(--muted);font-size:14px;margin-bottom:8px;display:none"></div>

    <div class="progress" id="progressWrap" hidden>
      <div class="bar"><i id="bar"></i></div>
      <div id="pc" style="font-weight:800">0%</div>
      <div id="pg" style="color:var(--muted);font-size:13px">0 / 0</div>
    </div>

    <div class="panel" id="panel"><div class="notice">Loading…</div></div>
    <div class="controls" id="controls" hidden>
      <button id="quit" class="btn">Quit</button>
      <button id="reveal" class="btn">Show Answer</button>
      <button id="next" class="btn primary" disabled>Next →</button>
    </div>
  </div>

  <div class="splash" id="splash"><div class="spinner"></div></div>

  <script>
    // ====== CONFIG (URL overrides supported) ======
    const P = new URLSearchParams(location.search);
    const SHEET_FROM_URL = P.get('sheetId') || null; // optional override
    const GS_SHEET_ID    = SHEET_FROM_URL || 'PUT_YOUR_SHEET_ID_HERE';
    const TRY_CAT_TABS   = Array.from(new Set([
      P.get('tab') || 'Categories',
      'Category','Categories List','Categories_List','Index','Cat'
    ]));
    const AUTO_NEXT_MS = 2000; // auto-advance after 2s

    // Params for quiz mode
    const sheetParam = P.get('sheet');   // target category tab
    const modeParam  = P.get('mode');    // "random"
    const N          = parseInt(P.get('n')||'0',10)||0;

    // UI
    const splash = document.getElementById('splash');
    const panel  = document.getElementById('panel');
    const controls = document.getElementById('controls');
    const revealBtn = document.getElementById('reveal');
    const nextBtn   = document.getElementById('next');
    const quitBtn   = document.getElementById('quit');
    const progressWrap = document.getElementById('progressWrap');
    const bar = document.getElementById('bar');
    const pc  = document.getElementById('pc');
    const pg  = document.getElementById('pg');
    const pickedEl = document.getElementById('picked');

    let i = 0, score = 0, revealed = false;
    let questions = [];
    let pickedInfo = null; // {title, sheet}

    function showSplash(on){ splash.classList.toggle('on', !!on); }
    function stripGVizJSON(txt){ const s=txt.indexOf('{'), e=txt.lastIndexOf('}'); return JSON.parse(txt.slice(s,e+1)); }
    async function gviz(tab){
      const url = `https://docs.google.com/spreadsheets/d/${GS_SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(tab)}&tq=${encodeURIComponent("select *")}`;
      const res = await fetch(url,{cache:"no-store"});
      if(!res.ok) throw new Error(`GViz HTTP ${res.status}`);
      const raw = await res.text(); const json = stripGVizJSON(raw);
      const cols = json.table.cols.map(c => (c.label||"").trim().toLowerCase());
      const rows = json.table.rows.map(r => (r.c||[]).map(c => (c&&c.v)!=null ? String(c.v) : ""));
      return {cols, rows};
    }
    async function gvizFirstAvailable(tabs){
      const tried = [];
      for(const tab of tabs){
        try{const data = await gviz(tab); return {tab, ...data};}
        catch(e){tried.push(`${tab}`);}
      }
      throw new Error(`No accessible Categories tab. Tried: ${tried.join(', ')}`);
    }
    function pickIndex(cols, regexArr){ return cols.findIndex(t => regexArr.some(rx => rx.test(t))); }

    async function chooseRandomCategory(){
      const {tab, cols, rows} = await gvizFirstAvailable(TRY_CAT_TABS);
      const idxName  = pickIndex(cols, [/^name$|^title$|^category$/]);
      const idxSheet = pickIndex(cols, [/sheet|tab|get/]);
      const list = rows.map(r => ({
        title: (r[idxName]||"").trim(),
        sheet: (r[idxSheet]||"").trim()
      })).filter(x => x.title && x.sheet);
      if(!list.length) throw new Error("No categories in the sheet");
      return list[Math.floor(Math.random()*list.length)];
    }

    function normalizeQuestions(cols, rows){
      const idxQ = pickIndex(cols, [/question|ques/]);
      const idxA = pickIndex(cols, [/^a$|opt.?1|option.?1/]);
      const idxB = pickIndex(cols, [/^b$|opt.?2|option.?2/]);
      const idxC = pickIndex(cols, [/^c$|opt.?3|option.?3/]);
      const idxD = pickIndex(cols, [/^d$|opt.?4|option.?4/]);
      const idxAns = pickIndex(cols, [/ans|answer|correct/]);

      const entries = [];
      rows.forEach(r=>{
        const q = (r[idxQ]||"").trim();
        const a = (r[idxA]||"").trim();
        const b = (r[idxB]||"").trim();
        const c = (idxC>-1 ? (r[idxC]||"").trim() : "");
        const d = (idxD>-1 ? (r[idxD]||"").trim() : "");
        let ans = (idxAns>-1 ? (r[idxAns]||"").trim() : "");
        if(!q || !a || !b) return;

        const opts = [a,b,c,d].filter(Boolean);
        let correct = -1;
        if (/^[1-4]$/.test(ans)) correct = parseInt(ans,10)-1;
        else if (/^[A-D]$/i.test(ans)) correct = ans.toUpperCase().charCodeAt(0)-65;
        else correct = Math.max(0, opts.findIndex(o => o && o.toLowerCase()===ans.toLowerCase()));
        if (correct < 0 || correct >= opts.length) correct = 0;

        entries.push({ q, opts, correct });
      });
      return entries;
    }

    function sliceN(arr, n){
      if(!n || n>=arr.length) return arr;
      const copy = [...arr], out=[];
      while(out.length<n && copy.length){
        out.push(copy.splice(Math.floor(Math.random()*copy.length),1)[0]);
      }
      return out;
    }

    function updateProgress(){
      const pct = Math.round((i / questions.length) * 100);
      bar.style.width = pct+'%';
      pc.textContent = pct+'%';
      pg.textContent = (i+1)+' / '+questions.length;
    }

    function render(){
      const q = questions[i];
      if(!q){ panel.innerHTML='<div class="notice">No questions.</div>'; return; }

      progressWrap.hidden = false;
      updateProgress();

      revealed = false;
      nextBtn.disabled = true;

      panel.innerHTML = `
        <div class="qhead">Question ${i+1}</div>
        <div class="qtext">${q.q}</div>
        <div class="opts">
          ${q.opts.map((t,idx)=>`<div class="opt" data-idx="${idx}">${t}</div>`).join("")}
        </div>
      `;

      let autoTimer = null;

      panel.querySelectorAll('.opt').forEach(el=>{
        el.addEventListener('click', ()=>{
          if(revealed) return;
          const idx = parseInt(el.dataset.idx,10);
          if(idx===q.correct){ score++; el.classList.add('correct'); }
          else{ el.classList.add('wrong'); panel.querySelector(`.opt[data-idx="${q.correct}"]`)?.classList.add('correct'); }
          revealed = true;
          nextBtn.disabled = false;

          // Auto-advance after 2s
          autoTimer = setTimeout(()=>{
            if(i<questions.length-1){ i++; render(); }
            else summary();
          }, AUTO_NEXT_MS);
        }, {once:true});
      });

      nextBtn.onclick = ()=>{
        if(autoTimer) { clearTimeout(autoTimer); autoTimer = null; }
        if(i<questions.length-1){ i++; render(); }
        else summary();
      };
    }

    function summary(){
      progressWrap.hidden = true;
      controls.hidden = true;
      panel.innerHTML = `
        <div class="qtext">Summary</div>
        <p class="qhead">Score: <b>${score}</b> / ${questions.length}</p>
        <p><a class="btn" href="/">Home</a> <a class="btn" href="quiz.html${pickedInfo ? `?sheet=${encodeURIComponent(pickedInfo.sheet)}&sheetId=${encodeURIComponent(GS_SHEET_ID)}` : ''}">Play again</a></p>
      `;
    }

    revealBtn.addEventListener('click', ()=>{
      if(revealed) return;
      const q = questions[i];
      panel.querySelector(`.opt[data-idx="${q.correct}"]`)?.classList.add('correct');
      revealed = true;
      nextBtn.disabled = false;
    });
    quitBtn.addEventListener('click', summary);

    async function boot(){
      try{
        showSplash(true);
        controls.hidden = true;

        if(sheetParam){
          pickedInfo = { title: '', sheet: sheetParam };
        } else if (modeParam === 'random'){
          pickedInfo = await chooseRandomCategory();
        }

        if(!pickedInfo){
          panel.innerHTML = `<div class="notice">No category selected. Open from Home or use Random Quiz.</div>`;
          return;
        }

        if(pickedInfo.title){
          pickedEl.style.display = 'block';
          pickedEl.textContent = `Random picked: ${pickedInfo.title}`;
        }

        const {cols, rows} = await gviz(pickedInfo.sheet);
        let data = normalizeQuestions(cols, rows);
        data = N ? sliceN(data, N) : data;

        if(!data.length){
          panel.innerHTML = `<div class="notice">No questions found in “${pickedInfo.sheet}”.</div>`;
          return;
        }

        questions = data;
        i = 0; score = 0;
        controls.hidden = false;
        render();
      } catch(err){
        console.error(err);
        panel.innerHTML = `<div class="notice">Failed to load questions. Check sharing (Anyone with link: Viewer), Sheet ID, and tab name.</div>`;
      } finally{
        showSplash(false);
      }
    }

    boot();
  </script>
</body>
</html>
