<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiz — PSC Guru</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f2f8f4; --bg-2:#eaf4ef; --text:#0f2d1f; --muted:#5f726a;
      --brand:#0f8346; --brand-600:#0b5f34; --shadow:0 20px 40px rgba(30,70,50,.15);
      --glass-2:rgba(255,255,255,.85); --ring:rgba(15,131,70,.22);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font:400 16px/1.55 Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, #eaf8f1, transparent),
        radial-gradient(1200px 700px at 80% -10%, #dff6ef, transparent),
        linear-gradient(180deg, #f2f8f4, #eaf4ef);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:22px 18px 72px}

    /* top bar (same as home) */
    .bar{display:flex;gap:14px;align-items:center;margin-bottom:22px}
    .brand{
      display:flex;align-items:center;gap:12px;padding:8px 10px;border-radius:14px;
      background:var(--glass-2); backdrop-filter: blur(10px); box-shadow: var(--shadow);
    }
    .logo{height:38px;width:38px;border-radius:12px;display:grid;place-items:center;
      font-weight:900;color:#fff;background:linear-gradient(160deg,#0dcf8b,#0b8f6b);}
    .brand h1{font-size:18px;margin:0;font-weight:800}
    .brand small{display:block;margin-top:-2px;font-size:12px;color:var(--muted);font-weight:600}
    .links{margin-left:auto;display:flex;gap:10px}
    .pill{padding:8px 14px;border-radius:999px;background:var(--glass-2);backdrop-filter:blur(8px);
      font-weight:700;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.05);text-decoration:none;color:var(--text)}
    .pill.active{background:#e7f6ee;border-color:#cfead9}

    h2{margin:8px 0 18px}

    .q-card{
      background:var(--glass-2); border:1px solid rgba(0,0,0,.06);
      box-shadow:var(--shadow); border-radius:18px; padding:18px;
    }
    .opts{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .opt{
      padding:12px 14px;border-radius:12px;border:1px solid rgba(0,0,0,.08); background:white;
      cursor:pointer; font-weight:600;
    }
    .opt.wrong{background:#fff5f5;border-color:#ffcfcf}
    .opt.right{background:#eefcf4;border-color:#a6e8c6}
    .toolbar{display:flex;gap:12px;align-items:center;justify-content:flex-end;margin:14px 0}
    .btn{display:inline-flex;gap:8px;align-items:center;border:none;border-radius:12px;padding:10px 14px;
      background:linear-gradient(180deg,var(--brand),var(--brand-600));color:#062016;font-weight:900;box-shadow:0 10px 25px var(--ring);cursor:pointer}
    .btn-ghost{background:white;border:1px solid rgba(0,0,0,.08);color:var(--text)}
    .muted{color:var(--muted);font-weight:700}

    /* Splash (reused) */
    #splash{position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center; flex-direction:column;
      background:radial-gradient(1200px 700px at 20% -10%, #eaf8f1, transparent), radial-gradient(1200px 700px at 80% -10%, #dff6ef, transparent),
      linear-gradient(180deg, #f2f8f4, #eaf4ef); transition: opacity .35s ease; opacity:1;}
    #splash.hide{opacity:0; pointer-events:none}
    .splash-card{display:flex;flex-direction:column;align-items:center;gap:14px; padding:22px;border-radius:16px;background:var(--glass-2);
      box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.05)}
    .splash-logo{height:44px;width:44px;border-radius:14px;display:grid;place-items:center;font-weight:900;color:#fff;background:linear-gradient(160deg,#0dcf8b,#0b8f6b)}
    .spinner{width:30px;height:30px;border-radius:50%;border:3px solid rgba(15,131,70,.18);border-top-color:#0f8346;animation:spin 1s linear infinite}
    .splash-msg{margin:0;color:#5f726a;font-weight:700}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <!-- Splash overlay -->
  <div id="splash" aria-live="polite" aria-busy="true">
    <div class="splash-card">
      <div class="splash-logo">PSC</div>
      <h3 class="splash-title">PSC Guru</h3>
      <div class="spinner" aria-hidden="true"></div>
      <p id="splashMsg" class="splash-msg">Loading questions…</p>
    </div>
  </div>

  <div class="wrap">
    <!-- Same header as home -->
    <div class="bar">
      <div class="brand">
        <div class="logo">PSC</div>
        <div>
          <h1>PSC Guru</h1>
          <small>Kerala PSC Exam Prep</small>
        </div>
      </div>
      <nav class="links">
        <a class="pill" href="index.html">Home</a>
        <a class="pill active" href="quiz.html">Quiz</a>
        <a class="pill" href="resources.html">Study</a>
        <a class="pill" href="notices.html">Notices</a>
      </nav>
    </div>

    <h2>Quiz</h2>

    <div class="toolbar">
      <button id="prevBtn" class="btn btn-ghost">← Prev</button>
      <button id="revealBtn" class="btn btn-ghost">Show Answer</button>
      <button id="nextBtn" class="btn">Next →</button>
    </div>

    <div class="q-card" id="qCard">
      <div class="muted" id="qMeta">Loading…</div>
      <h3 id="qTitle" style="margin:10px 0 0">—</h3>
      <div class="opts" id="opts"></div>
    </div>
  </div>

  <script>
    /* ==== same sheet config ==== */
    const GS_SHEET_ID = "16iIOLKAkFzXD1ja7v6b7_ZUKVjbcsswX8LfJ_D0S57o";
    const GS_PUB_EKEY = "2PACX-1vR4PuWTfq2838_kUaKcwmeWlKb5OtEmL6YqUX4DjPcrb6EaJfW-monSIqbZTiI3ZFrE6GBFHaP7k95A";
    const CATEGORIES_TAB = "Categories";

    /* ==== splash helpers ==== */
    const splash = document.getElementById('splash');
    const splashMsg = document.getElementById('splashMsg');
    let splashSlowTimer;
    function showSplash(msg="Loading questions…"){
      splashMsg.textContent = msg;
      splash.classList.remove('hide');
      clearTimeout(splashSlowTimer);
      splashSlowTimer = setTimeout(()=>{
        if(!splash.classList.contains('hide')){
          splashMsg.textContent = "Still loading… network might be slow.";
        }
      },5500);
    }
    function hideSplash(){
      clearTimeout(splashSlowTimer);
      splash.classList.add('hide');
    }

    /* ==== helpers to read sheets ==== */
    function stripGVizJSON(txt){ const s=txt.indexOf('{'), e=txt.lastIndexOf('}'); return JSON.parse(txt.slice(s,e+1)); }
    async function gviz(tab){
      const url = `https://docs.google.com/spreadsheets/d/${GS_SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(tab)}&tq=${encodeURIComponent("select *")}`;
      const res = await fetch(url,{cache:"no-store"}); if(!res.ok) throw new Error("GViz fetch failed");
      const raw = await res.text(); const json = stripGVizJSON(raw);
      const cols = json.table.cols.map(c => (c.label||"").trim());
      const rows = json.table.rows.map(r => (r.c||[]).map(c => (c&&c.v)!=null ? String(c.v) : ""));
      return {cols, rows};
    }
    async function pubCsv(tab){
      const url = `https://docs.google.com/spreadsheets/d/e/${GS_PUB_EKEY}/pub?output=csv&sheet=${encodeURIComponent(tab)}`;
      const res = await fetch(url,{cache:"no-store"}); if(!res.ok) throw new Error("CSV fetch failed");
      return await res.text();
    }
    function parseCSV(text){
      const lines = text.split(/\r?\n/).filter(Boolean);
      const head  = lines.shift().split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(v=>v.replace(/^"|"$/g,"").trim());
      const rows  = lines.map(l=>l.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(v=>v.replace(/^"|"$/g,"")));
      const h = head.map(x=>(x||"").toLowerCase());
      const qi = h.findIndex(v=>/question|q\b/i.test(v));
      const ai = h.findIndex(v=>/answer|ans\b/i.test(v));
      const oi = h.map((v,i)=>(/opt|choice|option/.test(v) && i!==ai) ? i : -1).filter(i=>i>=0);
      return rows.map(r=>({
        q: r[qi]||"",
        a: r[ai]||"",
        opts: oi.map(i=>r[i]).filter(Boolean)
      })).filter(x=>x.q && (x.a || x.opts.length));
    }

    /* ==== quiz state ==== */
    let questions = []; let idx = 0; let locked = false;

    function render(){
      const q = questions[idx];
      document.getElementById('qMeta').textContent = `Question ${idx+1} / ${questions.length}`;
      document.getElementById('qTitle').textContent = q.q;

      const optsWrap = document.getElementById('opts');
      optsWrap.innerHTML = "";

      // mix correct with opts if answer not among options
      let options = q.opts.slice();
      if(q.a && !options.includes(q.a)) options.push(q.a);
      // shuffle
      options.sort(()=>Math.random()-0.5);

      options.forEach(text=>{
        const b = document.createElement('button');
        b.className = "opt";
        b.textContent = text;
        b.onclick = ()=>{
          if(locked) return;
          locked = true;
          if(text === q.a){
            b.classList.add('right');
          }else{
            b.classList.add('wrong');
            // also mark right
            [...optsWrap.children].forEach(el=>{
              if(el.textContent === q.a) el.classList.add('right');
            });
          }
        };
        optsWrap.appendChild(b);
      });

      locked = false;
    }

    document.getElementById('prevBtn').onclick = ()=>{
      if(idx>0){ idx--; render(); }
    };
    document.getElementById('nextBtn').onclick = ()=>{
      if(idx<questions.length-1){ idx++; render(); }
    };
    document.getElementById('revealBtn').onclick = ()=>{
      const q = questions[idx];
      [...document.querySelectorAll('.opt')].forEach(el=>{
        if(el.textContent === q.a) el.classList.add('right');
        else el.classList.add('wrong');
      });
      locked = true;
    };

    async function pickRandomSheet(){
      // try CSV list first
      try{
        const csv = await pubCsv(CATEGORIES_TAB);
        const items = parseCSV(csv); // returns [{q,a,opts}] here? No—we only need names; but Categories CSV has columns [name, sheet, desc]
        // QUICK parse for (name, sheet) from raw CSV header:
        const lines = csv.split(/\r?\n/).filter(Boolean);
        const head = lines[0].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(v=>v.replace(/^"|"$/g,"").toLowerCase());
        const nameIdx = head.findIndex(h=>/name/.test(h));
        const tabIdx  = head.findIndex(h=>/(sheet|get|tab)/.test(h));
        const rows = lines.slice(1).map(l=>l.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(v=>v.replace(/^"|"$/g,"")));
        const cats = rows.map(r=>({name:r[nameIdx]||r[tabIdx]||"", sheet:r[tabIdx]||r[nameIdx]||""})).filter(x=>x.sheet);
        return cats[Math.floor(Math.random()*cats.length)];
      }catch(e){
        const {cols, rows} = await gviz(CATEGORIES_TAB);
        const h = cols.map(c=>(c||"").toLowerCase());
        const nameIdx = h.findIndex(v=>/name/.test(v));
        const tabIdx  = h.findIndex(v=>/(sheet|get|tab)/.test(v));
        const cats = rows.map(r=>({name:r[tabIdx]||r[nameIdx]||"", sheet:r[tabIdx]||r[nameIdx]||""})).filter(x=>x.sheet);
        return cats[Math.floor(Math.random()*cats.length)];
      }
    }

    async function init(){
      showSplash("Loading questions…");

      try{
        const p = new URLSearchParams(location.search);
        let sheet = p.get('sheet');
        const mode = p.get('mode');
        const n = p.get('n');

        if(mode === 'random' || (!sheet && !mode)){
          const chosen = await pickRandomSheet();
          sheet = chosen?.sheet;
        }
        if(!sheet) throw new Error("No category selected.");

        // fetch questions from sheet
        const {cols, rows} = await gviz(sheet);
        // map to {q, a, opts}
        const head = cols.map(c=>(c||"").toLowerCase());
        const qi = head.findIndex(v=>/question|q\b/i.test(v));
        const ai = head.findIndex(v=>/answer|ans\b/i.test(v));
        const oi = head.map((v,i)=>(/opt|choice|option/.test(v) && i!==ai) ? i : -1).filter(i=>i>=0);
        questions = rows.map(r=>({
          q: r[qi]||"",
          a: r[ai]||"",
          opts: oi.map(i=>r[i]).filter(Boolean)
        })).filter(x=>x.q && (x.a || x.opts.length));

        // limit to n if needed
        let count = (n && n !== 'N') ? Number(n) : questions.length;
        if(Number.isFinite(count) && count > 0) {
          // random sample
          questions = questions.sort(()=>Math.random()-0.5).slice(0, count);
        }

        idx = 0;
        render();
      } catch(e){
        console.error(e);
        document.getElementById('qTitle').textContent = "No category selected.";
        document.getElementById('opts').innerHTML = "";
      } finally {
        hideSplash();
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
