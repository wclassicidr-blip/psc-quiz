<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiz — PSC Guru</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="header.css">
  <script defer src="site-header.js"></script>

  <style>
    :root{ --text:#0f2d1f; --muted:#5f726a; --brand:#0f8346; --error:#d24747;
      --card:#fff; --shadow:0 20px 40px rgba(30,70,50,.15);
      --border: rgba(0,0,0,.06); --bg:#f5fbf7; }
    *{box-sizing:border-box} body{margin:0;font:400 16px/1.55 Inter,system-ui;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:22px 16px 60px}
    .title{font-weight:800;font-size:28px;margin:6px 0 14px}
    .progress-wrap{display:flex;align-items:center;gap:12px;margin:6px 0 12px}
    .progress{height:8px;background:#e7f3ec;border-radius:999px;flex:1;overflow:hidden}
    .bar{height:100%;width:0;background:#b8e5cc;border-radius:999px;transition:width .3s ease}
    .paging{color:var(--muted);font-weight:800}
    .qcard{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .qhead{color:var(--muted);font-size:14px;margin-bottom:8px}
    .qtext{font-size:18px;font-weight:700;margin:6px 0 12px}
    .opts{display:grid;gap:10px}
    .opt{border:1px solid var(--border);border-radius:12px;padding:12px 14px;background:#fff;cursor:pointer; user-select:none;}
    .opt:hover{box-shadow:0 6px 16px rgba(30,70,50,.10)}
    .opt.correct{border-color:#8bd2a8;background:#ecfff4}
    .opt.wrong{border-color:#f1b6b6;background:#fff4f4}
    .controls{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:800}
    .btn.primary{background:linear-gradient(180deg,#0f8346,#0b5f34);color:#fff;border:none}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .splash{position:fixed;inset:0;display:none;place-items:center;background:rgba(255,255,255,.6);backdrop-filter:blur(6px);z-index:2000}
    .splash.on{display:grid}
    .spinner{width:64px;height:64px;border-radius:50%;border:6px solid #d9f2e6;border-top-color:#0f8346;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .notice{padding:12px;border-radius:10px;border:1px solid #f7d6b5;background:#fff7ed;color:#7a4c22}
  </style>
</head>
<body>
  <!-- shared sticky header -->
  <header class="site-header">
    <div class="header-inner">
      <a href="index.html" class="site-brand" aria-label="PSC Guru Home">
        <div class="site-logo">PSC</div>
        <div>
          <h1>PSC Guru</h1>
          <small>Kerala PSC Exam Prep</small>
        </div>
      </a>

      <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false" aria-controls="primaryNav">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
        </svg>
      </button>

      <nav id="primaryNav" class="site-nav" aria-label="Primary">
        <a href="index.html">Quiz</a>
        <a href="resources.html">Study</a>
        <a href="notices.html">Notices</a>
      </nav>
    </div>
  </header>

  <div class="wrap">
    <h1 class="title">Quiz</h1>

    <div class="progress-wrap" id="progressWrap" hidden>
      <div class="progress"><div class="bar" id="bar"></div></div>
      <span class="paging" id="paging">Page 1 / 1</span>
    </div>

    <div id="panel"></div>

    <div class="controls" id="controls" hidden>
      <button class="btn" id="prevBtn">← Previous</button>
      <button class="btn" id="revealBtn">Show Answer</button>
      <button class="btn primary" id="nextBtn">Next →</button>
    </div>
  </div>

  <div class="splash" id="splash"><div class="spinner" aria-label="Loading"></div></div>

  <script>
    /* ================== CONFIG ================== */
    const GS_SHEET_ID = "16iIOLKAkFzXD1ja7v6b7_ZUKVjbcsswX8LfJ_D0S57o"; // main workbook
    const GS_PUB_EKEY = "2PACX-1vR4PuWTfq2838_kUaKcwmeWlKb5OtEmL6YqUX4DjPcrb6EaJfW-monSIqbZTiI3ZFrE6GBFHaP7k95A";
    const CATEGORIES_TAB = "Categories";
    const DEBUG = false;

    // DOM
    const $ = s => document.querySelector(s);
    const panel = $('#panel'), splash = $('#splash'), bar = $('#bar'), paging = $('#paging');
    const progressWrap = $('#progressWrap'), prevBtn = $('#prevBtn'), nextBtn = $('#nextBtn'), revealBtn = $('#revealBtn'), controls = $('#controls');

    // URL params
    const params = new URLSearchParams(location.search);
    const sheetParam = params.get('sheet');
    const mode = params.get('mode');
    const N = params.get('n');

    let questions = [], i = 0, score = 0, revealed = false;

    const showSplash = on => splash.classList.toggle('on', !!on);

    /* ================== GViz helpers ================== */
    function stripGVizJSON(txt){ const s=txt.indexOf('{'), e=txt.lastIndexOf('}'); return JSON.parse(txt.slice(s,e+1)); }

    // token can be tab name, gid, or full URL to any Sheet (with optional #gid=)
    function parseSheetToken(token){
      const out = { sheetId: GS_SHEET_ID, sheetName: null, gid: null };
      if(!token) return out;
      const t = token.trim();
      const m = t.match(/https?:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)\/(?:[^#]*)?(?:#gid=(\d+))?/);
      if(m){ out.sheetId = m[1]; if(m[2]) out.gid = m[2]; return out; }
      if(/^\d+$/.test(t)){ out.gid = t; return out; }                  // plain gid
      const mg = t.match(/gid=(\d+)/); if(mg){ out.gid = mg[1]; return out; }
      out.sheetName = t;                                                // tab name
      return out;
    }

    async function gvizFetch(token){
      const {sheetId, sheetName, gid} = parseSheetToken(token);
      let url;
      if(gid) url = \`https://docs.google.com/spreadsheets/d/\${sheetId}/gviz/tq?gid=\${gid}&tq=\${encodeURIComponent("select *")}\`;
      else    url = \`https://docs.google.com/spreadsheets/d/\${sheetId}/gviz/tq?sheet=\${encodeURIComponent(sheetName||"Sheet1")}&tq=\${encodeURIComponent("select *")}\`;
      const res = await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error("GViz fetch failed");
      const raw = await res.text(); const json = stripGVizJSON(raw);
      const cols = json.table.cols.map(c => (c.label || "").trim().toLowerCase());
      const rows = json.table.rows.map(r => (r.c||[]).map(c => (c && c.v)!=null ? String(c.v) : ""));
      if(DEBUG) console.log("gvizFetch cols:", cols.slice(0,8));
      return {cols, rows};
    }

    /* ================== Categories (for random) ================== */
    function splitCSV(line){
      const re = /(?:[^,"\\]|\\.|"(?:\\.|[^"])*")+/g;
      return (line.match(re)||[]).map(s=>s.replace(/^"|"$/g,"").trim());
    }
    function parseCSV(text){
      const lines = text.split(/\r?\n/).filter(Boolean);
      if(!lines.length) return {head:[],rows:[]};
      const head = splitCSV(lines.shift());
      const rows = lines.map(splitCSV);
      return {head,rows};
    }
    const norm = s => (s||"").toLowerCase();

    async function getCategories(){
      // Try publish-to-web (CSV)
      if(GS_PUB_EKEY){
        try{
          const url = \`https://docs.google.com/spreadsheets/d/e/\${GS_PUB_EKEY}/pub?output=csv&sheet=\${encodeURIComponent(CATEGORIES_TAB)}\`;
          const r = await fetch(url,{cache:"no-store"});
          if(r.ok){
            const txt = await r.text();
            const {head,rows} = parseCSV(txt);
            const h = head.map(norm);
            let idxName = h.findIndex(x=> x.startsWith("name"));
            let idxTab  = h.findIndex(x=> x.includes("get") || x.includes("sheet") || x.includes("tab"));
            if(idxName<0) idxName = 0;
            if(idxTab<0)  idxTab  = Math.min(1, head.length-1);
            const items = rows.map(r=>({name:r[idxName]||"", sheet:r[idxTab]||""})).filter(x=>x.name || x.sheet);
            if(items.length) return items;
          }
        }catch(e){ if(DEBUG) console.warn("CSV categories failed", e); }
      }
      // Fallback GViz (same workbook)
      const {cols, rows} = await gvizFetch(CATEGORIES_TAB);
      const idxName = cols.findIndex(x=> x.startsWith("name"));
      const idxTab  = cols.findIndex(x=> /(get|sheet|tab)/.test(x));
      return rows.map(r=>({name:r[idxName]||"", sheet:r[idxTab]||""})).filter(x=>x.name || x.sheet);
    }

    async function chooseRandomToken(){
      const items = await getCategories();
      if(!items.length) throw new Error("No categories");
      const token = (items[Math.floor(Math.random()*items.length)].sheet || "").trim() || items[0].name;
      if(DEBUG) console.log("Random token:", token);
      return token;
    }

    /* ================== Question mapping (tolerant) ================== */
    function idx(cols, preds){
      for(const p of preds){
        let k = cols.findIndex(c => c === p); if(k>-1) return k;
      }
      for(const p of preds){
        let k = cols.findIndex(c => c.includes(p)); if(k>-1) return k;
      }
      return -1;
    }

    function mapToQuestionsSmart(cols, rows){
      // candidates
      let iQ   = idx(cols, ["question","ques","q","question text","questiontext"]);
      let iA   = idx(cols, ["answer","ans","key","correct","correct answer","solution"]);
      let iA1    = idx(cols, ["opta","a","option a","choice a"]);
      let iB1    = idx(cols, ["optb","b","option b","choice b"]);
      let iC1    = idx(cols, ["optc","c","option c","choice c"]);
      let iD1    = idx(cols, ["optd","d","option d","choice d"]);

      // positional fallback if headers empty
      if(iQ<0 && cols.length>=1)  iQ = 0;
      if(iA1<0 && cols.length>=2) iA1 = 1;
      if(iB1<0 && cols.length>=3) iB1 = 2;
      if(iC1<0 && cols.length>=4) iC1 = 3;
      if(iD1<0 && cols.length>=5) iD1 = 4;
      if(iA<0  && cols.length>=6) iA  = 5;

      const optIdx = [iA1,iB1,iC1,iD1].filter(x=> x>-1);

      function clean(s){ return (s||"").trim(); }
      function answerIndex(ans, opts){
        const a = clean(ans);
        if(!a) return -1;
        const u = a.toUpperCase();
        if(["A","B","C","D"].includes(u)) return "ABCD".indexOf(u);
        if(/^[1-4]$/.test(u)) return Number(u)-1;
        return opts.findIndex(o => o.toLowerCase() === a.toLowerCase());
      }

      const out = [];
      for(const r of rows){
        const q = clean(r[iQ]);
        const opts = optIdx.map(ix => clean(r[ix])).filter(Boolean);
        const ansCell = clean(r[iA]);
        if(!q || opts.length<2) continue;

        let correct = answerIndex(ansCell, opts);
        if(correct<0) correct = 0; // fallback

        // shuffle while preserving correct index
        const pairs = opts.map((t,idx)=>({t,idx}));
        for(let k=pairs.length-1;k>0;k--){ const j=Math.floor(Math.random()*(k+1)); [pairs[k],pairs[j]]=[pairs[j],pairs[k]]; }
        const newOpts = pairs.map(p=>p.t);
        const newCorrect = pairs.findIndex(p=>p.idx===correct);

        out.push({ q, opts:newOpts, correct:newCorrect });
      }
      if(DEBUG) console.log(`Mapped ${out.length} questions (from ${rows.length} rows)`);
      return out;
    }

    /* ================== UI ================== */
    function render(){
      if(!questions.length){
        panel.innerHTML = \`<div class="notice">No questions available for this category.<br>Tip: make sure the sheet has columns like <b>Question, A, B, C, D, Answer</b> (or similar).</div>\`;
        controls.hidden = true; progressWrap.hidden = true; return;
      }
      const q = questions[i];
      progressWrap.hidden = false;
      bar.style.width = \`\${((i+1)/questions.length)*100}%\`;
      paging.textContent = \`Page \${i+1} / \${questions.length}\`;

      panel.innerHTML = \`
        <div class="qcard">
          <div class="qhead">Question \${i+1} / \${questions.length}</div>
          <div class="qtext"></div>
          <div class="opts">\${q.opts.map((o,idx)=>\`<div class="opt" data-idx="\${idx}"></div>\`).join("")}</div>
        </div>
      \`;
      // textContent to avoid HTML being interpreted
      panel.querySelector(".qtext").textContent = q.q;
      panel.querySelectorAll(".opt").forEach((el,idx)=>{ el.textContent = q.opts[idx]; });

      controls.hidden = false;
      prevBtn.disabled = i===0;
      nextBtn.textContent = (i===questions.length-1) ? 'Finish →' : 'Next →';
      revealed = false;

      panel.querySelectorAll('.opt').forEach(el=>{
        el.addEventListener('click', ()=>{
          if(revealed) return;
          const sel = Number(el.dataset.idx);
          if(sel === q.correct){ el.classList.add('correct'); score++; }
          else{
            el.classList.add('wrong');
            panel.querySelector(\`.opt[data-idx="\${q.correct}"]\`)?.classList.add('correct');
          }
          revealed = true;
        });
      });
    }

    prevBtn.addEventListener('click', ()=>{ if(i>0){ i--; render(); } });
    nextBtn.addEventListener('click', ()=>{ if(i<questions.length-1){ i++; render(); } else summary(); });
    revealBtn.addEventListener('click', ()=>{ if(revealed) return; panel.querySelector(\`.opt[data-idx="\${questions[i].correct}"]\`)?.classList.add('correct'); revealed = true; });

    function summary(){
      progressWrap.hidden = true; controls.hidden = true;
      panel.innerHTML = \`
        <div class="qcard">
          <div class="qtext">Summary</div>
          <p class="qhead">Score: <b>\${score}</b> / \${questions.length}</p>
          <p>Refresh or go back to play again.</p>
        </div>
      \`;
    }

    /* ================== Boot ================== */
    async function boot(){
      try{
        showSplash(true);
        let token = sheetParam;
        if(!token && mode === 'random'){ token = await chooseRandomToken(); }
        if(!token){ showSplash(false); panel.innerHTML = \`<div class="notice">No category selected.</div>\`; return; }

        const {cols, rows} = await gvizFetch(token);
        let qs = mapToQuestionsSmart(cols, rows);
        // randomize + sample
        qs = qs.sort(()=>Math.random()-0.5);
        if(N && String(N).toUpperCase()!=='N') qs = qs.slice(0, Math.max(1, Math.min(qs.length, Number(N)||5)));

        questions = qs; i = 0; score = 0;
        render();
      } catch (err){
        console.error(err);
        panel.innerHTML = \`<div class="notice">Failed to load questions. Check sheet access / names.</div>\`;
      } finally {
        showSplash(false);
      }
    }

    boot();
  </script>
</body>
</html>
