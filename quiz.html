<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PSC Guru • Quiz</title>
<style>
  :root{--bg:#f2f8f4;--card:#fff;--ink:#113b2f;--muted:#58736c;--accent:#0fa66d;--accent-weak:#c8efe2;--line:#e6eee9}
  *{box-sizing:border-box} html,body{margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  .row{display:flex;gap:10px;align-items:center}
  .right{margin-left:auto}
  .pill{background:#fff;border:1px solid var(--line);border-radius:999px;padding:6px 12px;text-decoration:none;color:var(--ink)}
  h1{margin:10px 0 16px}
  .alert{background:#fff9e8;border:1px solid #f6e2b0;color:#5f4a00;padding:10px 12px;border-radius:10px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
  .btn{background:#fff;border:1px solid var(--line);border-radius:10px;height:36px;padding:0 12px;display:inline-flex;align-items:center;gap:8px;cursor:pointer}
  .btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  .opt{border:1px solid var(--line);border-radius:12px;padding:12px;cursor:pointer}
  .opt.correct{border-color:#1f7c59;background:#eaf8f2}
  .opt.wrong{border-color:#c73b3b;background:#fdeeee}
  .stickybar{position:sticky;bottom:0;background:rgba(242,248,244,.9);backdrop-filter:saturate(160%) blur(3px);border-top:1px solid var(--line);padding:10px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <a class="pill" href="index.html">Home</a>
    <a class="pill" href="quiz.html">Quiz</a>
    <div class="right pill" id="timerBox">00:00</div>
  </div>

  <h1 id="title">Quiz</h1>
  <div id="warn"></div>
  <div id="qwrap" class="card" style="display:none">
    <div id="qtext" style="font-weight:700"></div>
    <div style="height:8px"></div>
    <div id="opts" class="grid"></div>
    <div style="height:8px"></div>
    <button id="showAnswer" class="btn">Show Answer</button>
  </div>

  <div class="stickybar">
    <div class="row" style="justify-content:space-between">
      <button id="prev" class="btn">← Prev</button>
      <span id="page" class="pill">1 / 1</span>
      <button id="next" class="btn btn-primary">Next →</button>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const GS_SHEET_ID = "16iIOLKAkFzXD1ja7v6b7_ZUKVjbcsswX8LfJ_D0S57o";

/* ===== utilities ===== */
const norm = s => (s ?? '').toString().normalize('NFKC').replace(/\u00A0/g,' ').trim();
const low  = s => norm(s).toLowerCase();
async function fetchText(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(r.statusText); return r.text();}
function parseCSV(t){const R=[];let i=0,f='',r=[],q=false;const pf=()=>{r.push(f);f='';};const pr=()=>{R.push(r);r=[];};while(i<t.length){const c=t[i];if(q){if(c=='"'&&t[i+1]=='"'){f+='"';i+=2;continue}if(c=='"'){q=false;i++;continue}f+=c;i++;continue}if(c=='"'){q=true;i++;continue}if(c==','){pf();i++;continue}if(c=='\r'){i++;continue}if(c=='\n'){pf();pr();i++;continue}f+=c;i++}pf();pr();while(R.length&&R[R.length-1].every(c=>low(c)===''))R.pop();return R;}
async function discoverPublishedEid(sheetId){const h=await fetchText(`https://docs.google.com/spreadsheets/d/${sheetId}/pubhtml`);const m=h.match(/https:\/\/docs\.google\.com\/spreadsheets\/d\/e\/([a-zA-Z0-9_-]+)\/pubhtml/);return m?m[1]:null;}
async function fetchCSVByGidRobust(sheetId,gid){
  try{const u=`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${gid}`;const t=await fetchText(u);const rows=parseCSV(t);if(rows.length)return rows;}catch{}
  try{const eid=await discoverPublishedEid(sheetId);if(eid){const u=`https://docs.google.com/spreadsheets/d/e/${eid}/pub?gid=${gid}&single=true&output=csv`;const t=await fetchText(u);const rows=parseCSV(t);if(rows.length)return rows;}}catch{}
  const u=`https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;const t=await fetchText(u);return parseCSV(t);
}
async function getGidByName(sheetId,name){
  const html=await fetchText(`https://docs.google.com/spreadsheets/d/${sheetId}/pubhtml`);
  const re=/<a[^>]+href="[^"]*#gid=(\d+)"[^>]*>([\s\S]*?)<\/a>/gi; let m;
  while((m=re.exec(html))){
    const gid=m[1];
    const label=m[2].replace(/<[^>]*>/g,'').replace(/&nbsp;/g,' ').replace(/&amp;/g,'&').trim();
    if(label===name) return gid;
  }
  return null;
}

/* ===== map rows to Qs ===== */
function rowsToQuestions(rows){
  if(!rows || rows.length<2) return [];
  const H = rows[0].map(h=>low(h));
  const ixQ   = H.findIndex(h=>['question','q','prompt'].some(k=>h.includes(k)));
  const ixAns = H.findIndex(h=>['answer','ans','correct'].some(k=>h.includes(k)));
  const ixA   = H.findIndex(h=>['opta','a','opt a'].some(k=>h===k));
  const ixB   = H.findIndex(h=>['optb','b','opt b'].some(k=>h===k));
  const ixC   = H.findIndex(h=>['optc','c','opt c'].some(k=>h===k));
  const ixD   = H.findIndex(h=>['optd','d','opt d'].some(k=>h===k));
  const out=[];
  for(let i=1;i<rows.length;i++){
    const r = rows[i].map(v=>v??'');
    const q = ixQ>=0 ? r[ixQ] : r[0];
    const ans = ixAns>=0 ? r[ixAns] : '';
    const opts = [ixA,ixB,ixC,ixD].filter(x=>x>=0).map(x=>r[x]).filter(Boolean);
    out.push({q,ans,opts});
  }
  return out.filter(x=>low(x.q)!=='');
}

/* ===== state ===== */
const qs = new URLSearchParams(location.search);
const byGid   = qs.get('gid');
const bySheet = qs.get('sheet');
const limit   = parseInt(qs.get('limit')||'0',10);
const timerS  = parseInt(qs.get('timer')||'0',10);

const titleEl = document.getElementById('title');
const warnEl  = document.getElementById('warn');
const qwrap   = document.getElementById('qwrap');
const qtext   = document.getElementById('qtext');
const optsEl  = document.getElementById('opts');
const pageEl  = document.getElementById('page');
const timerBox = document.getElementById('timerBox');
const showBtn  = document.getElementById('showAnswer');

let Q=[], idx=0, shuffledIndexes=[], reveal=false;

/* ===== timer ===== */
if(timerS>0){
  let left=timerS;
  const tick=()=>{const m=Math.floor(left/60).toString().padStart(2,'0');const s=(left%60).toString().padStart(2,'0');timerBox.textContent=`${m}:${s}`;left--;if(left>=0) setTimeout(tick,1000);}; tick();
}

/* ===== shuffle helper ===== */
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()* (i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr }

/* ===== render ===== */
function render(){
  if(!Q.length){ qwrap.style.display='none'; return }
  const item = Q[idx];
  titleEl.textContent = qs.get('title') || document.title.split('•')[0].trim();
  qwrap.style.display = 'block';
  qtext.textContent = `${idx+1}. ${item.q}`;
  pageEl.textContent = `${idx+1} / ${Q.length}`;

  // prepare MCQ: shuffle options and track correct
  const withCorr = [...item.opts];
  if(!withCorr.includes(item.ans) && item.ans) withCorr.push(item.ans);
  const shuffled = shuffle(withCorr.slice());
  const correctIndex = shuffled.findIndex(x => low(x) === low(item.ans));

  optsEl.innerHTML = '';
  shuffled.forEach((opt,i)=>{
    const div = document.createElement('div');
    div.className = 'opt';
    div.textContent = opt || '(blank)';
    div.addEventListener('click', ()=>{
      [...optsEl.children].forEach(c => c.classList.remove('correct','wrong'));
      div.classList.add(i===correctIndex ? 'correct' : 'wrong');
    });
    optsEl.appendChild(div);
  });

  // show/hide answer
  showBtn.onclick = ()=>{
    [...optsEl.children].forEach((div, i) => {
      div.classList.toggle('correct', i===correctIndex);
    });
  };
}

/* ===== navigation ===== */
document.getElementById('prev').onclick = ()=>{ if(idx>0){idx--; render()} };
document.getElementById('next').onclick = ()=>{ if(idx<Q.length-1){idx++; render()} };

/* ===== load ===== */
(async ()=>{
  try{
    let gid = byGid;
    if(!gid && bySheet){ gid = await getGidByName(GS_SHEET_ID, bySheet); }
    if(!gid) throw new Error('No gid or sheet specified.');

    // load rows
    const rows = await fetchCSVByGidRobust(GS_SHEET_ID, gid);
    const all = rowsToQuestions(rows);
    Q = limit>0 ? all.sort(()=>Math.random()-0.5).slice(0,limit) : all;
    if(!Q.length) throw new Error('No questions found in this tab.');
    render();
  }catch(e){
    warnEl.innerHTML = `<div class="alert">Failed to load this tab. ${e.message}. Make sure the sheet is <b>Public/Published</b>.</div>`;
  }
})();
</script>
</body>
</html>
