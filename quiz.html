<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quiz • PSC Guru</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: #f2f8f4;
    --bg-2:#eaf4ef;
    --glass:#ffffffcc;
    --text:#0f2d1f;
    --muted:#5f726a;
    --ok:#16a34a;
    --bad:#dc2626;
    --ring: rgba(15,131,70,.18);
  }
  *{box-sizing:border-box}
  body{margin:0;font:400 16px/1.55 Inter, system-ui,-apple-system, "Segoe UI", Roboto, "Helvetica Neue";
       color:var(--text);background:linear-gradient(180deg,var(--bg),var(--bg-2))}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}

  /* small top bar */
  .top{display:flex;gap:10px;align-items:center;margin-bottom:10px}
  .top a{margin-left:auto;text-decoration:none;color:inherit;background:#fff;border:1px solid #e6eee8;
         border-radius:999px;padding:6px 12px;font-weight:700}
  h1{margin:0 0 8px;font-size:22px}

  .note{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:10px;padding:10px 12px}

  .card{
    background:var(--glass);border:1px solid #e6eee8;border-radius:14px;
    box-shadow:0 10px 30px rgba(30,70,50,.08)
  }

  /* quiz box */
  .qbox{padding:16px 16px 80px;position:relative}
  .qhead{font-weight:800;margin:0 0 12px}
  .opt{display:block;width:100%;text-align:left;padding:12px 14px;margin:10px 0;border-radius:12px;
       background:#fff;border:1px solid #e6eee8;font:inherit}
  .opt:hover{background:#f7faf8}
  .opt.correct{background:#ecfdf5;border-color:#34d399; box-shadow:0 0 0 6px var(--ring)}
  .opt.wrong{background:#fef2f2;border-color:#fecaca}

  /* sticky bottom bar */
  .nav{
    position:sticky;bottom:8px;display:flex;gap:10px;justify-content:center;align-items:center;
    margin-top:14px;padding:10px;background:rgba(255,255,255,.8);backdrop-filter:blur(8px);
    border:1px solid #e6eee8;border-radius:12px
  }
  .btn{padding:10px 14px;border-radius:12px;border:1px solid #e6eee8;background:#fff;font-weight:800;cursor:pointer}
  .btn.primary{background:#0f8346;color:#fff;border-color:#0b5f34}
  .kpi{margin-left:auto;color:var(--muted);font-weight:800}

  /* summary */
  .sum{padding:14px}
  .acc{margin:10px 0;border:1px solid #e6eee8;border-radius:12px}
  .acc summary{cursor:pointer;list-style:none;padding:12px 14px;font-weight:800;border-bottom:1px solid #e6eee8}
  .acc summary::-webkit-details-marker{display:none}
  .acc .body{padding:12px 14px}
  .ok{color:var(--ok);font-weight:800} .bad{color:var(--bad);font-weight:800}
</style>
</head>
<body>
<div class="wrap">

  <div class="top">
    <div style="display:flex;gap:8px;align-items:center"><strong>PSC Guru</strong><span style="color:#5f726a">Quiz</span></div>
    <a href="index.html">Home</a>
    <a href="quiz.html">Quiz</a>
  </div>

  <h1>Quiz</h1>
  <div id="status" class="note" style="display:none"></div>

  <div class="card qbox" id="qbox" style="display:none">
    <div class="qmeta" id="qmeta" style="color:#5f726a;font-weight:700;margin-bottom:6px"></div>
    <h2 class="qhead" id="qtext">Question</h2>
    <div id="opts"></div>

    <div class="nav">
      <button id="prev" class="btn">← Prev</button>
      <button id="reveal" class="btn">Show Answer</button>
      <button id="next" class="btn primary">Next →</button>
      <div id="kpi" class="kpi">1 / 1</div>
    </div>
  </div>

  <div class="card sum" id="summary" style="display:none"></div>
</div>

<script>
/* ================== CONFIG ================== */
const GS_SHEET_ID = "16iIOLKAkFzXD1ja7v6b7_ZUKVjbcsswX8LfJ_D0S57o";
const GS_PUB_EKEY = "2PACX-1vR4PuWTfq2838_kUaKcwmeWlKb5OtEmL6YqUX4DjPcrb6EaJfW-monSIqbZTiI3ZFrE6GBFHaP7k95A";
const CATEGORIES_TAB = "Categories";

/* ============== Helpers ============== */
const qs = new URLSearchParams(location.search);
const wantedN = (qs.get("n")||"").trim();
const MODE = (qs.get("mode")||"").toLowerCase();
let SHEET = (qs.get("sheet")||"").trim();
const TIMER = parseInt(qs.get("timer")||"0",10)||0;

const el = id => document.getElementById(id);
const status = el('status');
function showStatus(msg){ status.textContent = msg; status.style.display='block'; }
function hideStatus(){ status.style.display='none'; }

function stripGVizJSON(txt){ const s=txt.indexOf('{'), e=txt.lastIndexOf('}'); return JSON.parse(txt.slice(s,e+1)); }
async function gviz(tab){
  const url=`https://docs.google.com/spreadsheets/d/${GS_SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(tab)}&tq=${encodeURIComponent("select *")}`;
  const res=await fetch(url,{cache:"no-store"}); if(!res.ok) throw new Error("GViz fetch failed");
  const raw=await res.text(); const json=stripGVizJSON(raw);
  const cols=json.table.cols.map(c=>(c.label||"").trim());
  const rows=json.table.rows.map(r=>(r.c||[]).map(c=>(c&&c.v)!=null?String(c.v):""));
  return {cols, rows};
}
async function pubCsv(tab){
  const url=`https://docs.google.com/spreadsheets/d/e/${GS_PUB_EKEY}/pub?output=csv&sheet=${encodeURIComponent(tab)}`;
  const res=await fetch(url,{cache:"no-store"}); if(!res.ok) throw new Error("CSV fetch failed");
  return await res.text();
}
function parseCSV(text){
  const lines=text.split(/\r?\n/).filter(Boolean);
  const head=lines.shift().split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(v=>v.replace(/^"|"$/g,"").trim());
  const rows=lines.map(l=>l.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(v=>v.replace(/^"|"$/g,"")));
  return {cols:head, rows};
}
function mapCategories(cols, rows){
  const h=cols.map(x=>x.toLowerCase());
  const idxName=h.findIndex(c=>/name/.test(c));
  const idxTab=h.findIndex(c=>/(get|sheet|tab)/.test(c));
  const idxDesc=h.findIndex(c=>/(desc|description)/.test(c));
  return rows.map(r=>({
    name:(r[idxName]||r[idxTab]||"").trim(),
    sheet:(r[idxTab]||r[idxName]||"").trim(),
    desc:(r[idxDesc]||"").trim()
  })).filter(x=>x.name && x.sheet);
}

/* ============== Load category for random mode ============== */
async function pickRandomCategory(){
  // Try CSV first
  try{
    const txt=await pubCsv(CATEGORIES_TAB);
    const {cols,rows}=parseCSV(txt);
    const items=mapCategories(cols,rows);
    if(items.length){
      const rnd=items[Math.floor(Math.random()*items.length)];
      return rnd;
    }
  }catch(e){ /* ignore, will fallback */ }

  // Fallback GViz
  const {cols,rows}=await gviz(CATEGORIES_TAB);
  const items=mapCategories(cols,rows);
  const rnd=items[Math.floor(Math.random()*items.length)];
  return rnd;
}

/* ============== Map any sheet rows to {q, options[], answer} ============== */
function rowsToQA(cols, rows){
  const H = cols.map(c=>c.toLowerCase());
  const iq = H.findIndex(c=>/question|ques/i.test(c));
  const ia = H.findIndex(c=>/answer|ans/i.test(c));

  // treat other columns as options if they look like options
  const optIdx = H.map((c,i)=>({c,i})).filter(x=> x.i!==iq && x.i!==ia && /(opt|option|a\b|b\b|c\b|d\b)/i.test(x.c)).map(x=>x.i);
  // if no explicit option cols, treat all non-empty columns except q/a as candidate options
  const fallbackIdx = H.map((c,i)=>i).filter(i=>i!==iq && i!==ia);

  const data=[];
  rows.forEach(r=>{
    const q=(r[iq]||"").trim();
    const ans=(r[ia]||"").trim();
    if(!q || !ans) return;

    const pool=[];
    (optIdx.length?optIdx:fallbackIdx).forEach(i=>{
      const v=(r[i]||"").trim();
      if(v) pool.push(v);
    });
    // ensure correct answer is present
    if(!pool.includes(ans)) pool.unshift(ans);

    // de-dup & at least 2
    const options=[...new Set(pool)].filter(Boolean);
    if(options.length<2) return;

    data.push({q, a:ans, options});
  });
  return data;
}

/* ============== Quiz state ============== */
let allQ=[];        // all loaded
let playQ=[];       // selected n
let i=0;            // index
let score=0;
let chosen=[];      // {pick, correct, a, q}
let timerLeft=TIMER, tick=null;

function shuffle(a){for(let j=a.length-1;j>0;j--){const k=Math.floor(Math.random()*(j+1));[a[j],a[k]]=[a[k],a[j]]}return a}
function sample(arr, n){arr=arr.slice();shuffle(arr);return arr.slice(0,n)}

/* ============== Render & interactions ============== */
function setKPI(){ el('kpi').textContent = `${i+1} / ${playQ.length}`; }

function paint(){
  const q=playQ[i];
  el('qtext').textContent=q.q;
  el('qmeta').textContent = SHEET ? SHEET : '';
  const opts=el('opts'); opts.innerHTML='';
  const options=shuffle([...q.options]); // shuffle per render
  options.forEach(opt=>{
    const b=document.createElement('button');
    b.className='opt'; b.textContent=opt;
    b.onclick=()=> choose(opt);
    opts.appendChild(b);
  });
  setKPI();
}

function choose(opt){
  const q=playQ[i];
  const buttons=[...document.querySelectorAll('.opt')];
  let correct=false;
  buttons.forEach(b=>{
    const v=b.textContent.trim();
    if(v===q.a){ b.classList.add('correct'); }
    if(v===opt && v!==q.a){ b.classList.add('wrong'); }
    b.disabled=true;
  });
  if(opt===q.a){ score++; correct=true; }
  chosen[i]={q:q.q, a:q.a, pick:opt, correct};
}

el('reveal').onclick=()=>{
  const q=playQ[i];
  [...document.querySelectorAll('.opt')].forEach(b=>{
    if(b.textContent.trim()===q.a) b.classList.add('correct');
    b.disabled=true;
  });
  if(!chosen[i]) chosen[i]={q:q.q, a:q.a, pick:'(revealed)', correct:false};
};
el('prev').onclick=()=>{ if(i>0){ i--; paint(); } };
el('next').onclick=()=>{
  if(i<playQ.length-1){ i++; paint(); }
  else { endQuiz(); }
};

/* ============== Summary ============== */
function endQuiz(){
  clearInterval(tick);
  el('qbox').style.display='none';
  const s=el('summary'); s.style.display='block';
  let ok = chosen.filter(x=>x && x.correct).length;
  let bad = playQ.length - ok;
  s.innerHTML = `
    <h2 style="margin:0 0 8px">Summary</h2>
    <div style="color:#5f726a;font-weight:800;margin-bottom:8px">Score: ${ok} / ${playQ.length}</div>
    <details class="acc" open>
      <summary>Review answers</summary>
      <div class="body">
        ${playQ.map((q,idx)=>{
          const r = chosen[idx] || {pick:'',correct:false};
          const tag = r.correct ? '<span class="ok">✔ Correct</span>' : '<span class="bad">✖ Wrong</span>';
          return `
            <details class="acc" style="margin:8px 0">
              <summary>${idx+1}. ${q.q}</summary>
              <div class="body">
                ${tag}<br>
                <strong>Answer:</strong> ${q.a}<br>
                <strong>Your pick:</strong> ${r.pick || '(none)'}
              </div>
            </details>
          `;
        }).join('')}
      </div>
    </details>
    <div style="margin-top:12px;display:flex;gap:10px">
      <a class="btn" href="index.html">Home</a>
      <button class="btn primary" onclick="location.reload()">Play Again</button>
    </div>
  `;
}

/* ============== Timer (optional) ============== */
function startTimer(){
  if(!TIMER) return;
  tick = setInterval(()=>{
    timerLeft--;
    el('kpi').textContent = `${i+1} / ${playQ.length} • ${formatTime(timerLeft)}`;
    if(timerLeft<=0){ clearInterval(tick); endQuiz(); }
  },1000);
}
function formatTime(s){const m=Math.floor(s/60);const r=s%60;return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`}

/* ============== Boot ============== */
(async function init(){
  try{
    if(!SHEET && MODE==='random'){
      showStatus('Picking a random category…');
      const rnd = await pickRandomCategory();
      SHEET = rnd.sheet;
      hideStatus();
      showStatus(`Random category: ${rnd.name}`);
    }

    if(!SHEET){
      showStatus('No category selected.');
      return;
    }

    // Load selected sheet questions
    showStatus(`Loading questions from "${SHEET}"…`);
    const {cols,rows} = await gviz(SHEET);
    allQ = rowsToQA(cols, rows);
    if(!allQ.length){ showStatus('No questions found in this sheet.'); return; }

    // pick N
    let n = allQ.length;
    if(wantedN && wantedN.toUpperCase()!=='N'){
      const k = parseInt(wantedN,10)||0;
      if(k>0 && k<n) n=k;
    }
    playQ = sample(allQ, n);

    hideStatus();
    el('qbox').style.display='block';
    paint();
    startTimer();
  }catch(err){
    console.error(err);
    showStatus('Failed to load quiz. Please check your sheet name and sharing settings.');
  }
})();
</script>
</body>
</html>
