<script>
  /* ===================== CONFIG (EDIT) ===================== */
  // If you use Google Sheets, put your Sheet ID here or add ?sheetId=... to the URL.
  const P = new URLSearchParams(location.search);
  const GS_SHEET_ID = P.get('sheetId') || '';  // keep empty to run only with local categories

  // Categories tab names to try in your sheet:
  const TRY_CAT_TABS = ['Categories','Category','Index'];

  // Local categories (used if sheet fails or is not set). Replace with your own.
  // You can optionally add a `date: "2025-01-25"` to improve "latest" sorting when using local only.
  const LOCAL_CATEGORIES = [
    { title:'Disney',        sheet:'Disney',        emoji:'🅳', desc:'Cartoon',           date:'2025-01-22' },
    { title:'Shrek',         sheet:'Shrek',         emoji:'🟢', desc:'Movie',             date:'2025-01-20' },
    { title:'Breaking Bad',  sheet:'Breaking Bad',  emoji:'☣️', desc:'Movie',             date:'2024-12-15' },
    { title:'Harry Potter',  sheet:'Harry Potter',  emoji:'🪄', desc:'Movie',             date:'2024-12-02' },
    { title:'Logo Guest',    sheet:'Logo Guest',    emoji:'🔤', desc:'General Knowledge', date:'2024-11-30' },
    { title:'The Office',    sheet:'The Office',    emoji:'📺', desc:'TV',                date:'2024-11-18' },
    { title:'Ozark',         sheet:'Ozark',         emoji:'🌉', desc:'Movie',             date:'2024-11-10' },
    { title:'Formula 1',     sheet:'Formula 1',     emoji:'🏎️', desc:'Sport',            date:'2024-10-22' },
  ];
  /* ========================================================= */

  // ---------- utilities ----------
  const qs=(s,el=document)=>el.querySelector(s);
  const qsa=(s,el=document)=>[...el.querySelectorAll(s)];
  function stripGVizJSON(txt){ const s=txt.indexOf('{'), e=txt.lastIndexOf('}'); return JSON.parse(txt.slice(s,e+1)); }
  async function gviz(sheetId, tab){
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${encodeURIComponent(tab)}&tq=${encodeURIComponent("select *")}`;
    const res = await fetch(url,{cache:"no-store"}); if(!res.ok) throw new Error('GViz');
    const raw = await res.text(); const json = stripGVizJSON(raw);
    const cols = json.table.cols.map(c => (c.label||"").trim().toLowerCase());
    const rows = json.table.rows.map(r => (r.c||[]).map(c => (c&&c.v)!=null ? String(c.v) : ""));
    return {cols, rows};
  }
  function pickIndex(cols, regexArr){ return cols.findIndex(t => regexArr.some(rx => rx.test(t))); }
  function toTs(v){                 // flexible date parser -> ms
    if(!v) return NaN;
    // allow ISO, dd/mm/yyyy, mm/dd/yyyy, and numeric timestamps
    if(/^\d{10}$/.test(v)) return +v*1000;
    if(/^\d{13}$/.test(v)) return +v;
    const parts = v.trim().replaceAll('.', '/').replaceAll('-', '/');
    const d = new Date(parts);
    const t = +d;
    return Number.isFinite(t) ? t : NaN;
  }

  // ---------- stats & recent ----------
  const playerName = localStorage.getItem('psc_name') || 'Player';
  qs('#playerName') && (qs('#playerName').textContent = playerName);
  qs('#stat-level') && (qs('#stat-level').textContent = localStorage.getItem('psc_level')||'7');
  qs('#stat-rank')  && (qs('#stat-rank').textContent  = localStorage.getItem('psc_rank')||'892');
  qs('#stat-xp')    && (qs('#stat-xp').textContent    = localStorage.getItem('psc_xp')||'60');

  function getRecent(){ try{ return JSON.parse(localStorage.getItem('psc_recent')||'[]'); }catch(_){ return []; } }
  function renderRecent(){
    const row = qs('#recentRow'); if(!row) return;
    row.innerHTML='';
    const data = getRecent().slice(0,10);
    if(!data.length){
      row.innerHTML = `<div class="card" style="flex:1 0 300px"><div class="title">Nothing yet</div><div class="meta">Play any quiz to see it here.</div></div>`;
      return;
    }
    data.forEach(x=>{
      const p = Math.max(0, Math.min(100, x.progress||0));
      const a = document.createElement('a');
      a.className='card';
      const sid = GS_SHEET_ID ? `&sheetId=${encodeURIComponent(GS_SHEET_ID)}` : '';
      a.href = `quiz.html?sheet=${encodeURIComponent(x.sheet)}${sid}`;
      a.innerHTML = `
        <div class="thumb">${x.emoji||'🧠'}</div>
        <div class="title">${x.title}</div>
        <div class="progress"><i style="width:${p}%"></i></div>
        <div class="meta"><span>${p}%</span></div>
      `;
      row.appendChild(a);
    });
  }

  // ---------- rows ----------
  function renderRow(sel, items){
    const row = qs(sel); if(!row) return;
    row.innerHTML='';
    items.forEach(x=>{
      const a=document.createElement('a');
      a.className='card';
      const sid = GS_SHEET_ID ? `&sheetId=${encodeURIComponent(GS_SHEET_ID)}` : '';
      a.href = `quiz.html?sheet=${encodeURIComponent(x.sheet)}${sid}`;
      a.innerHTML = `
        <div class="thumb">${x.emoji || '🎯'}</div>
        <div class="title">${x.title}</div>
        <div class="meta"><span>${x.desc||''}</span></div>
      `;
      row.appendChild(a);
    });
  }

  // ---------- categories (SHEET ➜ fallback) ----------
  async function loadCategories(){
    let list = [];
    if(GS_SHEET_ID){
      for(const tab of TRY_CAT_TABS){
        try{
          const {cols, rows} = await gviz(GS_SHEET_ID, tab);
          const idxName  = pickIndex(cols, [/^name$|^title$|^category$/]);
          const idxSheet = pickIndex(cols, [/sheet|tab|get/]);
          const idxDesc  = pickIndex(cols, [/^desc$|^description$|about|note/]);
          const idxDate  = pickIndex(cols, [/date|updated|modified|release|added|created|timestamp|time/]);

          // Map rows -> items; compute ts (date) for sorting newest first
          list = rows.map((r,i) => {
            const title = (r[idxName]||'').trim();
            const sheet = (r[idxSheet]||'').trim();
            const desc  = (idxDesc>-1 ? (r[idxDesc]||'').trim() : '');
            // If no date col, use row order (top rows = newest) by giving bigger ts to earlier rows
            const tsRow = (rows.length - i) * 60_000; // minute steps
            const tsCol = idxDate>-1 ? toTs(r[idxDate]) : NaN;
            const ts    = Number.isFinite(tsCol) ? tsCol : tsRow;
            return { title, sheet, desc, emoji:'🧠', ts };
          }).filter(x => x.title && x.sheet);

          if(list.length) break;
        }catch(_){ /* try next tab */ }
      }
    }

    if(!list.length){
      // Fallback: local categories with optional `date`
      list = LOCAL_CATEGORIES.map((x,i)=>({
        ...x,
        ts: x.date ? toTs(x.date) : (LOCAL_CATEGORIES.length - i) * 60_000
      }));
    }

    // Sort newest ➜ oldest for "New Release"
    const sorted = list.slice().sort((a,b) => (b.ts||0)-(a.ts||0));
    const latest = sorted.slice(0, 12);          // NEW RELEASE rail
    const older  = sorted.slice(12, 24);         // UPDATE rail (rest)

    renderRow('#newRow', latest);
    renderRow('#updRow', older.length ? older : sorted.slice(0,12));
    renderRow('#startRow', sorted.slice(0,8));

    // Keep around for FAB random
    loadedCategories = sorted;
    return sorted;
  }

  // ---------- FAB Play (random pick) ----------
  let loadedCategories = [];
  qs('#fabPlay')?.addEventListener('click', ()=>{
    const n = 10;
    const list = loadedCategories.length ? loadedCategories : LOCAL_CATEGORIES;
    const pick = list[Math.floor(Math.random()*list.length)];
    if(!pick){ alert('No categories available'); return; }
    const sid = GS_SHEET_ID ? `&sheetId=${encodeURIComponent(GS_SHEET_ID)}` : '';
    location.href = `quiz.html?sheet=${encodeURIComponent(pick.sheet)}${sid}&n=${n}`;
  });

  // ---------- chip (visual state only) ----------
  qsa('.chip').forEach(c=>c.addEventListener('click',()=>{
    qsa('.chip').forEach(x=>x.classList.remove('active')); c.classList.add('active');
  }));

  // ---------- boot ----------
  renderRecent();
  loadCategories();
</script>
