<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PSC Guru • Kerala PSC Exam Prep</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#f3faf4;
      --card:#ffffff;
      --ink:#102a19;
      --muted:#5c7a68;
      --accent:#1b8f4c;
      --accent-ink:#fff;
      --border:#e7ece9;
      --chip:#ecf7f0;
      --shadow:0 20px 40px rgba(16,42,25,.06);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    header{
      position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#edf8f0,rgba(237,248,240,.85));
      backdrop-filter:saturate(120%) blur(8px); border-bottom:1px solid var(--border)
    }
    .wrap{max-width:1120px;margin:0 auto;padding:18px 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .badge{width:34px;height:34px;border-radius:12px;display:grid;place-items:center;font-weight:800;background:#dff3e7;color:#1b7a46}
    .nav{display:flex;gap:10px;margin-left:auto}
    .nav a{display:inline-flex;align-items:center;height:36px;padding:0 14px;border:1px solid var(--border);border-radius:999px;background:#fff}
    main .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .card-title{font-weight:700;margin-bottom:8px}
    .muted{color:var(--muted);font-size:.92rem}
    .row-actions{display:flex;gap:10px;align-items:center;margin-top:10px}
    .btn{background:var(--accent);color:var(--accent-ink);padding:10px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:700}
    .btn.secondary{background:#fff;color:var(--ink);border:1px solid var(--border)}
    .chips{display:flex;gap:10px;margin-top:10px}
    .chip{min-width:38px;height:36px;border-radius:999px;border:1px solid var(--border);background:var(--chip);display:grid;place-items:center;font-weight:700;color:#1e5d3b}
    .chip[data-active="1"]{background:var(--accent);color:#fff;border-color:transparent}
    h2{margin:26px 0 10px}
    .search{width:100%;height:44px;border-radius:12px;border:1px solid var(--border);padding:0 12px;background:#fff}
    .cats{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:14px}
    .cat{border:1px solid var(--border);background:#fff;border-radius:14px;padding:14px}
    .cat h3{font-size:16px;margin:0 0 6px}
    .cat p{margin:0;color:var(--muted);font-size:.9rem}
    .cat a.stretched{position:relative;display:block}
    .cat a.stretched::after{content:"";position:absolute;inset:0}
    @media (max-width:960px){
      main .grid{grid-template-columns:1fr}
      .cats{grid-template-columns:1fr}
    }

    /* <dialog> minimal styles (works in modern browsers) */
    dialog{border:none;border-radius:16px;max-width:420px;width:92%;padding:16px;box-shadow:0 30px 80px rgba(0,0,0,.18)}
    dialog::backdrop{background:rgba(0,0,0,.25)}
    label{display:block;font-weight:700;margin:8px 0 6px}
    select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .row{display:flex;gap:10px}
    .row>div{flex:1}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;gap:12px">
      <div class="brand">
        <div class="badge">PSC</div>
        <div>
          <div>PSC Guru</div>
          <div class="muted" style="font-weight:600">Kerala PSC Exam Prep</div>
        </div>
      </div>
      <div class="nav">
        <a href="quiz.html">Quiz</a>
        <a href="resources.html">Study</a>
        <a href="notices.html">Notices</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <h1 style="margin:10px 0 14px">Quick Quiz</h1>

    <section class="grid">
      <!-- Random Quiz -->
      <div class="card">
        <div class="card-title">Random Quiz</div>
        <p class="muted">Start instantly with mixed questions (random category).</p>

        <div class="chips" id="randN">
          <button class="chip" data-n="5">5</button>
          <button class="chip" data-n="10" data-active="1">10</button>
          <button class="chip" data-n="20">20</button>
          <button class="chip" data-n="30">30</button>
          <button class="chip" data-n="">N</button>
        </div>

        <div class="row-actions">
          <button id="btnRandom" class="btn">Start</button>
        </div>
      </div>

      <!-- AI vs You -->
      <div class="card">
        <div class="card-title">AI vs You</div>
        <p class="muted">
          Timed MCQ — computer guesses vs your answers. Open any category below.
        </p>
        <div class="row-actions">
          <a class="btn secondary" href="ai.html">Info</a>
          <button id="aiPlayBtn" class="btn">Play</button>
        </div>
      </div>

      <!-- Study Material -->
      <div class="card">
        <div class="card-title">Study Material</div>
        <p class="muted">Downloadable PDFs &amp; docs from Google Sheets</p>
        <div class="row-actions">
          <a class="btn" href="resources.html">Open</a>
        </div>
      </div>

      <!-- Exam Notifications -->
      <div class="card">
        <div class="card-title">Exam Notifications</div>
        <p class="muted">Latest notifications curated in Google Sheets</p>
        <div class="row-actions">
          <a class="btn" href="notices.html">Open</a>
        </div>
      </div>
    </section>

    <h2>Quiz Categories <span id="catCount" class="muted">(0)</span></h2>
    <input id="q" class="search" placeholder="Search category…" />
    <div id="cats" class="cats"></div>
  </main>

  <!-- AI vs You: picker dialog -->
  <dialog id="aiPicker">
    <form method="dialog" id="aiForm">
      <h3 style="margin:0 0 8px">Play “AI vs You”</h3>

      <label>Category</label>
      <select id="aiSheet" required></select>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Questions</label>
          <select id="aiN">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="20">20</option>
            <option value="30">30</option>
            <option value="">All</option>
          </select>
        </div>
        <div>
          <label>Timer (min)</label>
          <select id="aiTimer">
            <option value="">Off</option>
            <option value="3">3</option>
            <option value="5" selected>5</option>
            <option value="10">10</option>
            <option value="15">15</option>
          </select>
        </div>
      </div>

      <div class="row-actions" style="justify-content:flex-end;margin-top:14px">
        <button type="button" id="aiCancel" class="btn secondary">Cancel</button>
        <button type="submit" class="btn">Start</button>
      </div>
    </form>
  </dialog>

  <script>
    /* ================= CONFIG ================= */
    const GS_SHEET_ID = "16iIOLKAkFzXD1ja7v6b7_ZUKVjbcsswX8LfJ_D0S57o";

    /* ================ helpers ================= */
    const $ = s => document.querySelector(s);
    const $$ = s => [...document.querySelectorAll(s)];

    function stripGVizJSON(text){
      // gviz response begins with "/*O_o*/\ngoogle.visualization.Query.setResponse(...);"
      const start = text.indexOf("{");
      const end = text.lastIndexOf("}");
      return JSON.parse(text.slice(start, end+1));
    }

    async function gviz(sheetName){
      const url = `https://docs.google.com/spreadsheets/d/${GS_SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
      const res = await fetch(url, {cache:"no-store"});
      if(!res.ok) throw new Error("Failed to fetch gviz");
      const json = stripGVizJSON(await res.text());
      const cols = json.table.cols.map(c => (c.label||"").toLowerCase());
      const rows = json.table.rows.map(r => (r.c||[]).map(c => c ? c.v : ""));
      return {cols, rows};
    }

    /* ====== Random Quiz ====== */
    (function initRandom(){
      const chips = $$("#randN .chip");
      let current = chips.find(c => c.dataset.active === "1")?.dataset.n || "10";
      chips.forEach(ch => {
        ch.addEventListener("click", () => {
          chips.forEach(x => x.removeAttribute("data-active"));
          ch.setAttribute("data-active","1");
          current = ch.dataset.n ?? "";
        });
      });
      $("#btnRandom").addEventListener("click", () => {
        const u = new URL("quiz.html", location.href);
        u.searchParams.set("random","1");
        if(current !== "") u.searchParams.set("n", current);
        location.href = u.toString();
      });
    })();

    /* ====== Categories grid ====== */
    async function loadCategories(){
      try{
        const {cols, rows} = await gviz("Categories");
        // expected headers (case-insensitive):
        //  name (display),  get (actual tab name),  desc (optional)
        const idxDisplay = cols.findIndex(c => c.includes("name"));
        const idxGet     = cols.findIndex(c => c.includes("get") || c.includes("tab"));
        const idxDesc    = cols.findIndex(c => c.includes("desc"));

        const all = rows
          .map(r => ({
            name: (r[idxDisplay] || r[idxGet] || "").toString().trim(),
            sheet:(r[idxGet] || r[idxDisplay] || "").toString().trim(),
            desc: (r[idxDesc] || "").toString().trim()
          }))
          .filter(x => x.sheet && x.name);

        const cont = $("#cats");
        cont.innerHTML = all.map(x => `
          <article class="cat">
            <a class="stretched" href="quiz.html?sheet=${encodeURIComponent(x.sheet)}"></a>
            <h3>${x.name}</h3>
            <p>${x.desc ? x.desc : "From Google Sheets"}</p>
          </article>
        `).join("");

        $("#catCount").textContent = `(${all.length})`;

        // quick search
        const input = $("#q");
        input.addEventListener("input", ()=>{
          const q = input.value.toLowerCase();
          $$("article.cat").forEach(card=>{
            const text = card.querySelector("h3").textContent.toLowerCase();
            card.style.display = text.includes(q) ? "" : "none";
          });
        });

        return all;
      }catch(e){
        console.warn(e);
        $("#cats").innerHTML =
          `<div class="muted">Unable to load categories. Ensure the sheet is <b>Published to the web</b> and a tab named <b>Categories</b> exists with a <i>name</i> column.</div>`;
        return [];
      }
    }

    /* ====== AI vs You launcher ====== */
    (function initAI(){
      const playBtn = $("#aiPlayBtn");
      const dlg = $("#aiPicker");
      const sel = $("#aiSheet");
      const selN = $("#aiN");
      const selTimer = $("#aiTimer");
      const cancelBtn = $("#aiCancel");
      const form = $("#aiForm");

      function getSheetNamesFromCards(){
        return $$('a[href*="quiz.html?sheet="]')
          .map(a => {
            try{
              const u = new URL(a.href, location.href);
              return u.searchParams.get("sheet");
            }catch(e){ return null }
          })
          .filter(Boolean);
      }

      playBtn.addEventListener("click", async () => {
        // use already-rendered cards
        let names = getSheetNamesFromCards();

        // fallback: fetch from sheet if grid not ready
        if(names.length === 0){
          const {cols, rows} = await gviz("Categories");
          const idxDisplay = cols.findIndex(c => c.includes("name"));
          const idxGet     = cols.findIndex(c => c.includes("get") || c.includes("tab"));
          names = rows.map(r => (r[idxGet] || r[idxDisplay] || "").toString().trim()).filter(Boolean);
        }

        if(names.length === 0){
          // last fallback: open info
          location.href = "ai.html";
          return;
        }

        sel.innerHTML = names.map(n => `<option value="${n}">${n}</option>`).join("");
        if(typeof dlg.showModal === "function"){ dlg.showModal(); }
        else {
          const picked = prompt("Type a category name:", names[0]);
          if(picked){
            const url = new URL("ai.html", location.href);
            url.searchParams.set("sheet", picked);
            url.searchParams.set("n", selN.value || "10");
            const t = selTimer.value ? (parseInt(selTimer.value,10)*60) : "";
            if(t) url.searchParams.set("timer", t);
            location.href = url.toString();
          }
        }
      });

      cancelBtn.addEventListener("click", ()=> dlg.close());

      form.addEventListener("submit", (e)=>{
        e.preventDefault();
        const sheet = sel.value;
        const n = selN.value || "";
        const tMin = selTimer.value || "";
        const url = new URL("ai.html", location.href);
        url.searchParams.set("sheet", sheet);
        if(n) url.searchParams.set("n", n);
        if(tMin){
          const sec = parseInt(tMin,10) * 60;
          if(sec) url.searchParams.set("timer", sec);
        }
        location.href = url.toString();
      });
    })();

    // boot
    loadCategories();
  </script>
</body>
</html>
