<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PSC Guru — Kerala PSC Prep</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#fafcfb; --surface:#ffffff; --ink:#0d1f16; --muted:#6b7a72; --line:#e6efe9;
    --accent:#12a66c; --accent-2:#0d8a5a; --pill:#eef6f2; --radius:14px;
  }
  @media (prefers-color-scheme:dark){
    :root{
      --bg:#0c1411; --surface:#101d17; --ink:#ecfff6; --muted:#b9d7cb; --line:#1f3028;
      --pill:#0f271d; --accent:#16c980; --accent-2:#0faa6d;
    }
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:400 15.5px/1.6 Inter,system-ui}
  a{color:inherit;text-decoration:none}
  .topbar{position:sticky;top:0;z-index:40;background:rgba(255,255,255,.65);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line)}
  @media (prefers-color-scheme:dark){ .topbar{background:rgba(16,29,23,.7)} }
  .wrap{max-width:1060px;margin:0 auto;padding:12px 14px;display:flex;gap:10px;align-items:center}
  .brand{display:flex;gap:10px;align-items:center;font-weight:700}
  .brand i{width:28px;height:28px;border-radius:8px;background:var(--pill);display:grid;place-items:center}
  .nav{margin-left:auto;display:flex;gap:8px}
  .btn{padding:10px 14px;border-radius:var(--radius);border:1px solid var(--line);background:var(--surface);font-weight:600}
  .btn.primary{background:linear-gradient(180deg,var(--accent),var(--accent-2));border:none;color:#fff}
  .page{max-width:1060px;margin:0 auto;padding:16px 14px 100px}
  .hero{border:1px solid var(--line);border-radius:20px;background:linear-gradient(180deg,#f6fbf8,#f0faf4);padding:18px}
  @media (prefers-color-scheme:dark){ .hero{background:linear-gradient(180deg,#0e1914,#0b1511)} }
  .hero-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
  @media (max-width:920px){ .hero-grid{grid-template-columns:1fr} }
  .h-title{margin:0 0 6px;font:700 24px/1.2 Inter}
  .h-sub{margin:0;color:var(--muted)}
  .quick{margin-top:12px;border:1px solid var(--line);border-radius:var(--radius);background:var(--surface);padding:12px}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .chip{background:var(--pill);border:1px solid var(--line);border-radius:999px;padding:7px 12px;font-weight:600;cursor:pointer}
  .chip.active{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;border:none}
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .stat{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius);padding:12px;text-align:center}
  .stat small{display:block;color:var(--muted);font-weight:600}
  .art{height:160px;border-radius:16px;border:1px solid var(--line);display:grid;place-items:center;font-size:48px;background:var(--surface)}
  .section{margin-top:20px}
  .section h3{margin:0 0 10px;font-weight:700;font-size:16px}
  .rail{display:flex;gap:12px;overflow:auto;padding-bottom:4px;scroll-snap-type:x mandatory}
  .rail::-webkit-scrollbar{height:8px}
  .rail::-webkit-scrollbar-thumb{background:#cfe1d8;border-radius:999px}
  @media (prefers-color-scheme:dark){ .rail::-webkit-scrollbar-thumb{background:#1e2c26} }
  .card{scroll-snap-align:start;flex:0 0 clamp(220px,30vw,280px);border:1px solid var(--line);border-radius:16px;background:var(--surface);padding:12px}
  .thumb{height:96px;border-radius:12px;background:var(--pill);display:grid;place-items:center;font-size:30px;border:1px solid var(--line)}
  .ct{margin:10px 0 6px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .cd{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
  @media (min-width:580px){ .grid{grid-template-columns:repeat(3,1fr)} }
  @media (min-width:880px){ .grid{grid-template-columns:repeat(4,1fr)} }
  .cat{display:grid;grid-template-columns:auto 1fr;grid-template-rows:auto auto;align-items:center;gap:8px;border:1px solid var(--line);border-radius:16px;background:var(--surface);padding:12px}
  .ico{width:40px;height:40px;border-radius:10px;background:var(--pill);display:grid;place-items:center;border:1px solid var(--line)}
  .ctt{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .cdd{grid-column:1/3;color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .search{display:flex;gap:10px;margin-top:10px}
  .search input{flex:1;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:var(--surface);font-weight:600}
  html,body,.grid,.rail{min-width:0}
</style>
</head>
<body>

<header class="topbar">
  <div class="wrap">
    <div class="brand"><i>🌿</i>PSC Guru</div>
    <nav class="nav">
      <a class="btn primary" href="quiz.html?mode=random&n=10">Quick Play</a>
      <a class="btn" href="quiz.html">Quiz</a>
      <a class="btn" href="resources.html">Study</a>
      <a class="btn" href="notices.html">Notices</a>
    </nav>
  </div>
</header>

<main class="page">
  <section class="hero">
    <div class="hero-grid">
      <div>
        <h1 class="h-title">Kerala PSC. One calm place to practice.</h1>
        <p class="h-sub">Daily random drills, Malayalam-friendly questions, and simple progress that sticks.</p>
        <div class="quick">
          <div style="font-weight:700">Quick Start</div>
          <div class="chips" id="chips">
            <button class="chip" data-n="5">5</button>
            <button class="chip active" data-n="10">10</button>
            <button class="chip" data-n="20">20</button>
            <button class="chip" data-n="30">30</button>
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button id="startRandom" class="btn primary">Start Random Quiz</button>
            <span style="color:var(--muted);font-size:14px">No category required — we’ll pick one.</span>
          </div>
        </div>
      </div>
      <div>
        <div class="stats" style="margin-bottom:10px">
          <div class="stat"><small>Streak</small><span id="streak">0</span></div>
          <div class="stat"><small>Quizzes</small><span id="played">0</span></div>
          <div class="stat"><small>Accuracy</small><span id="acc">0%</span></div>
        </div>
        <div class="art">📗</div>
      </div>
    </div>
  </section>

  <div class="search">
    <input id="q" placeholder="Search categories…">
    <button id="reload" class="btn">Reload</button>
  </div>

  <section class="section">
    <h3>Trending</h3>
    <div class="rail" id="trend"></div>
  </section>

  <section class="section">
    <h3>Recently played</h3>
    <div class="rail" id="recent"></div>
  </section>

  <section class="section">
    <h3>All categories</h3>
    <div class="grid" id="grid"></div>
  </section>
</main>

<script>
(function(){
  /* ===== CONFIG =====
     You can pass ?sheetId=... or ?pub=2PACX-... in the URL.
     If neither is passed, these defaults are used: */
  const P = new URLSearchParams(location.search);
  const SHEET_ID = P.get('sheetId') || ''; // normal GViz id (optional)
  const PUB_ID   = normalizePubId(P.get('pub') || '2PACX-1vR4PuWTfq2838_kUaKcwmeWlKb5OtEmL6YqUX4DjPcrb6EaJfW-monSIqbZTiI3ZFrE6GBFHaP7k95A'); // <-- your published id
  const TRY_TABS = ['Categories','Category','Index']; // categories sheet names
  const LOCAL = [
    { title:'Information Technology', sheet:'Information Technology', emoji:'💻', desc:'ഐ.ടി., കമ്പ്യൂട്ടർ, ഇന്റർനെറ്റ്', date:'2025-01-20' },
    { title:'Malayalam GK',           sheet:'Malayalam GK',           emoji:'📝', desc:'മലയാളം പൊതുജ്ഞാനം',         date:'2025-01-15' },
    { title:'Kerala Renaissance',     sheet:'Kerala Renaissance',     emoji:'🌅', desc:'കേരള നവോത്ഥാനം',           date:'2025-01-10' },
    { title:'India GK',               sheet:'India GK',               emoji:'🇮🇳', desc:'ഇന്ത്യ — പൊതുജ്ഞാനം',         date:'2024-12-22' },
  ];
  /* ================== */

  const $ = (s,el=document)=>el.querySelector(s);
  const $$= (s,el=document)=>[...el.querySelectorAll(s)];

  // ---------- Stats ----------
  function loadStats(){
    $('#streak').textContent = localStorage.getItem('psc_streak') || '0';
    $('#played').textContent = localStorage.getItem('psc_played') || '0';
    $('#acc').textContent    = (localStorage.getItem('psc_correct_pct') || '0') + '%';
  }

  // ---------- Fetchers ----------
  function normalizePubId(val){
    if(!val) return '';
    const m = String(val).match(/\/d\/e\/([^/]+)\/pub/);
    return m ? m[1] : val;
  }
  function stripGVizJSON(txt){ const s=txt.indexOf('{'), e=txt.lastIndexOf('}'); return JSON.parse(txt.slice(s,e+1)); }
  async function gvizBySheet(sheetId, tab){
    const url=`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${encodeURIComponent(tab)}&tq=${encodeURIComponent('select *')}`;
    const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error('GViz '+res.status);
    const raw=await res.text(); const json=stripGVizJSON(raw);
    const cols=json.table.cols.map(c=>(c.label||'').trim().toLowerCase());
    const rows=json.table.rows.map(r=>(r.c||[]).map(c=>(c&&c.v)!=null?String(c.v):''));
    return {cols, rows};
  }
  function parseCSV(text){
    const rows=[]; let row=[], field=''; let i=0; const s=text.replace(/\r\n/g,'\n').replace(/\r/g,'\n'); let inQ=false;
    while(i<s.length){
      const c=s[i];
      if(inQ){
        if(c==='"' && s[i+1]==='"'){ field+='"'; i+=2; continue; }
        if(c==='\"'){ inQ=false; i++; continue; }
        field+=c; i++; continue;
      }else{
        if(c==='\"'){ inQ=true; i++; continue; }
        if(c===','){ row.push(field); field=''; i++; continue; }
        if(c==='\n'){ row.push(field); rows.push(row); row=[]; field=''; i++; continue; }
        field+=c; i++;
      }
    }
    if(field.length || row.length){ row.push(field); rows.push(row); }
    const header = rows.shift() || [];
    const cols = header.map(h => (h||'').trim().toLowerCase());
    return {cols, rows};
  }
  async function pubCSVBySheet(pubId, tab){
    const url=`https://docs.google.com/spreadsheets/d/e/${pubId}/pub?output=csv&sheet=${encodeURIComponent(tab)}`;
    const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error('PUB '+res.status);
    const csv=await res.text(); return parseCSV(csv);
  }
  function pickIndex(cols, rxArr){ return cols.findIndex(t => rxArr.some(rx => rx.test(t))); }
  function toTs(v){
    if(!v) return NaN; if(/^\d{13}$/.test(v)) return +v; if(/^\d{10}$/.test(v)) return +v*1000;
    const t=+new Date(String(v).replaceAll('.', '/').replaceAll('-', '/')); return Number.isFinite(t)?t:NaN;
  }

  // ---------- Render helpers ----------
  function trendCard(x){
    const srcParam = SHEET_ID ? `sheetId=${encodeURIComponent(SHEET_ID)}` : (PUB_ID ? `pub=${encodeURIComponent(PUB_ID)}` : '');
    return `<a class="card" href="quiz.html?sheet=${encodeURIComponent(x.sheet)}&${srcParam}">
      <div class="thumb">${x.emoji||'🧠'}</div>
      <div class="ct" title="${x.title}">${x.title}</div>
      <div class="cd">${x.desc||''}</div>
    </a>`;
  }
  function catTile(x){
    const srcParam = SHEET_ID ? `sheetId=${encodeURIComponent(SHEET_ID)}` : (PUB_ID ? `pub=${encodeURIComponent(PUB_ID)}` : '');
    return `<a class="cat" href="quiz.html?sheet=${encodeURIComponent(x.sheet)}&${srcParam}">
      <div class="ico">${x.emoji||'📘'}</div>
      <div class="ctt">${x.title}</div>
      <div class="cdd">${x.desc||''}</div>
    </a>`;
  }
  function renderRecent(){
    const rail=$('#recent'); let list=[]; try{ list=JSON.parse(localStorage.getItem('psc_recent')||'[]').slice(0,10);}catch(_){}
    rail.innerHTML = list.length
      ? list.map(trendCard).join('')
      : `<div class="card"><div class="thumb">🧠</div><div class="ct">Nothing yet</div><div class="cd">Play a quiz to see it here.</div></div>`;
  }

  // ---------- Categories loader ----------
  async function loadCategories(){
    let list=[];
    // Prefer query param source, else fallbacks
    if(SHEET_ID){
      for(const tab of TRY_TABS){
        try{
          const {cols, rows} = await gvizBySheet(SHEET_ID, tab);
          list = mapCategoryRows(cols, rows);
          if(list.length) break;
        }catch(_){}
      }
    } else if (PUB_ID){
      for(const tab of TRY_TABS){
        try{
          const {cols, rows} = await pubCSVBySheet(PUB_ID, tab);
          list = mapCategoryRows(cols, rows);
          if(list.length) break;
        }catch(_){}
      }
    }
    if(!list.length){
      list = LOCAL.map((x,i)=>({...x, ts: x.date?toTs(x.date):(LOCAL.length-i)*60_000}));
    }
    const sorted = list.slice().sort((a,b)=>(b.ts||0)-(a.ts||0));
    $('#trend').innerHTML = sorted.slice(0,10).map(trendCard).join('');
    $('#grid').innerHTML  = sorted.map(catTile).join('');
    return sorted;
  }
  function mapCategoryRows(cols, rows){
    const iName  = pickIndex(cols, [/^name$|^title$|^category$/]);
    const iSheet = pickIndex(cols, [/sheet|tab|get/]);
    const iDesc  = pickIndex(cols, [/^desc$|^description$|about|note/]);
    const iDate  = pickIndex(cols, [/date|updated|created|timestamp|modified|release|added|time/]);
    return rows.map((r,idx)=>({
      title:(r[iName]||'').trim(),
      sheet:(r[iSheet]||'').trim(),
      desc: iDesc>-1 ? (r[iDesc]||'').trim() : '',
      emoji:'🧠',
      ts: Number.isFinite(toTs(r[iDate])) ? toTs(r[iDate]) : (rows.length-idx)*60_000
    })).filter(x=>x.title && x.sheet);
  }

  // ---------- UX wiring ----------
  $('#q').addEventListener('input', e=>{
    const q=e.target.value.toLowerCase();
    $$('#grid .cat').forEach(el=>{
      const t=el.querySelector('.ctt').textContent.toLowerCase();
      const d=(el.querySelector('.cdd')?.textContent.toLowerCase()||'');
      el.style.display = (t.includes(q)||d.includes(q)) ? '' : 'none';
    });
  });
  $('#chips').addEventListener('click', e=>{
    const c=e.target.closest('.chip'); if(!c) return;
    $$('#chips .chip').forEach(x=>x.classList.remove('active')); c.classList.add('active');
  });
  $('#startRandom').addEventListener('click', ()=>{
    const n = ($('#chips .chip.active')?.dataset.n) || '10';
    if(!window.__cats || !__cats.length){ alert('No categories available'); return; }
    const pick = __cats[Math.floor(Math.random()*__cats.length)];
    const srcParam = SHEET_ID ? `sheetId=${encodeURIComponent(SHEET_ID)}` : (PUB_ID ? `pub=${encodeURIComponent(PUB_ID)}` : '');
    location.href = `quiz.html?sheet=${encodeURIComponent(pick.sheet)}&${srcParam}&n=${n}`;
  });
  $('#reload').addEventListener('click', async ()=>{ __cats = await loadCategories(); });

  // ---------- boot ----------
  let __cats=[];
  (async function(){
    loadStats();
    renderRecent();
    __cats = await loadCategories();
  })();
})();
</script>
</body>
</html>
