<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PSC Guru — Kerala PSC Exam Prep</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- shared header styles -->
  <link rel="stylesheet" href="header.css"/>

  <style>
    :root{ --text:#0f2d1f; --muted:#5f726a; --brand:#0f8346; --border:rgba(0,0,0,.08); --card:#fff; --shadow:0 30px 60px rgba(30,70,50,.12) }
    @media (prefers-color-scheme: dark){
      :root{ --text:#ecfdf5; --muted:#b8d8cc; --border:rgba(255,255,255,.12); --card:#0c1b13; --shadow:0 30px 60px rgba(0,0,0,.5) }
    }
    body{margin:0;font:400 16px/1.55 Inter,system-ui;background:#f5fbf7;color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 60px}
    .hero{margin:10px 0 18px;display:grid;gap:14px;grid-template-columns:1fr;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:14px}
    @media (min-width:860px){ .hero{ grid-template-columns: 1.2fr .8fr } }

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid var(--border);background:#fff;color:#0f2d1f;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:800}
    @media (prefers-color-scheme:dark){ .chip{ background:#0f1f18; color:#ecfdf5} }
    .chip.active{background:linear-gradient(180deg,#0f8346,#0b5f34);color:#fff;border-color:#0b5f34}

    .cta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:800}
    .btn.primary{background:linear-gradient(180deg,#0f8346,#0b5f34);color:#fff;border:none}

    .search{display:flex;gap:8px;margin-top:8px}
    .search input{flex:1;border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#fff}
    @media (prefers-color-scheme:dark){ .search input{ background:#0c1b13; color:#ecfdf5 } }

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:16px}
    .cat{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--shadow);text-decoration:none;color:inherit;display:block}
    .cat h3{margin:6px 0 6px;font:800 18px/1.2 Inter}
    .cat p{margin:0;color:var(--muted);font-size:14px}

    .splash{position:fixed;inset:0;display:none;place-items:center;background:rgba(255,255,255,.6);backdrop-filter:blur(6px);z-index:2000}
    @media (prefers-color-scheme:dark){ .splash{ background:rgba(5,10,8,.6) } }
    .splash.on{display:grid}
    .spinner{width:64px;height:64px;border-radius:50%;border:6px solid #e2f2e6;border-top-color:#0f8346;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .hint{margin-top:8px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <!-- shared header (keeps header consistent across pages) -->
  <script defer src="site-header.js"></script>

  <div class="wrap">
    <section class="hero">
      <div>
        <h1 style="margin:6px 0 8px;font:800 28px/1.15 Inter">Crack Kerala PSC with Daily Practice</h1>
        <p style="margin:0;color:var(--muted)">Choose a category or jump into a randomized quiz. Track progress, reveal answers, and see a full summary.</p>

        <div style="margin-top:14px">
          <h3 style="margin:0 0 8px;font:800 16px/1 Inter">🎲 Random Quiz</h3>
          <div class="chips" id="chips">
            <button class="chip" data-n="5">5</button>
            <button class="chip active" data-n="10">10</button>
            <button class="chip" data-n="20">20</button>
            <button class="chip" data-n="30">30</button>
          </div>
          <div class="cta" style="margin-top:10px">
            <button id="startRandom" class="btn primary">Start</button>
            <span style="color:var(--muted);font-size:14px">Picks a random category & questions. No selection needed.</span>
          </div>
          <div class="hint" id="hint" style="display:none"></div>
        </div>
      </div>

      <div>
        <div class="search">
          <input id="q" type="text" placeholder="Search categories…">
          <button id="refresh" class="btn">Reload</button>
        </div>
        <div class="grid" id="cats" style="margin-top:10px"></div>
      </div>
    </section>
  </div>

  <!-- subtle splash during fetch -->
  <div class="splash" id="splash"><div class="spinner"></div></div>

  <script>
    /* ======================= CONFIG (EDIT HERE) ======================= */
    const P = new URLSearchParams(location.search);

    // 1) If you use Google Sheets, put your Sheet ID here, or pass ?sheetId=... in URL.
    const GS_SHEET_ID = P.get('sheetId') || ''; // leave empty to always use local categories

    // 2) Categories tab names to try in your sheet (change if yours is different).
    const TRY_CAT_TABS = Array.from(new Set([
      P.get('tab') || 'Categories', 'Category', 'Index'
    ]));

    // 3) Local categories (work 100% offline; edit titles, sheet tab names, and descriptions).
    //    These are shown if the sheet isn’t set or isn’t reachable.
    const LOCAL_CATEGORIES = [
      // EXAMPLES — replace with your real tabs & descriptions
      { title: 'Information Technology', sheet: 'Information Technology', desc: 'ഐ.ടി. അടിസ്ഥാനങ്ങൾ, കമ്പ്യൂട്ടർ, ഇന്റർനെറ്റ്' },
      { title: 'Malayalam GK',           sheet: 'Malayalam GK',           desc: 'മലയാളം പൊതുജ്ഞാനം' },
      { title: 'Kerala Renaissance',     sheet: 'Kerala Renaissance',     desc: 'കേരള നവോത്ഥാനം — നേതാക്കളും പ്രസ്ഥാനങ്ങളും' },
    ];
    /* ================================================================== */

    const chips = document.getElementById('chips');
    const startRandom = document.getElementById('startRandom');
    const splash = document.getElementById('splash');
    const cats = document.getElementById('cats');
    const find = document.getElementById('q');
    const hint = document.getElementById('hint');

    function showSplash(on){ splash.classList.toggle('on', !!on); }
    function stripGVizJSON(txt){ const s=txt.indexOf('{'), e=txt.lastIndexOf('}'); return JSON.parse(txt.slice(s,e+1)); }
    async function gviz(tab){
      const url = `https://docs.google.com/spreadsheets/d/${GS_SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(tab)}&tq=${encodeURIComponent("select *")}`;
      const res = await fetch(url,{cache:"no-store"});
      if(!res.ok) throw new Error(`GViz ${res.status}`);
      const raw = await res.text();
      const json = stripGVizJSON(raw);
      const cols = json.table.cols.map(c => (c.label||"").trim().toLowerCase());
      const rows = json.table.rows.map(r => (r.c||[]).map(c => (c&&c.v)!=null ? String(c.v) : ""));
      return {cols, rows};
    }

    function pickIndex(cols, regexArr){ return cols.findIndex(t => regexArr.some(rx => rx.test(t))); }

    function renderFromRows(cols, rows){
      const idxName  = pickIndex(cols, [/^name$|^title$|^category$/]);
      const idxSheet = pickIndex(cols, [/sheet|tab|get/]);
      const idxDesc  = pickIndex(cols, [/^desc$|^description$|about|note/]);

      cats.innerHTML = "";
      rows.forEach(r=>{
        const title = (r[idxName]||"").trim();
        const sheet = (r[idxSheet]||"").trim();
        const desc  = (idxDesc>-1 ? (r[idxDesc]||"").trim() : "");
        if(!title || !sheet) return;

        const a = document.createElement('a');
        a.className = 'cat';
        // pass sheetId only if we actually have one
        const sid = GS_SHEET_ID ? `&sheetId=${encodeURIComponent(GS_SHEET_ID)}` : '';
        a.href = `quiz.html?sheet=${encodeURIComponent(sheet)}${sid}`;
        a.innerHTML = `<h3>${title}</h3>${desc ? `<p>${desc}</p>` : ""}`;
        cats.appendChild(a);
      });
    }

    function renderFromLocal(list){
      cats.innerHTML = "";
      list.forEach(({title, sheet, desc})=>{
        if(!title || !sheet) return;
        const a = document.createElement('a');
        a.className = 'cat';
        const sid = GS_SHEET_ID ? `&sheetId=${encodeURIComponent(GS_SHEET_ID)}` : '';
        a.href = `quiz.html?sheet=${encodeURIComponent(sheet)}${sid}`;
        a.innerHTML = `<h3>${title}</h3>${desc ? `<p>${desc}</p>` : ""}`;
        cats.appendChild(a);
      });
    }

    async function loadCategories(){
      // Prefer Google Sheet if ID provided; otherwise always show local list.
      if(!GS_SHEET_ID){
        hint.style.display = 'block';
        hint.textContent = 'Using local categories (set a Google Sheet ID later if you want).';
        renderFromLocal(LOCAL_CATEGORIES);
        return;
      }

      try{
        hint.style.display = 'none';
        showSplash(true);
        let loaded = false;
        for(const tab of TRY_CAT_TABS){
          try{
            const {cols, rows} = await gviz(tab);
            renderFromRows(cols, rows);
            loaded = true;
            break;
          }catch(_){/* try next tab */}
        }
        if(!loaded){
          hint.style.display = 'block';
          hint.textContent = 'Could not read categories from your Google Sheet — showing local categories instead.';
          renderFromLocal(LOCAL_CATEGORIES);
        }
      } finally {
        showSplash(false);
      }
    }

    // Random quiz
    chips.addEventListener('click', e=>{
      const b = e.target.closest('.chip'); if(!b) return;
      chips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      b.classList.add('active');
    });

    startRandom.addEventListener('click', ()=>{
      const active = chips.querySelector('.chip.active');
      const n = active ? active.dataset.n : '10';

      // Pass sheetId only if set; also pass local list so quiz can choose randomly even without Google Sheet.
      const sid = GS_SHEET_ID ? `&sheetId=${encodeURIComponent(GS_SHEET_ID)}&tab=${encodeURIComponent(TRY_CAT_TABS[0])}` : '';
      const fb  = encodeURIComponent(JSON.stringify(LOCAL_CATEGORIES));
      location.href = `quiz.html?mode=random&n=${encodeURIComponent(n)}${sid}&fallback=${fb}`;
    });

    // Search filter
    document.getElementById('q').addEventListener('input', e=>{
      const q = e.target.value.toLowerCase();
      [...document.querySelectorAll('.cat')].forEach(card=>{
        const t = card.querySelector('h3').textContent.toLowerCase();
        const d = (card.querySelector('p')?.textContent.toLowerCase() || "");
        card.style.display = (t.includes(q) || d.includes(q)) ? "" : "none";
      });
    });
    document.getElementById('refresh').addEventListener('click', loadCategories);

    loadCategories();
  </script>
</body>
</html>
