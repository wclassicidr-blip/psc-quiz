<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PSC Guru • Home</title>
<style>
  :root{--bg:#f2f8f4;--card:#fff;--ink:#113b2f;--muted:#58736c;--accent:#0fa66d;--accent-weak:#c8efe2;--line:#e6eee9}
  *{box-sizing:border-box} html,body{margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  .row{display:flex;align-items:center;gap:10px;justify-content:space-between}
  .brand .logo{width:36px;height:36px;border-radius:10px;background:#1f7c59;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800}
  .pill{background:#fff;border:1px solid var(--line);border-radius:999px;padding:6px 12px;font-size:14px;text-decoration:none;color:var(--ink)}
  h2{margin:18px 0 10px}
  .muted{color:var(--muted)}
  .cards{display:grid;grid-template-columns:1fr;gap:16px}
  .cards.two{grid-template-columns:1fr;gap:16px}
  .cards.cat{grid-template-columns:1fr;gap:12px}
  @media(min-width:780px){.cards.two{grid-template-columns:1fr 1fr}.cards.cat{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;text-decoration:none;color:var(--ink)}
  .btn{background:#fff;border:1px solid var(--line);border-radius:10px;height:36px;padding:0 12px;display:inline-flex;align-items:center;gap:8px;cursor:pointer;text-decoration:none;color:var(--ink)}
  .btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .title{font-weight:700}
  .sub{font-size:12px;color:var(--muted)}
  .tag{background:var(--accent-weak);border-radius:999px;padding:3px 8px;font-size:12px}
  .search{width:100%;height:36px;border:1px solid var(--line);background:#fff;border-radius:10px;padding:0 12px}
  .alert{background:#fff9e8;border:1px solid #f6e2b0;color:#5f4a00;padding:10px 12px;border-radius:10px}
</style>
</head>
<body>
<div class="wrap">
  <!-- Header -->
  <div class="row brand">
    <div class="row" style="gap:10px">
      <div class="logo">PSC</div>
      <div>
        <div style="font-weight:800">PSC Guru</div>
        <div class="muted" style="font-size:12px">Kerala PSC Exam Prep</div>
      </div>
    </div>
    <a class="pill" href="quiz.html">Quiz</a>
  </div>

  <!-- Quick quiz -->
  <h2>Quick Quiz</h2>
  <div class="cards two">
    <div class="card">
      <div class="row">
        <div>
          <div class="title">Random Quiz</div>
          <div class="sub">Start instantly with mixed questions (random category).</div>
        </div>
        <button id="startRandom" class="btn btn-primary">Start</button>
      </div>
      <div style="height:8px"></div>
      <div class="row">
        <div class="muted">How many questions?</div>
        <div class="row" style="gap:8px">
          <button class="btn tag qn" data-n="5">5</button>
          <button class="btn tag qn" data-n="10">10</button>
          <button class="btn tag qn" data-n="20">20</button>
          <button class="btn tag qn" data-n="30">30</button>
          <input id="customCount" class="search" style="width:90px" type="number" min="1" placeholder="N"/>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <div class="title">AI vs You</div>
          <div class="sub">Timed MCQ — computer guesses vs your answers. Open any category below.</div>
        </div>
        <a id="howAi" class="btn">Info</a>
      </div>
      <div style="height:8px"></div>
      <div class="sub">Tip: set a timer via URL, e.g. <code>&timer=300</code> for 5 min.</div>
    </div>
  </div>

  <!-- Study & Notices -->
  <h2>Study & Notices</h2>
  <div class="cards two">
    <a class="card" href="resources.html?tab=study">
      <div class="row"><div><div class="title">Study Material</div><div class="sub">Downloadable PDFs & docs from Google Sheets</div></div><span class="tag">Open</span></div>
    </a>
    <a class="card" href="resources.html?tab=notices">
      <div class="row"><div><div class="title">Exam Notifications</div><div class="sub">Latest notifications curated in Google Sheets</div></div><span class="tag">Open</span></div>
    </a>
  </div>

  <!-- Categories -->
  <h2 class="row"><span>Quiz Categories</span><span class="tag" id="catCount">0</span></h2>
  <input id="search" class="search" placeholder="Search category..."/>
  <div style="height:12px"></div>
  <div id="catHost" class="cards cat"></div>
  <div id="warn" style="margin-top:12px"></div>
</div>

<script>
/* ====== CONFIG ====== */
const GS_SHEET_ID = "16iIOLKAkFzXD1ja7v6b7_ZUKVjbcsswX8LfJ_D0S57o";
const CATEGORIES_TAB = "Categories"; // <-- list comes from this tab

/* ====== utils ====== */
const norm = s => (s ?? '').toString().normalize('NFKC').replace(/\u00A0/g,' ').trim();
const low  = s => norm(s).toLowerCase();
async function fetchText(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(r.statusText); return r.text(); }
function parseCSV(t){const R=[];let i=0,f='',r=[],q=false;const pf=()=>{r.push(f);f='';};const pr=()=>{R.push(r);r=[];};while(i<t.length){const c=t[i];if(q){if(c=='"'&&t[i+1]=='"'){f+='"';i+=2;continue}if(c=='"'){q=false;i++;continue}f+=c;i++;continue}if(c=='"'){q=true;i++;continue}if(c==','){pf();i++;continue}if(c=='\r'){i++;continue}if(c=='\n'){pf();pr();i++;continue}f+=c;i++}pf();pr();while(R.length&&R[R.length-1].every(c=>low(c)===''))R.pop();return R;}
async function csvBySheet(sheet){ const u=`https://docs.google.com/spreadsheets/d/${GS_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}`; const t=await fetchText(u); return parseCSV(t); }

/* ====== state & render ====== */
const host  = document.getElementById('catHost');
const warn  = document.getElementById('warn');
const count = document.getElementById('catCount');
let CATS = [];

function render(list){
  host.innerHTML='';
  list.forEach(c=>{
    const a=document.createElement('a');
    a.className='card';
    a.href=`quiz.html?sheet=${encodeURIComponent(c.sheet)}&mode=mcq&timer=0`;
    a.innerHTML=`<div class="row"><div><div class="title">${c.name}</div><div class="sub">${c.desc||'From Google Sheets'}</div></div><span class="tag">Open</span></div>`;
    host.appendChild(a);
  });
  count.textContent = list.length;
}

document.getElementById('search').addEventListener('input', e=>{
  const q = low(e.target.value);
  render(CATS.filter(c => low(c.name).includes(q)));
});

/* Random quiz */
let rndCount = 10;
document.querySelectorAll('.qn').forEach(b=> b.addEventListener('click',()=> rndCount = +b.dataset.n));
document.getElementById('startRandom').addEventListener('click', ()=>{
  const custom = parseInt(document.getElementById('customCount').value||'0',10);
  const N = custom>0 ? custom : rndCount;
  if(!CATS.length){ alert('Categories not loaded yet.'); return; }
  const pick = CATS[Math.floor(Math.random()*CATS.length)];
  location.href = `quiz.html?sheet=${encodeURIComponent(pick.sheet)}&mode=mcq&limit=${N}&timer=0`;
});
document.getElementById('howAi').addEventListener('click',()=>alert('Open any category card. To add a timer, append &timer=300 (seconds) to the URL.'))

/* Load categories from the "Categories" tab */
(async ()=>{
  try{
    const rows = await csvBySheet(CATEGORIES_TAB);
    if(rows.length<2) throw new Error('Empty Categories tab.');
    const H = rows[0].map(h=>low(h));
    const ixName  = H.indexOf('name');
    const ixSheet = H.indexOf('sheet');
    const ixDesc  = H.indexOf('desc');

    CATS = rows.slice(1).map(r=>{
      const name  = norm(ixName>=0 ? r[ixName] : r[0]);
      const sheet = norm(ixSheet>=0 ? r[ixSheet] : name);
      const desc  = norm(ixDesc>=0 ? r[ixDesc] : '');
      return name ? {name, sheet, desc} : null;
    }).filter(Boolean);

    if(!CATS.length) throw new Error('No rows in Categories.');
    render(CATS);
  }catch(e){
    warn.innerHTML = `<div class="alert">Unable to load categories from the <b>Categories</b> tab. Make sure your sheet is <b>Published to the web</b> and the tab exists with a "name" column. Error: ${e.message}</div>`;
  }
})();
</script>
</body>
</html>
