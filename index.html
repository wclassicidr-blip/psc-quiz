<!doctype html>
<html lang="ml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PSC Guru ‚Äì Kerala PSC Quiz</title>
  <style>
    :root{
      --bg:#f6fbf7; --ink:#0f172a; --muted:#64748b; --brand:#2f8f50;
      --card:#fff; --border:#e5e7eb; --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    header{position:sticky;top:0;background:linear-gradient(135deg,#dff3df,#eaf7ea);border-bottom:1px solid #e6f3e7;z-index:40}
    .wrap{max-width:1100px;margin:0 auto;padding:16px;display:flex;gap:12px;align-items:center}
    .logo{width:38px;height:38px;border-radius:10px;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:900;box-shadow:var(--shadow)}
    .spacer{flex:1}
    .btn{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer}
    main{max-width:1100px;margin:0 auto;padding:18px 16px 40px}
    h2{margin:18px 0 8px}
    .sub{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;margin-top:10px}
    @media (max-width:760px){ .cards{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:14px;display:flex;gap:12px;align-items:flex-start}
    .icon{width:44px;height:44px;border-radius:12px;background:#f1f5f9;display:grid;place-items:center;font-weight:800}
    .title{font-weight:800}
    .pill{margin-left:auto;padding:6px 10px;border-radius:999px;background:#f1f5f9;color:#0f172a;font-size:12px}
    .bar{display:flex;gap:8px;align-items:center;margin:6px 0 2px}
    input[type="search"]{padding:10px 12px;border-radius:12px;border:1px solid var(--border);min-width:260px;background:#fff}
    .warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:12px;padding:12px}
    .section{margin-top:12px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="logo">PSC</div>
    <div style="font-weight:900">PSC Guru
      <div class="sub" style="font-weight:600">Kerala PSC Exam Prep</div>
    </div>
    <div class="spacer"></div>
    <a href="quiz.html"><button class="btn">Quiz</button></a>
    <a href="resources.html?type=study"><button class="btn">Study</button></a>
    <a href="resources.html?type=notices"><button class="btn">Notices</button></a>
  </div>
</header>

<main>
  <!-- Quick Quiz block -->
  <section class="section">
    <h2>Quick Quiz</h2>
    <div class="sub">Start instantly: random questions or play ‚ÄúAI vs You‚Äù.</div>
    <div class="cards">
      <a class="card" href="quiz.html?mode=random">
        <div class="icon">üé≤</div>
        <div class="title">Random Quiz</div>
        <div class="pill">Mixed</div>
      </a>
      <a class="card" href="quiz.html?mode=ai">
        <div class="icon">ü§ñ</div>
        <div class="title">AI vs You</div>
        <div class="pill">Timed</div>
      </a>
    </div>
  </section>

  <!-- Categories (auto from Google Sheet tabs) -->
  <section class="section">
    <h2>Quiz Categories</h2>
    <div class="bar">
      <input id="q" type="search" placeholder="Search category‚Ä¶" />
      <div class="pill" id="count">0</div>
    </div>
    <div id="warn" class="warn" style="display:none"></div>
    <div class="cards" id="cats"></div>
  </section>
</main>

<script>
/* ================= CONFIG ================= */
const GS_SHEET_ID = "16iIOLKAkFzXD1ja7v6b7_ZUKVjbcsswX8LfJ_D0S57o";

/* ignore these tabs when listing categories */
const EXCLUDE_TABS = new Set([
  "Study Material","Exam Notifications","Resources","README","Config","Sample","Sheet1","Sheet2"
]);

/* Optional: hard fallback list if auto-discovery is unavailable (keep empty if you publish the sheet) */
const FALLBACK_TABS = []; // e.g. ["‡¥≤‡¥ï‡µç‡¥∑‡¥¶‡µç‡¥µ‡µÄ‡¥™‡µç", "Lakes in Kerala", "GST Malayalam"]

/* ================= HELPERS ================= */
const byId = id => document.getElementById(id);
function slugify(s){return (s||"").toString().trim().toLowerCase()
  .replace(/[^\p{L}\p{N}]+/gu,"-").replace(/^-+|-+$/g,"");}

/* Google ‚Äúworksheets feed‚Äù (v3) ‚Äì requires File ‚Üí Publish to web */
async function fetchTabsFromWorksheetsFeed(sheetId){
  const url = `https://spreadsheets.google.com/feeds/worksheets/${encodeURIComponent(sheetId)}/public/values?alt=json`;
  const res = await fetch(url, {mode:"cors"});
  if(!res.ok) throw new Error("Worksheets feed not reachable. Publish the sheet to the web.");
  const data = await res.json();
  const entries = data?.feed?.entry || [];
  return entries.map(e=>{
    const name = e?.title?.$t || "";
    // Try to pull gid from link href (?gid=###)
    const href = (e?.link||[])[0]?.href || "";
    const m = href.match(/[?&]gid=(\d+)/);
    const gid = m ? m[1] : null;
    return { name, gid };
  }).filter(x => x.name && !EXCLUDE_TABS.has(x.name));
}

/* Fallback when not published: try the ‚ÄúCategories‚Äù tab via gviz CSV */
async function fetchTabsFromCategoriesSheet(sheetId){
  // If you add a tab called "Categories" with a column "name"
  const url = `https://docs.google.com/spreadsheets/d/${encodeURIComponent(sheetId)}/gviz/tq?tqx=out:csv&sheet=Categories`;
  const res = await fetch(url);
  if(!res.ok) throw new Error("No 'Categories' tab.");
  const csv = await res.text();
  // tiny CSV parser for first column
  const rows = csv.trim().split(/\r?\n/).map(r=>r.split(","));
  const head = rows.shift().map(h=>h.trim().toLowerCase());
  const idx = head.indexOf("name");
  if(idx < 0) throw new Error("Categories sheet missing 'name' column.");
  const list = rows.map(r => (r[idx]||"").trim()).filter(Boolean);
  return list.map(name => ({ name, gid: null })).filter(x=>!EXCLUDE_TABS.has(x.name));
}

/* Render cards */
function renderCategories(items){
  const q = byId("q").value.trim().toLowerCase();
  const filtered = items.filter(x => x.name.toLowerCase().includes(q));
  byId("cats").innerHTML = filtered.map(x => `
    <a class="card" href="quiz.html?mode=category&sheet=${encodeURIComponent(x.name)}">
      <div class="icon">üìö</div>
      <div class="title">${x.name}</div>
      <div class="pill">${slugify(x.name)}</div>
    </a>
  `).join("");
  byId("count").textContent = filtered.length.toString();
}

/* Boot */
(async function init(){
  let tabs = [];
  try{
    tabs = await fetchTabsFromWorksheetsFeed(GS_SHEET_ID);
  }catch(e1){
    try{
      if(FALLBACK_TABS.length){
        tabs = FALLBACK_TABS.map(n=>({name:n,gid:null})).filter(x=>!EXCLUDE_TABS.has(x.name));
      }else{
        tabs = await fetchTabsFromCategoriesSheet(GS_SHEET_ID);
      }
      byId("warn").style.display = "block";
      byId("warn").innerHTML = "‚ÑπÔ∏è Couldn‚Äôt auto-discover tabs. " +
        "Please <b>File ‚Üí Share ‚Üí Publish to web</b> for this spreadsheet to enable automatic category listing. " +
        "Using fallback instead.";
    }catch(e2){
      byId("warn").style.display = "block";
      byId("warn").innerHTML = "‚ö†Ô∏è Unable to load category list. " +
        "Please either <b>Publish the sheet to the web</b> (entire document), or create a tab named <b>Categories</b> with a <code>name</code> column.";
    }
  }
  window.__CAT_TABS__ = tabs;
  renderCategories(tabs);
  byId("q").addEventListener("input", ()=>renderCategories(tabs));
})();
</script>
</body>
</html>
