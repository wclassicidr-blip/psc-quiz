<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PSC Guru ‚Äì Quiz</title>
  <style>
    :root{
      --bg:#eef7ee; --card:#ffffff; --muted:#6b7280; --ink:#0f172a;
      --brand:#3aa35e; --accent:#1e40af; --danger:#dc2626; --shadow:0 10px 30px rgba(0,0,0,.08);
      --r:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{
      position:sticky;top:0;z-index:10;
      background:linear-gradient(135deg,#dff3df,#eaf7ea);
      border-bottom:1px solid #e6f3e7;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 16px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:800}
    .brand .logo{width:36px;height:36px;border-radius:10px;background:#2f8f50;color:#fff;display:grid;place-items:center;font-weight:900;box-shadow:var(--shadow)}
    .brand small{display:block;font-weight:600;color:#4d7c57;margin-top:2px}
    .top-actions{margin-left:auto;display:flex;gap:8px}
    .btn{padding:8px 12px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .btn:hover{background:#f8fafc}

    main{padding:8px 0 32px}
    h2.section{max-width:1100px;margin:16px auto 8px;padding:0 16px;font-size:18px;letter-spacing:.3px}
    .grid{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;padding:0 16px}

    .tile{
      border:0;background:var(--card);border-radius:18px;padding:18px 16px;text-align:left;cursor:pointer;
      box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;gap:12px;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .tile:hover{transform:translateY(-2px);box-shadow:0 12px 34px rgba(0,0,0,.12)}
    .tile .label{font-weight:800}
    .tile .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .tile .ic{opacity:.25;font-size:24px}

    .tile.quick{background:linear-gradient(135deg,#ffd5d5,#ffe9e9)}
    .tile.quick.blue{background:linear-gradient(135deg,#c7ddff,#e2ecff)}
    .tile.quick .label{font-size:18px}

    /* Quiz view */
    #view{max-width:860px;margin:24px auto;padding:0 16px;display:none}
    #card{
      background:#fff;border-radius:20px;box-shadow:var(--shadow);padding:22px;
    }
    #qtext{font-size:18px;font-weight:700;margin:0 0 8px}
    #answer{margin-top:8px;color:#0b5;border-left:3px solid #0b5;padding-left:10px;display:none}
    .opts{display:grid;gap:10px;margin-top:12px}
    .opt{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;background:#fafafa;cursor:pointer}
    .opt:hover{background:#f3f4f6}
    .opt.correct{background:#dcfce7;border-color:#16a34a}
    .opt.wrong{background:#fee2e2;border-color:#ef4444}
    .bar{display:flex;gap:8px;justify-content:space-between;margin-top:16px;align-items:center}
    .pill{padding:6px 10px;border-radius:999px;background:#f1f5f9;color:#0f172a;font-size:13px}
    .controls{display:flex;gap:8px}
    .primary{background:#0ea5e9;border:0;color:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}
    .ghost{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;cursor:pointer}
    .muted{color:#6b7280;font-size:13px}

    footer{max-width:1100px;margin:32px auto 0;padding:8px 16px;color:#7a8d7f;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center">
      <div class="brand">
        <div class="logo">PSC</div>
        <div>PSC Guru <small>Kerala PSC Exam Prep</small></div>
      </div>
      <div class="top-actions">
        <button class="btn" onclick="location.reload()">Home</button>
      </div>
    </div>
  </header>

  <main>
    <h2 class="section">Quick Quiz</h2>
    <div class="grid" id="quick">
      <button class="tile quick" id="qq-random">
        <div>
          <div class="label">Random Quiz</div>
          <div class="sub">10 questions across all categories</div>
        </div>
        <div class="ic">üé≤</div>
      </button>
      <button class="tile quick blue" id="qq-ai">
        <div>
          <div class="label">AI vs You</div>
          <div class="sub">Computer guesses vs your answers</div>
        </div>
        <div class="ic">ü§ñ</div>
      </button>
    </div>

    <h2 class="section">Quiz Categories</h2>
    <div class="grid" id="tiles"></div>

    <div id="view">
      <div id="card">
        <div class="muted" id="meta"></div>
        <h3 id="qtext">‚Ä¶</h3>
        <div class="opts" id="opts"></div>
        <button class="ghost" id="revealBtn" onclick="reveal()">Show Answer</button>
        <div id="answer"></div>
        <div class="bar">
          <div class="pill" id="progress">0/0</div>
          <div class="controls">
            <button class="ghost" onclick="prev()">‚óÄ Prev</button>
            <button class="primary" onclick="next()">Next ‚ñ∂</button>
          </div>
        </div>
      </div>
      <div class="bar" style="margin-top:10px">
        <div class="muted" id="score"></div>
        <button class="ghost" onclick="exitView()">Back</button>
      </div>
    </div>
  </main>

  <footer>
    <div>¬© <span id="year"></span> PSC Guru ‚Ä¢ Tea Green UI</div>
  </footer>

  <!-- CONFIG: your Google Sheet (sheetId + exact tab names) -->
  <script>
  window.GS_CONFIG = {
    enabled: true,
    sheetId: "16iIOLKAkFzXD1ja7v6b7_ZUKVjbcsswX8LfJ_D0S57o", // your sheet ID
    categories: [
      { key: "gst_malayalam",       sheet: "GST Malayalam",       title: "GST Malayalam",       mode: "answers", color: "#fde68a" },
      { key: "lakes_in_kerala",     sheet: "Lakes in Kerala",     title: "Lakes in Kerala",     mode: "answers", color: "#bfdbfe" },
      { key: "indian_independence", sheet: "Indian Independence", title: "‡¥á‡¥®‡µç‡¥§‡µç‡¥Ø‡¥®‡µç‚Äç ‡¥∏‡µç‡¥µ‡¥æ‡¥§‡¥®‡µç‡¥§‡µç‡¥∞‡µç‡¥Ø ‡¥∏‡¥Æ‡¥∞‡¥Ç", mode: "answers", color: "#fecaca" }
    ]
  };
  </script>

  <!-- LOADER + APP -->
  <script>
  // ---------- helpers
  function csvToRows(csv){
    var rows=[],row=[],s='',q=false;
    for (var i=0;i<csv.length;i++){
      var ch=csv[i], nx=csv[i+1];
      if(q){
        if(ch=='"'){ if(nx=='"'){ s+='"'; i++; } else { q=false; } }
        else { s+=ch; }
      }else{
        if(ch=='"') q=true;
        else if(ch==','){ row.push(s); s=''; }
        else if(ch=='
'){ row.push(s); rows.push(row); row=[]; s=''; }
        else if(ch!=''''){ s+=ch; }
      }
    }
    if(s.length||row.length){ row.push(s); rows.push(row); }
    return rows;
  }
  function rowsToObjects(rows){
    if(!rows||!rows.length) return [];
    var head=rows[0].map(function(h){ return (h||'').toString().trim().toLowerCase(); });
    var out=[];
    for(var r=1;r<rows.length;r++){
      var o={}, rr=rows[r];
      for(var c=0;c<head.length;c++){ o[head[c]]=(rr[c]||'').toString().trim(); }
      if(Object.values(o).join('').length) out.push(o);
    }
    return out;
  }
  function normalize(o){
    var id=parseInt(o.id,10);
    var item={ id:isNaN(id)?undefined:id, q:o.question||o.q||'', a:o.answer||o.a||'' };
    if(o.opta) item.optA=o.opta; if(o.optb) item.optB=o.optb; if(o.optc) item.optC=o.optc; if(o.optd) item.optD=o.optd;
    if(o.correct) item.correct=o.correct;
    return item;
  }
  function shuffle(a){ for(var i=a.length-1;i>0;i--){ var j=(Math.random()*(i+1))|0; var t=a[i]; a[i]=a[j]; a[j]=t; } return a; }
  function fetchCSV(sheetId, sheet){
    var url='https://docs.google.com/spreadsheets/d/'+encodeURIComponent(sheetId)+'/gviz/tq?tqx=out:csv&sheet='+encodeURIComponent(sheet);
    return fetch(url, {mode:'cors'}).then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); });
  }

  // ---------- app state
  let bank = {};     // cat -> items[]
  let MODE = {};     // cat -> 'answers'|'mcq' (answers default)
  let LABELS = {};   // cat -> {title, sub}
  let order = [];    // current run questions (shuffled)
  let idx = 0;       // current index
  let cat = null;
  let scoreUser = 0, scoreAI = 0, aiMode = false;

  // ---------- UI glue
  const tiles = document.getElementById('tiles');
  const view = document.getElementById('view');
  const qtext = document.getElementById('qtext');
  const opts = document.getElementById('opts');
  const answer = document.getElementById('answer');
  const progress = document.getElementById('progress');
  const score = document.getElementById('score');
  const meta = document.getElementById('meta');
  const revealBtn = document.getElementById('revealBtn');

  function cardTile({key,title,color}){
    const b=document.createElement('button');
    b.className='tile';
    b.style.background = '#fff';
    b.innerHTML = '<div><div class="label">'+title+'</div><div class="sub">From Google Sheets</div></div><div class="ic">üìò</div>';
    b.onclick = () => start(key);
    tiles.appendChild(b);
  }

  function buildAllTiles(){
    tiles.innerHTML='';
    (GS_CONFIG.categories||[]).forEach(c=>{
      if (bank[c.key] && bank[c.key].length){
        cardTile({key:c.key, title:c.title, color:c.color});
      }
    });
  }

  function start(key, options){
    cat = key; aiMode = !!(options&&options.ai);
    order = shuffle((bank[key]||[]).slice()); // shuffle every time you start the category
    idx = 0; scoreAI = 0; scoreUser = 0;
    document.querySelector('main').scrollIntoView({behavior:'smooth'});
    document.getElementById('revealBtn').style.display = (order[0] && (order[0].optA||order[0].optB||order[0].optC||order[0].optD)) ? 'none':'inline-block';
    render();
    view.style.display='block';
  }

  function exitView(){ view.style.display='none'; }

  function render(){
    if (!order.length){ qtext.textContent='No questions'; return; }
    const it = order[idx];
    const title = (LABELS[cat]&&LABELS[cat].title)||cat;
    meta.textContent = title + (aiMode?' ‚Ä¢ AI vs You':'');
    qtext.textContent = (idx+1) + '. ' + it.q;
    progress.textContent = (idx+1)+' / '+order.length;
    score.textContent = aiMode ? ('You '+scoreUser+' : '+scoreAI+' AI') : '';
    answer.style.display='none'; answer.textContent = it.a ? 'Answer: '+it.a : '';

    // options
    opts.innerHTML='';
    const hasMCQ = !!(it.optA || it.optB || it.optC || it.optD);
    revealBtn.style.display = hasMCQ ? 'none':'inline-block';
    if (hasMCQ){
      ['A','B','C','D'].forEach(k=>{
        const val = it['opt'+k];
        if(!val) return;
        const d=document.createElement('button');
        d.className='opt';
        d.textContent=val;
        d.onclick = ()=> choose(val, it);
        opts.appendChild(d);
      });
      if (aiMode){
        // AI guesses randomly among visible options
        const kids = Array.from(opts.children); 
        const pick = kids[(Math.random()*kids.length)|0];
        pick.setAttribute('data-ai','1'); // mark
      }
    }
  }

  function choose(val, it){
    const correctText = (it.correct && it.correct.trim()) || (it.a||'').trim();
    const optsEls = Array.from(opts.children);
    optsEls.forEach(el=>{
      const t = el.textContent.trim();
      if (t === correctText){ el.classList.add('correct'); }
      else if (t === val){ el.classList.add('wrong'); }
      el.disabled = true;
    });
    // score
    if (val.trim() === correctText) scoreUser++;
    if (aiMode){
      const aiChosen = opts.querySelector('[data-ai="1"]');
      if (aiChosen && aiChosen.textContent.trim() === correctText) scoreAI++;
    }
    score.textContent = aiMode ? ('You '+scoreUser+' : '+scoreAI+' AI') : '';
  }

  function reveal(){ answer.style.display='block'; }

  function next(){ if (idx < order.length-1){ idx++; render(); } }
  function prev(){ if (idx > 0){ idx--; render(); } }

  // Quick Quiz buttons
  document.getElementById('qq-random').onclick = function(){
    // merge everything and play 10 random
    const all = Object.values(bank).flat();
    const pick = shuffle(all.slice()).slice(0, Math.min(10, all.length));
    if (!pick.length) return alert('No data loaded yet. Check your Google Sheet or refresh.');
    bank.__random = pick;
    LABELS.__random = { title: 'Random Quiz' };
    start('__random');
  };
  document.getElementById('qq-ai').onclick = function(){
    // pick MCQ-only
    const all = Object.values(bank).flat().filter(x=>x.optA||x.optB||x.optC||x.optD);
    const pick = shuffle(all.slice()).slice(0, Math.min(10, all.length));
    if (!pick.length) return alert('Need MCQ rows (optA..optD + correct)');
    bank.__ai = pick;
    LABELS.__ai = { title: 'AI vs You' };
    start('__ai', {ai:true});
  };

  // ---------- load data from Google Sheets
  function applyCategory(c, items){
    const data = items.map(normalize).filter(x=>x.q && (x.a || x.correct || x.optA));
    bank[c.key] = data;
    MODE[c.key] = c.mode || 'answers';
    LABELS[c.key] = { title: c.title, sub: 'From Google Sheets' };
  }
  function loadAll(){
    const cfg = window.GS_CONFIG;
    if (!cfg || !cfg.enabled) return;
    const tasks = (cfg.categories||[]).map(c =>
      fetchCSV(cfg.sheetId, c.sheet)
        .then(csv => rowsToObjects(csvToRows(csv)))
        .then(rows => applyCategory(c, rows))
        .catch(err => console.warn('Load failed for', c.sheet, err))
    );
    Promise.all(tasks).then(buildAllTiles).then(()=>console.log('Loaded from Google Sheets'));
  }

  // init
  document.getElementById('year').textContent = new Date().getFullYear();
  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', loadAll); }
  else { loadAll(); }

  // expose for console testing
  window.start = start; window.next = next; window.prev = prev; window.reveal = reveal; window.exitView = exitView;
  </script>
</body>
</html>
