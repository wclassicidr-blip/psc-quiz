<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI vs You • PSC Guru</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#eef7ef;
      --card:#ffffff;
      --text:#0d3b2e;
      --muted:#527567;
      --brand:#2f8f5b;
      --brand-weak:#e7f5ee;
      --red:#e35d6a;
      --red-weak:#fdecef;
      --blue:#2f6df8;
      --blue-weak:#e9efff;
      --ring:0 0 0 3px rgba(47,143,91,.15);
      --shadow:0 6px 20px rgba(0,0,0,.06);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .wrap{
      max-width:980px;
      margin:32px auto;
      padding:0 16px;
    }
    header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:18px;
    }
    header .chip{
      background:#fff;
      border-radius:999px;
      padding:8px 14px;
      box-shadow:var(--shadow);
      text-decoration:none;
      color:var(--text);
      font-weight:600;
      font-size:13px;
    }
    h1{font-size:28px;margin:0 0 2px}
    .muted{color:var(--muted);font-size:14px}

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }

    .toolbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;margin:14px 0 18px;
    }
    .score{
      display:flex;gap:10px;align-items:center;font-weight:700
    }
    .sc-pill{padding:6px 10px;border-radius:10px;background:var(--brand-weak);color:var(--brand)}
    .ai-pill{background:var(--blue-weak);color:var(--blue)}
    .timer{font-weight:700;color:var(--muted)}

    .q-meta{color:var(--muted);font-weight:600;font-size:13px;margin-bottom:8px}
    .question{font-weight:700;font-size:18px;margin-bottom:12px}

    .opt{
      border:1px solid #e7ece9;
      padding:14px 16px;
      border-radius:12px;
      background:#fff;
      cursor:pointer;
      margin-bottom:10px;
      transition:transform .05s ease, border-color .2s ease, background .2s ease;
    }
    .opt:hover{transform:translateY(-1px)}
    .opt.correct{background:var(--brand-weak);border-color:var(--brand);position:relative}
    .opt.correct::after{
      content:"Correct";
      position:absolute;right:12px;top:10px;color:var(--brand);font-weight:700;font-size:12px;
    }
    .opt.wrong{background:var(--red-weak);border-color:var(--red);position:relative}
    .opt.wrong::after{
      content:"Your pick";
      position:absolute;right:12px;top:10px;color:var(--red);font-weight:700;font-size:12px;
    }
    .opt.ai-guess{outline:2px dashed var(--blue);outline-offset:2px;position:relative}
    .opt.ai-guess::before{
      content:"AI";
      position:absolute;left:-8px;top:-8px;background:var(--blue);color:#fff;font-size:10px;padding:2px 6px;border-radius:999px;
    }
    .opt.disabled{pointer-events:none;opacity:.85}

    .actions{
      display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap
    }
    .btn{
      background:var(--brand);
      color:#fff;
      border:none;
      padding:12px 18px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
    }
    .btn.secondary{background:#fff;color:var(--text);border:1px solid #e7ece9}
    .btn:focus-visible{box-shadow:var(--ring)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .hint{margin-top:8px;color:var(--muted);font-size:13px}

    .summary{margin-top:18px}
    details{border:1px solid #e7ece9;border-radius:12px;margin-bottom:10px;background:#fff}
    summary{cursor:pointer;padding:12px 14px;font-weight:600}
    .row{padding:12px 14px;border-top:1px solid #f0f3f1}

    @media (max-width:640px){
      h1{font-size:22px}
      .wrap{margin:18px auto}
      .opt{font-size:15px}
      .actions{justify-content:space-between}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a class="chip" href="index.html">Home</a>
      <a class="chip" href="quiz.html">Quiz</a>
      <span class="muted">AI vs You</span>
    </header>

    <h1 id="title">AI vs You</h1>
    <div class="muted" id="subtitle">Computer guesses vs your answers. Select a category on the home page or pass <code>?sheet=Tab Name</code>.</div>

    <div class="toolbar">
      <div class="score">
        <span class="sc-pill">You: <span id="scYou">0</span></span>
        <span class="sc-pill ai-pill">AI: <span id="scAI">0</span></span>
      </div>
      <div class="timer" id="timer" hidden>00:00</div>
    </div>

    <div class="card" id="quizBox" hidden>
      <div class="q-meta" id="qMeta"></div>
      <div class="question" id="qText"></div>
      <div id="opts"></div>
      <div class="actions">
        <button class="btn secondary" id="btnPrev">← Prev</button>
        <button class="btn secondary" id="btnShow">Show Answer</button>
        <button class="btn" id="btnNext">Next →</button>
      </div>
      <div class="hint" id="hint"></div>
    </div>

    <div class="card summary" id="sumBox" hidden></div>
  </div>

<script>
/* ================= CONFIG ================= */
const GS_SHEET_ID = "16iIOLKAkFzXD1ja7v6b7_ZUKVjbcsswX8LfJ_D0S57o"; // <- your sheet id

/* Tabs to ignore if you later add auto-listing */
const EXCLUDE = new Set(["Categories","Study Material","Exam Notifications","README","Config","Sample","Sheet1","Sheet2"]);

/* =============== UTILITIES =============== */
const qs = (s, el=document) => el.querySelector(s);
const qsa = (s, el=document) => [...el.querySelectorAll(s)];
const shuffle = arr => arr.sort(() => Math.random() - 0.5);
const fmtTime = s => {
  s = Math.max(0, s|0);
  const m = String(Math.floor(s/60)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  return `${m}:${ss}`;
};
function getParam(name, dflt=null){
  const url = new URL(location.href);
  return url.searchParams.get(name) ?? dflt;
}

/* ======== Fetch CSV (published + gviz fallback) ======== */
async function fetchCSV(sheetName){
  const pub = `https://docs.google.com/spreadsheets/d/${GS_SHEET_ID}/pub?output=csv&sheet=${encodeURIComponent(sheetName)}`;
  try{
    const r = await fetch(pub, {cache:"no-store"});
    if(r.ok) return await r.text();
  }catch(e){}
  // fallback
  const gviz = `https://docs.google.com/spreadsheets/d/${GS_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
  const r2 = await fetch(gviz, {cache:"no-store"});
  if(!r2.ok) throw new Error("GViz/CSV fetch failed");
  return await r2.text();
}
function parseCSV(txt){
  // very small CSV parser (assumes no newlines inside cells)
  const rows = txt.split(/\r?\n/).filter(Boolean).map(r => {
    const out=[]; let cur=""; let q=false;
    for(let i=0;i<r.length;i++){
      const c=r[i];
      if(c==='\"'){
        if(q && r[i+1]==='\"'){cur+='\"'; i++}
        else q=!q;
      }else if(c===',' && !q){out.push(cur.trim());cur=""}
      else cur+=c;
    }
    out.push(cur.trim());
    return out;
  });
  if(!rows.length) return {head:[],data:[]};
  const head = rows[0].map(h=>h.toLowerCase());
  const data = rows.slice(1).map(r=>{
    const o={};
    head.forEach((h,i)=>o[h]=r[i] ?? "");
    return o;
  });
  return {head,data};
}

/* =============== QUIZ STATE =============== */
let QUESTIONS=[], CUR=0, YOU=0, AI=0, TIMER=null, TIMELEFT=0;
let LAST = {user:null, ai:null, correct:null};

function mapQuestion(row){
  // Accept both MCQ and QA; prefer MCQ for AI mode
  const q = row["question"] || row["q"] || row["prompt"] || "";
  const a = row["answer"] || row["ans"] || "";
  const A = row["opta"] || row["a"] || "";
  const B = row["optb"] || row["b"] || "";
  const C = row["optc"] || row["c"] || "";
  const D = row["optd"] || row["d"] || "";

  const opts = [A,B,C,D].filter(Boolean);
  const hasMCQ = opts.length >= 2;

  let correct = row["correct"] || row["key"] || "";
  // Normalize 'correct' to exact option text if needed
  if(hasMCQ){
    const letter = String(correct).trim().toUpperCase();
    if(["A","B","C","D"].includes(letter)){
      const map = {A:0,B:1,C:2,D:3};
      correct = opts[map[letter]];
    }
    if(!correct) correct = a; // fallback to 'answer' text
  }else{
    // no MCQ -> still allow (computer random pick among 2 generic options)
    if(!correct) correct = a || "—";
    if(opts.length<2) opts.push(correct, "—");
  }
  // reject if no question text
  if(!q) return null;

  return { q, opts, correct };
}

function pickAIOption(opts){
  // Simple guess: random (can be made smarter later)
  const idx = Math.floor(Math.random()*opts.length);
  return opts[idx];
}

function draw(){
  qs("#scYou").textContent = YOU;
  qs("#scAI").textContent = AI;
  const total = QUESTIONS.length;
  if(CUR>=total){ return finish(); }

  const { q, opts, correct } = QUESTIONS[CUR];
  qs("#qMeta").textContent = `Question ${CUR+1} / ${total}`;
  qs("#qText").textContent = q;

  const box = qs("#opts"); box.innerHTML="";
  // shuffle options but keep correct mapping
  const shuffled = shuffle(opts.slice());
  const nodes = shuffled.map(opt=>{
    const el = document.createElement("div");
    el.className = "opt";
    el.textContent = opt;
    el.onclick = () => handlePick(opt, correct, nodes);
    box.appendChild(el);
    return el;
  });

  // reset last picks info
  LAST = {user:null, ai:null, correct};

  qs("#hint").textContent = "Pick one — AI will also guess. Then see who got it right.";
  qs("#quizBox").hidden = false;
  updateNavButtons();
}

function applyReveal(nodes){
  const {user, ai, correct} = LAST;
  nodes.forEach(el=>{
    const val = el.textContent;
    if(val === correct) el.classList.add("correct");
    if(val === user && val !== correct) el.classList.add("wrong");
    if(val === ai) el.classList.add("ai-guess");
    el.classList.add("disabled");
  });
}

function handlePick(userPick, correct, nodes){
  if(LAST.user) return; // already answered

  const aiPick = pickAIOption(nodes.map(n=>n.textContent));
  LAST.user = userPick;
  LAST.ai = aiPick;
  LAST.correct = correct;

  if(userPick === correct) YOU++;
  if(aiPick === correct) AI++;

  applyReveal(nodes);
  qs("#scYou").textContent = YOU;
  qs("#scAI").textContent = AI;

  const msgParts = [];
  msgParts.push(userPick===correct ? "✔ You are correct." : "✖ Your answer is wrong.");
  msgParts.push(aiPick===correct ? "🤖 AI is correct." : "🤖 AI is wrong.");
  qs("#hint").textContent = msgParts.join(" ");
  updateNavButtons();
}

function updateNavButtons(){
  qs("#btnPrev").disabled = CUR<=0;
  qs("#btnShow").disabled = !!LAST.user; // after pick not needed
  qs("#btnNext").disabled = CUR >= QUESTIONS.length-1 ? false : !LAST.user;
}

function showAnswerOnly(){
  if(LAST.user) return;
  // reveal without affecting scores
  const nodes = qsa(".opt", qs("#opts"));
  // Simulate AI guess too (but do not count)
  LAST.ai = pickAIOption(nodes.map(n=>n.textContent));
  applyReveal(nodes);
  qs("#hint").textContent = "Answer revealed. No points were given.";
  updateNavButtons();
}

function nextQ(){ if(CUR < QUESTIONS.length-1){ CUR++; draw(); } else finish(); }
function prevQ(){ if(CUR > 0){ CUR--; draw(); } }

function finish(){
  clearInterval(TIMER);
  qs("#quizBox").hidden = true;
  const total = QUESTIONS.length;
  const html = `
    <h2 style="margin:0 0 4px">Summary</h2>
    <div class="muted" style="margin-bottom:12px">
      Final Score — <b>You:</b> ${YOU} &nbsp;|&nbsp; <b>AI:</b> ${AI} &nbsp;|&nbsp; <b>Total:</b> ${total}
    </div>

    <details open>
      <summary>Review answers</summary>
      ${QUESTIONS.map((qq,i)=>`
        <div class="row"><b>${i+1}.</b> ${qq.q}</div>
        <div class="row" style="background:var(--brand-weak);border-top:0">
          Correct: <b>${qq.correct}</b>
        </div>
      `).join("")}
    </details>

    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <a class="btn secondary" href="index.html">← Home</a>
      <button class="btn" onclick="location.reload()">Play Again</button>
    </div>
  `;
  const sum = qs("#sumBox");
  sum.innerHTML = html;
  sum.hidden = false;
}

/* =============== TIMER =============== */
function startTimer(seconds){
  if(!seconds) return;
  TIMELEFT = seconds|0;
  qs("#timer").hidden = false;
  qs("#timer").textContent = fmtTime(TIMELEFT);
  TIMER = setInterval(()=>{
    TIMELEFT--;
    qs("#timer").textContent = fmtTime(TIMELEFT);
    if(TIMELEFT<=0){
      clearInterval(TIMER);
      finish();
    }
  },1000);
}

/* =============== BOOT =============== */
async function boot(){
  // wire buttons
  qs("#btnPrev").onclick = prevQ;
  qs("#btnNext").onclick = nextQ;
  qs("#btnShow").onclick = showAnswerOnly;

  const tab = getParam("sheet");
  const n = parseInt(getParam("n") || 0, 10) || null;
  const timerSec = parseInt(getParam("timer") || 0, 10) || null;

  if(!tab){
    qs("#title").textContent = "AI vs You";
    qs("#subtitle").innerHTML = "Tip: open any category card on Home and append <code>&amp;timer=300</code> to set a 5-min session. Or launch like <code>ai.html?sheet=GST%20Malayalam&amp;n=10</code>.";
    qs("#quizBox").hidden = true;
    return;
  }

  qs("#title").textContent = tab;
  qs("#subtitle").textContent = "Timed MCQ — computer guesses vs your answers";

  try{
    const csv = await fetchCSV(tab);
    const { data } = parseCSV(csv);
    const mapped = data.map(mapQuestion).filter(Boolean);
    if(!mapped.length) throw new Error("No MCQ-style questions in this tab");

    QUESTIONS = shuffle(mapped);
    if(n && n>0) QUESTIONS = QUESTIONS.slice(0, n);

    startTimer(timerSec);
    draw();
  }catch(err){
    console.error(err);
    qs("#subtitle").textContent = "Failed to load questions. Make sure the sheet is Published to the web and the tab name is correct.";
  }
}
boot();
</script>
</body>
</html>
